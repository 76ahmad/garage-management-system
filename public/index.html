<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="1.0.0">
    <title>DRVN - ××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DRVN">
    <link rel="manifest" href="manifest.json?v=1.0.0">
    <link rel="apple-touch-icon" href="icon-192.png?v=1.0.0">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png?v=1.0.0">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png?v=1.0.0">

    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.init({
                appId: "e158d77c-3eb7-4959-b6dc-de8a0b581880",
                safari_web_id: "web.onesignal.auto.DRVN",
                notifyButton: {
                    enable: false,
                },
                allowLocalhostAsSecureOrigin: true,
            });
            console.log('âœ… OneSignal initialized!');
        });
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase v9 Compatible Mode -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        button, a, [onclick] {
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        /* Prevent double-tap zoom on buttons */
        button {
            touch-action: manipulation;
        }
        
        :root {
            --primary: #f59e0b;
            --primary-dark: #d97706;
            --primary-light: #fbbf24;
            --secondary: #0f172a;
            --secondary-light: #1e293b;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 6px 12px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 25px -5px rgb(0 0 0 / 0.15);
            --shadow-xl: 0 20px 40px -10px rgb(0 0 0 / 0.2);
            
            /* Light Mode Colors */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border-color: #e2e8f0;
            --card-bg: #ffffff;
        }
        
        /* Dark Mode */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #334155;
            --card-bg: #1e293b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3);
            --shadow-md: 0 6px 12px -2px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 25px -5px rgb(0 0 0 / 0.5);
            --shadow-xl: 0 20px 40px -10px rgb(0 0 0 / 0.6);
        }
        
        /* Dark Mode - Text Colors Override */
        [data-theme="dark"] .text-gray-900,
        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3 {
            color: #f8fafc !important;
        }
        
        [data-theme="dark"] .text-gray-700,
        [data-theme="dark"] .text-gray-800,
        [data-theme="dark"] label {
            color: #e2e8f0 !important;
        }
        
        [data-theme="dark"] .text-gray-600 {
            color: #cbd5e1 !important;
        }
        
        [data-theme="dark"] .text-gray-500 {
            color: #94a3b8 !important;
        }
        
        [data-theme="dark"] .text-gray-400 {
            color: #64748b !important;
        }
        
        /* Dark Mode - Background Colors */
        [data-theme="dark"] .bg-white {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .bg-gray-50,
        [data-theme="dark"] .bg-gray-100 {
            background-color: #334155 !important;
        }
        
        /* Dark Mode - Borders */
        [data-theme="dark"] .border-gray-200,
        [data-theme="dark"] .border-gray-300 {
            border-color: #475569 !important;
        }
        
        /* Dark Mode - Inputs */
        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background-color: #334155 !important;
            color: #f8fafc !important;
            border-color: #475569 !important;
        }
        
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] select::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: #94a3b8 !important;
        }
        
        /* Dark Mode - Modal */
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] #carModal > div,
        [data-theme="dark"] #carSelectorModal > div {
            background-color: #1e293b !important;
        }
        
        /* Dark Mode - Cards remain visible */
        [data-theme="dark"] .card {
            background-color: #1e293b !important;
            border-color: #475569 !important;
        }
        
        /* Dark Mode - Amber colors remain visible */
        [data-theme="dark"] .text-amber-600,
        [data-theme="dark"] .text-amber-700,
        [data-theme="dark"] .text-amber-800 {
            /* Keep amber colors as they are visible in dark mode */
        }
        
        /* Dark Mode - Select elements */
        [data-theme="dark"] select option {
            background-color: #1e293b !important;
            color: #f8fafc !important;
        }
        
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-tertiary) 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* Dark Mode Toggle Button */
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 32px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 4px;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .theme-toggle-slider {
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            will-change: transform;
            position: absolute;
            left: 4px;
        }
        
        [data-theme="dark"] .theme-toggle-slider {
            transform: translateX(28px);
            left: 4px;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            /* Hide desktop header buttons on mobile */
            .header-buttons {
                display: none !important;
            }
            
            /* Mobile Header Compact */
            .app-header .container {
                padding: 0.75rem 1rem;
            }
            
            .app-header h1 {
                font-size: 1.25rem;
            }
            
            .app-header p {
                font-size: 0.75rem;
            }
            
            /* Mobile Bottom Navigation */
            .mobile-bottom-nav {
                display: flex !important;
            }
            
            /* FAB Button */
            .fab-button {
                display: flex !important;
            }
            
            /* Add padding for bottom nav */
            #mainApp {
                padding-bottom: 80px;
            }
            
            .logo-badge {
                width: 48px;
                height: 48px;
            }
            
            .logo-badge span {
                font-size: 1.5rem;
            }
            
            .user-badge {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            
            .theme-toggle {
                width: 56px;
                height: 30px;
            }
            
            .theme-toggle-slider {
                width: 22px;
                height: 22px;
                font-size: 11px;
                left: 3px;
            }
            
            [data-theme="dark"] .theme-toggle-slider {
                transform: translateX(26px);
                left: 3px;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .section-title {
                font-size: 1.25rem;
            }
            
            .card {
                border-radius: 12px;
            }
            
            .card .info-item {
                font-size: 0.8rem;
            }
        }
        
        /* Mobile Bottom Navigation Bar */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
            backdrop-filter: blur(10px);
            border-top: 2px solid #e5e7eb;
            padding: 0.5rem 0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            transform: translateY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø¹Ù†Ø¯ ÙØªØ­ modal */
        .mobile-bottom-nav.hide-on-modal {
            transform: translateY(100%);
        }
        
        [data-theme="dark"] .mobile-bottom-nav {
            background: linear-gradient(to top, rgba(30,41,59,0.98), rgba(30,41,59,0.95));
            border-top-color: #475569;
        }
        
        .mobile-bottom-nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 12px;
            min-width: 60px;
        }
        
        .nav-item:active {
            transform: scale(0.95);
            background: rgba(245,158,11,0.1);
        }
        
        .nav-item-icon {
            font-size: 1.5rem;
            transition: transform 0.2s;
        }
        
        .nav-item.active .nav-item-icon {
            transform: scale(1.2);
        }
        
        .nav-item-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #64748b;
            transition: color 0.2s;
        }
        
        [data-theme="dark"] .nav-item-label {
            color: #94a3b8;
        }
        
        .nav-item.active .nav-item-label {
            color: #f59e0b;
        }
        
        /* Floating Action Button */
        .fab-button {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            border-radius: 50%;
            box-shadow: 0 8px 24px rgba(245,158,11,0.4);
            cursor: pointer;
            z-index: 999;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Ø¥Ø®ÙØ§Ø¡ FAB Ø¹Ù†Ø¯ ÙØªØ­ modal */
        .fab-button.hide-on-modal {
            opacity: 0;
            pointer-events: none;
            transform: translateY(100px);
        }
        
        .fab-button:active {
            transform: scale(0.9) translateY(0);
        }
        
        .fab-button:hover {
            box-shadow: 0 12px 32px rgba(245,158,11,0.5);
            transform: scale(1.05);
        }
        
        /* Mobile Quick Actions */
        .mobile-quick-actions {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .quick-action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .quick-action-btn:active {
            transform: scale(0.95);
        }
        
        @media (min-width: 769px) {
            .mobile-quick-actions {
                display: none;
            }
        }
        
        @media (max-width: 640px) {
            .app-header {
                padding: 0.75rem 0;
            }
            
            .header-actions {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .user-badge span:not(.text-lg) {
                display: none;
            }
            
            .btn-danger {
                padding: 0.5rem 0.75rem;
            }
            
            .btn-danger span {
                display: none;
            }
            
            .btn-danger::after {
                content: 'â¬…';
            }
            
            .header-buttons {
                width: 100%;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .header-buttons .btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
                white-space: nowrap;
            }
        }
        
        /* ===== Calendar Simple Styles ===== */
        #calendarGrid {
            gap: 8px;
        }
        
        #calendarGrid > div {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            position: relative;
            padding: 8px;
        }
        
        #calendarGrid > div:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        /* Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± - ÙˆØ§Ø¶Ø­ Ø¬Ø¯Ø§Ù‹ */
        #calendarGrid > div.selected {
            background: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
            border-width: 3px !important;
        }
        
        #calendarGrid > div.selected * {
            color: white !important;
        }
        
        /* Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ - Ø­Ø¯ÙˆØ¯ Ù…Ù…ÙŠØ²Ø© */
        #calendarGrid > div.today {
            border-color: #10b981 !important;
            border-width: 3px !important;
            font-weight: bold;
        }
        
        /* Ù„Ùˆ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± Ù‡Ùˆ Ù†ÙØ³Ù‡ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ */
        #calendarGrid > div.selected.today {
            background: var(--primary) !important;
            border-color: #10b981 !important;
        }
        
        /* Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡Ø§ Ù…ÙˆØ§Ø¹ÙŠØ¯ */
        #calendarGrid > div.has-appointments::after {
            content: '';
            position: absolute;
            bottom: 6px;
            width: 6px;
            height: 6px;
            background: #ef4444;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
        }
        
        #calendarGrid > div.selected.has-appointments::after {
            background: white;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.5);
        }
        
        #calendarGrid > div span:first-child {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        #calendarGrid > div span:last-child {
            font-size: 1rem;
            font-weight: bold;
        }
        
        @media (max-width: 480px) {
            .logo-badge {
                width: 40px;
                height: 40px;
            }
            
            .logo-badge span {
                font-size: 1.25rem;
            }
            
            .app-header h1 {
                font-size: 1rem;
            }
            
            .app-header p {
                display: none;
            }
            
            .theme-toggle {
                width: 52px;
                height: 28px;
            }
            
            .theme-toggle-slider {
                width: 20px;
                height: 20px;
                font-size: 10px;
                left: 3px;
            }
            
            [data-theme="dark"] .theme-toggle-slider {
                transform: translateX(24px);
                left: 3px;
            }
            
            .user-badge {
                padding: 0.375rem 0.5rem;
            }
            
            .header-buttons {
                grid-template-columns: 1fr;
            }
            
            /* Modal improvements for mobile */
            .modal-content {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
                overflow-y: auto;
            }
            
            /* Form inputs on mobile */
            input, select, textarea {
                font-size: 16px !important; /* Prevent zoom on iOS */
            }
            
            /* Button grid on mobile */
            .grid.grid-cols-3 {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            /* Card padding on mobile */
            .card > div {
                padding: 1rem;
            }
            
            /* Search bar on mobile */
            #searchInput {
                font-size: 16px;
            }
            
            /* Image upload on mobile */
            label[for="carImage"] {
                padding: 3rem 1.5rem !important;
                width: 100% !important;
                max-width: 100% !important;
                touch-action: manipulation;
                min-height: 220px !important;
                border-width: 5px !important;
            }
            
            label[for="carImage"] svg {
                width: 4rem !important;
                height: 4rem !important;
            }
            
            label[for="carImage"] div {
                font-size: 1.3rem !important;
            }
            
            #imagePreview img {
                width: 100% !important;
                height: auto !important;
                max-width: 300px;
            }
        }
        
        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .app-header {
                position: relative;
            }
            
            .modal-content {
                max-height: calc(100vh - 1rem);
                overflow-y: auto;
            }
        }
        
        /* Touch improvements */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px; /* Apple's recommended touch target */
                min-width: 44px;
            }
            
            .theme-toggle {
                min-height: 44px;
                width: 70px;
            }
            
            .card:active {
                transform: scale(0.98);
            }
            
            .btn:active {
                transform: scale(0.95);
            }
            
            /* Better touch target for file input */
            label[for="carImage"] {
                min-height: 200px !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
            }
        }
        
        /* Loading Animation */
        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            text-decoration: none;
            outline: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-secondary:hover {
            border-color: var(--primary);
            background: var(--bg-tertiary);
            transform: translateY(-2px);
        }
        
        .btn-dark {
            background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-900) 100%);
            color: var(--white);
        }
        
        .btn-dark:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.35);
        }
        
        /* ========== SIDEBAR MENU ========== */
        .sidebar {
            position: fixed;
            right: -320px;
            top: 0;
            width: 320px;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            box-shadow: -5px 0 25px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
            body.sidebar-open {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
}
        }
        
        .sidebar.open {
            right: 0;
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(245, 158, 11, 0.1);
            border-bottom: 2px solid #f59e0b;
        }
        
        .sidebar-content {
            padding: 0;
        }
        
        .sidebar-user-info {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: white;
        }
        
        .sidebar-subscription {
            text-align: center;
            padding: 15px;
            background: rgba(34, 197, 94, 0.1);
            border-bottom: 1px solid rgba(34, 197, 94, 0.2);
            margin: 10px;
            border-radius: 10px;
        }
        
        .sidebar-nav {
            padding: 10px 0;
        }
        
        .sidebar-menu-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: 500;
            text-align: right;
            cursor: pointer;
            transition: all 0.2s;
            border-right: 4px solid transparent;
        }
        
        .sidebar-menu-item:hover {
            background: rgba(245, 158, 11, 0.15);
            border-right-color: #f59e0b;
            padding-right: 25px;
        }
        
        .sidebar-icon {
            font-size: 24px;
            width: 30px;
            text-align: center;
        }
        
        .sidebar-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 10px 20px;
        }
        
        .sidebar-logout {
            color: #ef4444;
            margin-top: 10px;
        }
        
        .sidebar-logout:hover {
            background: rgba(239, 68, 68, 0.15);
            border-right-color: #ef4444;
        }
        
        .hamburger-menu {
            font-size: 24px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Dark mode adjustments */
        [data-theme="dark"] .sidebar {
            background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
        }
        
        /* Header */
        .app-header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 40;
        }
        
        .header-accent {
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 50%, var(--primary) 100%);
        }
        
        /* Logo Badge */
        .logo-badge {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        /* User Badge */
        .user-badge {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.625rem 1.25rem;
            border-radius: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        
        /* Input Styles */
        input, select, textarea {
            transition: all 0.2s ease;
            background: var(--card-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1) !important;
        }
        
        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
        }
        
        .badge-primary {
            background: rgba(245, 158, 11, 0.1);
            color: var(--primary-dark);
        }
        
        .badge-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        
        /* Status Badges */
        .status-waiting {
            background: rgba(234, 179, 8, 0.1);
            color: #eab308;
            border: 1px solid rgba(234, 179, 8, 0.2);
        }
        
        .status-progress {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .status-ready {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .status-completed {
            background: rgba(100, 116, 139, 0.1);
            color: #94a3b8;
            border: 1px solid rgba(100, 116, 139, 0.2);
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            backdrop-filter: blur(8px);
            background: rgba(15, 23, 42, 0.5);
            animation: fadeIn 0.2s ease;
        }
        
        [data-theme="dark"] .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
        }
        
        /* Info Item */
        .info-item {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            padding: 0.5rem 0;
        }
        
        .info-item strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        /* Car Image */
        .car-image {
            aspect-ratio: 16/9;
            object-fit: cover;
            width: 100%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .car-image-placeholder {
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .car-image-placeholder:hover {
            background: var(--bg-primary);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Loading Screen */
        .loading-screen {
            background: var(--bg-secondary);
            animation: fadeIn 0.3s ease;
        }
        
        /* Section Title */
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .section-title::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, var(--primary) 0%, transparent 100%);
        }
        
        /* Stats Card */
        .stat-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }
        
        /* Accent Line */
        .accent-line {
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 2px;
        }
        
        /* Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        [data-theme="dark"] .glass {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Notification */
        .notification {
            animation: slideUp 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        /* Card Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            animation: fadeIn 0.5s ease;
        }
        
        /* Divider */
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--border-color) 50%, transparent 100%);
        }
        
        /* Mobile Scroll Fix */
        @media (max-width: 768px) {
            #backupModal {
                align-items: flex-start !important;
                padding: 0 !important;
            }
            
            #backupModal > div {
                margin: 0 !important;
                max-height: 100vh !important;
                border-radius: 0 !important;
            }
            
            /* Smooth scrolling */
            #backupModal,
            #backupModal > div {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }
            
            /* Prevent body scroll when modal open */
            body.modal-open {
                overflow: hidden;
                position: fixed;
                width: 100%;
            }
            
            /* Hide floating add button when modal is open */
            body.modal-open .floating-add-btn {
                display: none !important;
            }
        }
    </style>

</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen fixed inset-0 z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="mb-6">
                <div style="font-size: 52px; font-weight: 900; color: #f59e0b; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); letter-spacing: 3px; font-family: Arial, sans-serif;">
                    ğŸ DRVN
                </div>
            </div>
            <div class="loader mx-auto mb-6"></div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</h2>
            <p class="text-gray-600 font-medium">×˜×•×¢×Ÿ ××ª ×”××¢×¨×›×ª...</p>
            <div class="mt-6 w-48 h-1 bg-gray-200 rounded-full mx-auto overflow-hidden">
                <div class="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full animate-pulse" style="width: 60%"></div>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden fixed inset-0 z-40 flex items-center justify-center p-4" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
        <div class="card max-w-md w-full p-10 shadow-xl">
            <div class="text-center mb-8">
                <div class="mb-6">
                    <div style="font-size: 48px; font-weight: 900; color: #f59e0b; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); letter-spacing: 3px; font-family: Arial, sans-serif;">
                        ğŸ DRVN
                    </div>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</h1>
                <p class="text-gray-600">× ×™×”×•×œ ××§×¦×•×¢×™ ×•×™×¢×™×œ ×œ×¨×›×‘×™×</p>
                <div class="accent-line w-24 mx-auto mt-4"></div>
            </div>
            
            <div id="errorMsg" class="hidden bg-red-50 border-r-4 border-red-500 text-red-700 px-4 py-3 rounded-xl mb-4 text-sm font-medium"></div>
            <div id="successMsg" class="hidden bg-green-50 border-r-4 border-green-500 text-green-700 px-4 py-3 rounded-xl mb-4 text-sm font-medium"></div>
            
            <form id="loginForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">××™××™×™×œ</label>
                    <input type="email" id="email" required 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-amber-500 transition-all"
                           placeholder="your@email.com">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">×¡×™×¡××”</label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-amber-500 transition-all"
                           placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                
                <button type="submit" id="authBtn" class="btn btn-primary w-full py-4 text-base font-bold shadow-lg">
                    ğŸš€ ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª
                </button>
            </form>
            
            <div class="divider my-6"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- Header -->
        <!-- Sidebar Menu -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2 class="text-2xl font-bold text-white">×ª×¤×¨×™×˜</h2>
            <button onclick="toggleSidebar()" class="text-white text-3xl hover:text-amber-300 transition">Ã—</button>
        </div>
        
        <div class="sidebar-content">
            <!-- User Info -->
            <div class="sidebar-user-info">
                <div class="text-4xl mb-2">ğŸ‘¤</div>
                <div id="sidebarUserName" class="font-bold text-lg">××©×ª××©</div>
                <button onclick="editUserName()" class="text-sm text-amber-300 hover:text-amber-200 mt-1">
                    âœï¸ ×¢×¨×•×š ×©×
                </button>
            </div>
            
            <!-- Subscription Info -->
            <div id="sidebarDaysCounter" class="sidebar-subscription hidden">
                <div class="text-green-400 font-bold text-lg">
                    <span id="sidebarDaysLeft">0</span> ×™××™× × ×•×ª×¨×•
                </div>
                <div class="text-sm text-gray-300">×‘×—×™× ×</div>
            </div>
            
            <!-- Menu Items -->
            <nav class="sidebar-nav">
                <button onclick="toggleSidebar(); setTimeout(() => openCarModal(), 100);" class="sidebar-menu-item">
                    <span class="sidebar-icon">â•</span>
                    <span>×”×•×¡×£ ×¨×›×‘ ×—×“×©</span>
                </button>
                
                <button onclick="toggleSidebar(); setTimeout(() => openDashboard(), 100);" class="sidebar-menu-item">
                    <span class="sidebar-icon">ğŸ“Š</span>
                    <span>×œ×•×— ×‘×§×¨×”</span>
                </button>
                
                <button onclick="toggleSidebar(); setTimeout(() => openCalendarModal(), 100);" class="sidebar-menu-item">
                    <span class="sidebar-icon">ğŸ“…</span>
                    <span>×™×•××Ÿ ×¤×’×™×©×•×ª</span>
                </button>
                
                <button onclick="toggleSidebar(); setTimeout(() => openSettings(), 100);" class="sidebar-menu-item">
                    <span class="sidebar-icon">âš™ï¸</span>
                    <span>××¡×¤×¨ ×—×œ×§×™ ×—×™×œ×•×£</span>
                </button>
                
                <button id="notificationToggleBtn" onclick="toggleNotifications()" class="sidebar-menu-item">
                    <span class="sidebar-icon">ğŸ””</span>
                    <span id="notificationBtnText">×”×¤×¢×œ ×”×ª×¨××•×ª</span>
                </button>
                
                <button onclick="toggleSidebar(); setTimeout(() => openBackupModal(), 100);" class="sidebar-menu-item">
                    <span class="sidebar-icon">ğŸ’¾</span>
                    <span>×’×™×‘×•×™</span>
                </button>
                
                <button onclick="toggleSidebar(); setTimeout(() => exportCSV(), 100);" class="sidebar-menu-item">
                    <span class="sidebar-icon">ğŸ“Š</span>
                    <span>×™×™×¦× × ×ª×•× ×™×</span>
                </button>
                
                <div class="sidebar-divider"></div>
                
                <button onclick="toggleSidebar(); setTimeout(() => showAccountModal(), 100);" class="sidebar-menu-item">
                    <span class="sidebar-icon">ğŸ’³</span>
                    <span>×”×—×©×‘×•×Ÿ ×©×œ×™</span>
                </button>
                
                <button onclick="toggleTheme();" class="sidebar-menu-item">
                    <span class="sidebar-icon" id="sidebarThemeIcon">â˜€ï¸</span>
                    <span id="sidebarThemeText">××¦×‘ ×œ×™×œ×”</span>
                </button>
                
                <button onclick="toggleSidebar(); setTimeout(() => signOut(), 100);" class="sidebar-menu-item sidebar-logout">
                    <span class="sidebar-icon">â¬…ï¸</span>
                    <span>×™×¦×™××”</span>
                </button>
            </nav>
        </div>
    </div>
    
    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <header class="app-header">
            <div class="header-accent"></div>
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <!-- Hamburger Menu Button (Left) -->
                    <button onclick="toggleSidebar()" class="hamburger-menu bg-amber-500 hover:bg-amber-600 text-white p-3 rounded-lg font-bold transition">
                        â˜°
                    </button>
                    
                    <!-- Logo & Title (Center) -->
                    <div class="flex items-center gap-3">
                        <div>
                            <div style="font-size: 28px; font-weight: 900; color: #f59e0b; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); letter-spacing: 2px; font-family: Arial, sans-serif;">
                                ğŸ DRVN
                            </div>
                        </div>
                        <div class="hidden md:block">
                            <h1 class="text-2xl font-bold text-gray-900">××¢×¨×›×ª × ×™×”×•×œ ××•×¡×š</h1>
                            <p class="text-sm text-gray-600 font-medium">× ×™×”×•×œ ××§×¦×•×¢×™ ×•×™×¢×™×œ</p>
                        </div>
                    </div>
                    
                    <!-- User Info (Right) -->
                    <div class="user-badge">
                        <span class="text-lg">ğŸ‘¤</span>
                        <span id="userName" class="font-semibold">××©×ª××©</span>
                    </div>
                </div>
                
                <!-- Search Box -->
                <div class="relative mt-4">
                    <input type="text" id="searchBox" placeholder="ğŸ” ×—×¤×© ×œ×¤×™ ××¡×¤×¨ ×¨×™×©×•×™, ×©× ×”×‘×¢×œ×™×, ×¡×•×’ ×¨×›×‘..." onkeyup="searchCars()" oninput="searchCars()"
                           class="w-full px-4 py-3 pr-12 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-amber-500 text-base" 
                           style="font-size: 16px;">
                    <button onclick="document.getElementById('searchBox').value=''; searchCars();" 
                            class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        âœ•
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Container -->
        <div class="container mx-auto px-4 py-6">
            <!-- Cars Grid -->
            <div id="carsGrid" class="cards-grid"></div>
        
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12 hidden">
                <p class="text-gray-500 text-xl">××™×Ÿ ×¨×›×‘×™× ×‘××¢×¨×›×ª</p>
                <button onclick="openCarModal()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                    ×”×•×¡×£ ×¨×›×‘ ×¨××©×•×Ÿ
                </button>
            </div>
        </div>
        
        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-bottom-nav">
            <div class="mobile-bottom-nav-container">
                <div class="nav-item active" id="navHome" onclick="scrollToTop()">
                    <div class="nav-item-icon">ğŸ </div>
                    <div class="nav-item-label">×‘×™×ª</div>
                </div>
                <div class="nav-item" id="navDashboard" onclick="openDashboard()">
                    <div class="nav-item-icon">ğŸ“Š</div>
                    <div class="nav-item-label">×œ×•×— ×‘×§×¨×”</div>
                </div>
                <div class="nav-item" id="navCalendar" onclick="openCalendarModal()">
                    <div class="nav-item-icon">ğŸ“…</div>
                    <div class="nav-item-label">×™×•××Ÿ</div>
                </div>
                <div class="nav-item" id="navBackup" onclick="openBackupModal()">
                    <div class="nav-item-icon">ğŸ’¾</div>
                    <div class="nav-item-label">×’×™×‘×•×™</div>
                </div>
                <div class="nav-item" id="navAccount" onclick="showAccountModal()">
                    <div class="nav-item-icon">ğŸ‘¤</div>
                    <div class="nav-item-label">×—×©×‘×•×Ÿ</div>
                </div>
            </div>
        </nav>

        <!-- Floating Action Button -->
        <button class="fab-button" onclick="openCarModal()" title="×”×•×¡×£ ×¨×›×‘">
            â•
        </button>
    </div>

    <!-- Car Modal -->
    <div id="carModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full my-8 relative">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold">×”×•×¡×¤×ª ×¨×›×‘ ×—×“×©</h2>
                <button onclick="closeCarModal()" class="text-gray-400 hover:text-gray-600 transition-colors" title="×¡×’×•×¨">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="carForm">
                <!-- ×ª××•× ×ª ×”×¨×›×‘ -->
                <div class="mb-6">
                    <label class="block text-gray-800 font-bold mb-4 text-center text-xl">ğŸ“¸ ×ª××•× ×ª ×”×¨×›×‘</label>
                    <div class="flex justify-center mb-2">
                        <label for="carImage" class="cursor-pointer bg-gradient-to-br from-amber-100 to-amber-50 border-4 border-dashed border-amber-500 rounded-2xl p-10 hover:from-amber-200 hover:to-amber-100 transition-all hover:border-amber-600 w-full text-center shadow-2xl active:scale-95" style="min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <svg class="w-20 h-20 text-amber-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <div class="text-amber-800 font-black mb-3" style="font-size: 22px;">ğŸ‘† ×œ×—×¥ ×›××Ÿ ×œ×”×¢×œ××ª ×ª××•× ×”</div>
                            <div class="text-amber-700 font-semibold" style="font-size: 16px;">ğŸ“· ××”××¦×œ××” ××• ××”×’×œ×¨×™×”</div>
                            <div class="text-gray-600 text-sm mt-2">JPG, PNG ×¢×“ 10MB</div>
                            <input type="file" id="carImage" accept="image/*" class="hidden">
                        </label>
                    </div>
                    <div id="imagePreview" class="mt-4 flex justify-center"></div>
                </div>


                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- ××¡×¤×¨ ×¨×™×©×•×™ -->
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-bold mb-2">××¡×¤×¨ ×¨×™×©×•×™ *</label>
                        <div class="flex gap-2">
                            <input type="text" id="plateNumber" required 
                                   class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                                   placeholder="12345678" maxlength="8"
                                   >
                            <button type="button" onclick="searchCarByPlateNumber()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-bold flex items-center gap-2 whitespace-nowrap">
                                ğŸ” ×—×¤×©
                            </button>
                        </div>
                        <p class="text-xs text-blue-600 mt-2 font-semibold">
                            ğŸ’¡ ×”×–×Ÿ ××¡×¤×¨ ×¨×™×©×•×™ 7-8 ×¡×¤×¨×•×ª (×œ×œ× ××§×¤×™×) - ×•×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "×—×¤×©"
                        </p>
                        <div id="apiStatus" class="mt-2"></div>
                    </div>
                    
                    <!-- ×©× ×”×‘×¢×œ×™× -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">×©× ×”×‘×¢×œ×™× *</label>
                        <input type="text" id="ownerName" required
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="×©× ××œ×">
                    </div>
                    
                    <!-- ×¡×•×’ ×¨×›×‘ -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">×¡×•×’ ×¨×›×‘</label>
                        <input type="text" id="carType" list="carTypes"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="×˜×•×™×•×˜×”, ××¨×¦×“×¡, ××–×“×”">
                        <datalist id="carTypes">
                            <option value="×˜×•×™×•×˜×”">
                            <option value="×”×•× ×“×”">
                            <option value="×™×•× ×“××™">
                            <option value="×§×™×”">
                            <option value="××–×“×”">
                            <option value="××¨×¦×“×¡">
                            <option value="BMW">
                        </datalist>
                    </div>
                    
                    <!-- ××¡×¤×¨ ×˜×œ×¤×•×Ÿ -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">××¡×¤×¨ ×˜×œ×¤×•×Ÿ</label>
                        <input type="text" id="phone" 
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="050-1234567">
                    </div>
                    
                    <!-- ×“×’× -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">×“×’×</label>
                        <input type="text" id="model"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="×§×•×¨×•×œ×”, ××œ× ×˜×¨×”, ×•×›×•'">
                    </div>
                    
                    <!-- ×©× ×ª ×™×™×¦×•×¨ -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">×©× ×ª ×™×™×¦×•×¨</label>
                        <input type="number" id="year" min="1900" max="2030"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="2020">
                    </div>
                    
                    <!-- ×§×•×“ ×”×ª× ×¢×” -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">×§×•×“ ×”×ª× ×¢×” (××™××•×‘×™×œ×™×–×¨)</label>
                        <input type="text" id="immobilizerCode"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder="×§×•×“ ×¡×•×“×™ ×œ×”×ª× ×¢×ª ×”×¨×›×‘">
                    </div>
                    
                    <!-- ×¡×•×’ ×× ×•×¢ -->
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">×¡×•×’ ×× ×•×¢</label>
                        <select id="engineType" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="">×‘×—×¨...</option>
                            <option value="×‘× ×–×™×Ÿ">×‘× ×–×™×Ÿ</option>
                            <option value="×“×™×–×œ">×“×™×–×œ</option>
                            <option value="×”×™×‘×¨×™×“×™">×”×™×‘×¨×™×“×™</option>
                            <option value="×—×©××œ×™">×—×©××œ×™</option>
                        </select>
                    </div>
                    
                    <!-- ×”×¡×¤×§ ×× ×•×¢ -->
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-bold mb-2">×”×¡×¤×§ ×× ×•×¢</label>
                        <input type="text" id="enginePower"
                               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                               placeholder='150 ×›"×¡ / 2000 ×¡×"×§'>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg hover:from-blue-700 hover:to-blue-800 font-bold shadow-lg transition-all">
                        ğŸ’¾ ×©××•×¨
                    </button>
                    <button type="button" onclick="closeCarModal()" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-bold transition-all">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div id="maintenanceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg p-8 max-w-xl w-full my-8 relative">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">×”×•×¡×¤×ª ×˜×™×¤×•×œ</h2>
                <button onclick="closeMaintenanceModal()" class="text-gray-400 hover:text-gray-600 transition-colors" title="×¡×’×•×¨">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="maintenanceForm" class="space-y-4">
                <!-- ×ª××¨×™×š -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">×ª××¨×™×š *</label>
                    <input type="date" id="maintenanceDate" 
                           class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-blue-500 text-right"
                           value="">
                </div>
                
                <!-- ×§×™×œ×•××˜×¨××–' -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">×§×™×œ×•××˜×¨××–' *</label>
                    <input type="number" id="kilometers" 
                           class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-blue-500 text-right"
                           placeholder="××¡×¤×¨ ×”×§×™×œ×•××˜×¨×™×">
                </div>
                
                <!-- ×©× ×”×—×œ×§ -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">×©× ×”×—×œ×§ *</label>
                    <input type="text" id="partName" 
                           class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-blue-500 text-right"
                           placeholder="">
                </div>
                
                <!-- ×ª×™××•×¨ ×”×¢×‘×•×“×” -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">×ª×™××•×¨ ×”×¢×‘×•×“×”</label>
                    <textarea id="workDescription" rows="4" 
                              class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-blue-500 text-right resize-none"
                              placeholder=""></textarea>
                </div>
                
                <!-- ×¢×œ×•×ª (â‚ª) -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">×¢×œ×•×ª (â‚ª) *</label>
                    <input type="number" id="totalCost" step="0.01"
                           class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-blue-500 text-right"
                           placeholder="">
                </div>
                
                <!-- ×ª××•× ×•×ª ×”×ª×§×œ×” -->
                <div>
                    <label class="block text-gray-700 font-bold mb-2 text-right">×ª××•× ×•×ª ×”×ª×§×œ×”</label>
                    <div class="flex items-center justify-end">
                        <label class="cursor-pointer bg-white border border-gray-300 rounded-lg px-4 py-2 hover:bg-gray-50 flex items-center gap-2">
                            <span class="text-gray-600">×”×¢×œ×” ×ª××•× ×•×ª</span>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <input type="file" id="maintenanceImages" accept="image/*" multiple class="hidden">
                        </label>
                    </div>
                    <div id="maintenanceImagesPreview" class="mt-3 grid grid-cols-3 gap-2"></div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-lg hover:from-green-700 hover:to-green-800 font-bold shadow-lg transition-all">
                        ğŸ’¾ ×”×•×¡×£ ×˜×™×¤×•×œ
                    </button>
                    <button type="button" onclick="closeMaintenanceModal()" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-bold transition-all">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Car Details Modal -->
    <div id="carDetailsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold" id="detailsPlateNumber"></h2>
                <button onclick="closeCarDetailsModal()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="p-6">
                <div id="carDetailsContent"></div>
                
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h3 class="text-xl font-bold">×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™×</h3>
                        <div class="flex gap-2">
                            <button onclick="openAppointmentModal()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 flex items-center gap-1 text-sm font-bold shadow-lg">
                                ğŸ“… ×§×‘×¢ ×¤×’×™×©×”
                            </button>
                            <button onclick="openMaintenanceModal()" class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-4 py-2 rounded-lg hover:from-emerald-600 hover:to-emerald-700 font-bold shadow-lg">
                                + ×”×•×¡×£ ×˜×™×¤×•×œ
                            </button>
                        </div>
                    </div>
                    
                    <div id="maintenanceHistory" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div id="dashboardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold">ğŸ“Š ×œ×•×— ×‘×§×¨×” - × ×™×”×•×œ ×¨×›×‘×™×</h2>
                    <button onclick="closeDashboard()" class="text-white hover:text-gray-200 text-3xl leading-none">&times;</button>
                </div>
            </div>
            
            <div class="p-6">
                <!-- Statistics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded">
                        <div class="text-3xl font-bold text-yellow-700" id="waitingCount">0</div>
                        <div class="text-sm text-yellow-600">×××ª×™×Ÿ ×œ×˜×™×¤×•×œ</div>
                    </div>
                    <div class="bg-blue-100 border-l-4 border-blue-500 p-4 rounded">
                        <div class="text-3xl font-bold text-blue-700" id="inProgressCount">0</div>
                        <div class="text-sm text-blue-600">×‘×˜×™×¤×•×œ</div>
                    </div>
                    <div class="bg-green-100 border-l-4 border-green-500 p-4 rounded">
                        <div class="text-3xl font-bold text-green-700" id="readyCount">0</div>
                        <div class="text-sm text-green-600">××•×›×Ÿ ×œ××™×¡×•×£</div>
                    </div>
                    <div class="bg-gray-100 border-l-4 border-gray-500 p-4 rounded">
                        <div class="text-3xl font-bold text-gray-700" id="completedCount">0</div>
                        <div class="text-sm text-gray-600">×”×•×©×œ×</div>
                    </div>
                </div>
                
                <!-- Kanban Board -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- ×××ª×™×Ÿ ×œ×˜×™×¤×•×œ -->
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-3 text-yellow-700 flex items-center gap-2">
                            â³ ×××ª×™×Ÿ ×œ×˜×™×¤×•×œ
                        </h3>
                        <div id="waitingColumn" class="space-y-2 min-h-[200px]"></div>
                    </div>
                    
                    <!-- ×‘×˜×™×¤×•×œ -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-3 text-blue-700 flex items-center gap-2">
                            ğŸ”§ ×‘×˜×™×¤×•×œ
                        </h3>
                        <div id="inProgressColumn" class="space-y-2 min-h-[200px]"></div>
                    </div>
                    
                    <!-- ××•×›×Ÿ ×œ××™×¡×•×£ -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-3 text-green-700 flex items-center gap-2">
                            âœ… ××•×›×Ÿ ×œ××™×¡×•×£
                        </h3>
                        <div id="readyColumn" class="space-y-2 min-h-[200px]"></div>
                    </div>
                    
                    <!-- ×”×•×©×œ× -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-bold text-lg mb-3 text-gray-700 flex items-center gap-2">
                            ğŸ ×”×•×©×œ×
                        </h3>
                        <div id="completedColumn" class="space-y-2 min-h-[200px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <!-- Settings Modal - Spare Parts Contacts -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-orange-600 text-white p-6 rounded-t-lg sticky top-0">
                <h2 class="text-2xl font-bold">ğŸ“ ××¡×¤×¨×™ ×—×œ×§×™ ×—×™×œ×•×£</h2>
            </div>
            
            <div class="p-6">
                <p class="text-gray-600 mb-4">×”×•×¡×£ ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ ×©×œ ×¡×¤×§×™ ×—×œ×§×™ ×—×™×œ×•×£. ×ª×•×›×œ ×œ×‘×—×•×¨ ××”× ×‘×¢×ª ×”×–×× ×ª ×—×œ×§×™×.</p>
                
                <!-- List of Spare Parts Contacts -->
                <div id="sparePartsContactsList" class="space-y-3 mb-4">
                    <!-- Contacts will be loaded here -->
                </div>
                
                <!-- Add New Contact Form -->
                <div class="border-t pt-4 mt-4">
                    <h3 class="font-bold text-gray-700 mb-3">â• ×”×•×¡×£ ×¡×¤×§ ×—×“×©</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-1">×©× ×”×¡×¤×§</label>
                            <input type="text" id="newSupplierName" 
                                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-orange-500"
                                   placeholder="×œ×“×•×’××”: ×—×œ×¤×™× ××”×™×¨×™×, ××•×¡×š ×™×•×¡×™">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-1">××¡×¤×¨ ×˜×œ×¤×•×Ÿ</label>
                            <input type="text" id="newSupplierPhone" 
                                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-orange-500"
                                   placeholder="050-1234567">
                        </div>
                        <button onclick="addSparePartsContact()" 
                                class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-bold">
                            â• ×”×•×¡×£ ×¡×¤×§
                        </button>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="closeSettings()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 font-bold">
                        ×¡×’×•×¨
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Backup Modal -->
    <div id="backupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto my-auto">
            <div class="bg-teal-600 text-white p-4 md:p-6 rounded-t-lg sticky top-0 z-10">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl md:text-2xl font-bold">ğŸ’¾ ×’×™×‘×•×™ ×•×©×—×–×•×¨</h2>
                    <button onclick="closeBackupModal()" class="text-white hover:text-gray-200 text-3xl leading-none">&times;</button>
                </div>
            </div>
            
            <div id="backupModalContent" class="p-3 md:p-6 pb-24 md:pb-6">
                <!-- Quick Actions - Prominent Buttons -->
                <div class="mb-4 space-y-3">
                    <button onclick="createAutoBackup(true)" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 active:scale-98 text-white px-6 py-4 rounded-xl font-bold flex items-center justify-center gap-3 shadow-lg transition-all text-lg">
                        <span class="text-2xl">âš¡</span>
                        <span>×’×™×‘×•×™ ××”×™×¨ ×¢×›×©×™×•</span>
                    </button>
                    <button onclick="showBackupList()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 active:scale-98 text-white px-6 py-4 rounded-xl font-bold flex items-center justify-center gap-3 shadow-lg transition-all text-lg">
                        <span class="text-2xl">ğŸ“‹</span>
                        <span>×›×œ ×”×’×™×‘×•×™×™×</span>
                    </button>
                </div>
                
                <!-- Auto Backup Status - Compact -->
                <div class="mb-4 bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4 shadow-sm">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-2xl">ğŸ¤–</span>
                        <div class="flex-1">
                            <div class="font-bold text-green-900">×’×™×‘×•×™ ××•×˜×•××˜×™</div>
                            <div class="text-xs text-green-700">×›×œ ×™×•× ×©×™×©×™, 23:00</div>
                        </div>
                        <div class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold">
                            ×¤×¢×™×œ
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-white/70 p-2 rounded-lg">
                            <div class="text-gray-600">×’×™×‘×•×™ ××—×¨×•×Ÿ</div>
                            <div id="lastAutoBackupTime" class="font-bold text-gray-800">...</div>
                        </div>
                        <div class="bg-white/70 p-2 rounded-lg">
                            <div class="text-gray-600">×”×‘× ×‘×¢×•×“</div>
                            <div id="timeUntilBackup" class="font-bold text-blue-600">...</div>
                        </div>
                    </div>
                </div>
                
                
                <!-- Progress -->
                <div id="backupProgress" class="hidden mb-4">
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3 border border-blue-200">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="animate-spin text-xl">âš™ï¸</div>
                            <span class="font-bold text-gray-800 text-sm">××¢×‘×“...</span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div id="backupProgressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="backupProgressText" class="text-center text-xs text-gray-600 mt-1">××›×™×Ÿ ×’×™×‘×•×™...</p>
                    </div>
                </div>
                
                <!-- Info -->
                <div class="bg-gray-50 rounded-lg p-3 border text-xs">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-gray-600">×’×™×‘×•×™ ×™×“× ×™ ××—×¨×•×Ÿ</span>
                        <span id="lastBackupDate" class="font-bold text-gray-800">-</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">×¡×”×´×› × ×ª×•× ×™×</span>
                        <span id="totalDataCount" class="font-bold text-gray-800">-</span>
                    </div>
                </div>
            </div>
            
            <style>
            /* Smooth details animation */
            details summary::-webkit-details-marker {
                display: none;
            }
            
            details[open] summary span:last-child {
                transform: rotate(180deg);
                display: inline-block;
            }
            
            details summary span:last-child {
                transition: transform 0.2s ease;
            }
            
            /* Active scale */
            .active\:scale-98:active {
                transform: scale(0.98);
            }
            </style>
            
            <script>
            // Simplified update - no heavy calculations
            function updateAutoBackupInfo() {
                try {
                    const lastBackupEl = document.getElementById('lastAutoBackupTime');
                    const timeUntilEl = document.getElementById('timeUntilBackup');
                    
                    if (lastBackupEl) {
                        const lastBackup = localStorage.getItem('lastAutoBackupDate');
                        if (lastBackup) {
                            const days = Math.floor((Date.now() - new Date(lastBackup)) / 86400000);
                            lastBackupEl.textContent = days > 0 ? `×œ×¤× ×™ ${days} ×™××™×` : '×”×™×•×';
                        } else {
                            lastBackupEl.textContent = '×˜×¨× ×‘×•×¦×¢';
                        }
                    }
                    
                    if (timeUntilEl) {
                        const dayOfWeek = new Date().getDay();
                        const daysUntil = (5 - dayOfWeek + 7) % 7 || 7;
                        timeUntilEl.textContent = daysUntil > 1 ? `${daysUntil} ×™××™×` : daysUntil === 1 ? '××—×¨' : '×”×™×•×';
                    }
                } catch (e) {
                    console.error('Update error:', e);
                }
            }
            </script>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendarModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold">ğŸ“… ×™×•××Ÿ ×¤×’×™×©×•×ª</h2>
                <button onclick="closeCalendarModal()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="p-6">
                <!-- Calendar Navigation -->
                <div class="flex justify-between items-center mb-6">
                    <button onclick="previousMonth()" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">
                        â†
                    </button>
                    <h3 class="text-xl font-bold" id="currentMonthYear"></h3>
                    <button onclick="nextMonth()" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">
                        â†’
                    </button>
                </div>
                
                <!-- Calendar Grid -->
                <div class="grid grid-cols-7 gap-2 mb-3 px-2">
                    <div class="text-center font-bold p-2 text-sm">××³</div>
                    <div class="text-center font-bold p-2 text-sm">×‘×³</div>
                    <div class="text-center font-bold p-2 text-sm">×’×³</div>
                    <div class="text-center font-bold p-2 text-sm">×“×³</div>
                    <div class="text-center font-bold p-2 text-sm">×”×³</div>
                    <div class="text-center font-bold p-2 text-sm">×•×³</div>
                    <div class="text-center font-bold p-2 text-sm">×©×³</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
                
                <!-- Appointments List for Selected Day -->
                <div class="mt-6">
                    <h3 class="text-xl font-bold mb-4" id="selectedDayTitle">×¤×’×™×©×•×ª ×”×™×•×</h3>
                    <div id="dayAppointments"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-purple-600 text-white p-6 rounded-t-lg">
                <h2 class="text-2xl font-bold">ğŸ“… ×¤×’×™×©×” ×—×“×©×”</h2>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">
                <!-- Left side - Form -->
                <div>
                    <form id="appointmentForm">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">×¨×›×‘</label>
                            <select id="appointmentCar" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-purple-500">
                                <option value="">×‘×—×¨ ×¨×›×‘...</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">×ª××¨×™×š</label>
                            <input type="date" id="appointmentDate" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-purple-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">×©×¢×” (24 ×©×¢×•×ª)</label>
                            <input type="time" id="appointmentTime" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-purple-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">×¡×•×’ ×”×¤×’×™×©×”</label>
                            <select id="appointmentType" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-purple-500">
                                <option value="">×‘×—×¨ ×¡×•×’...</option>
                                <option value="×©×™×¨×•×ª">×©×™×¨×•×ª / ×˜×™×¤×•×œ</option>
                                <option value="×ª×™×§×•×Ÿ">×ª×™×§×•×Ÿ</option>
                                <option value="×‘×“×™×§×”">×‘×“×™×§×” ×ª×§×•×¤×ª×™×ª</option>
                                <option value="××—×¨">××—×¨</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">×”×¢×¨×•×ª</label>
                            <textarea id="appointmentNotes" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-purple-500" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="appointmentReminder" class="ml-2">
                                <span class="text-gray-700">×©×œ×— ×ª×–×›×•×¨×ª ×•×•×˜×¡××¤ ×œ×œ×§×•×—</span>
                            </label>
                        </div>
                        
                        <div class="flex gap-2">
                            <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">
                                ×©××•×¨ ×¤×’×™×©×”
                            </button>
                            <button type="button" onclick="closeAppointmentModal()" class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500">
                                ×‘×™×˜×•×œ
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Right side - Mini Calendar -->
                <div class="border-r pr-6">
                    <h3 class="text-lg font-bold mb-4 text-center">×¤×’×™×©×•×ª ×§×™×™××•×ª</h3>
                    
                    <!-- Mini Calendar Navigation -->
                    <div class="flex justify-between items-center mb-4">
                        <button type="button" onclick="previousMonthMini()" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">
                            â†
                        </button>
                        <h4 class="font-bold" id="miniMonthYear"></h4>
                        <button type="button" onclick="nextMonthMini()" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">
                            â†’
                        </button>
                    </div>
                    
                    <!-- Mini Calendar Grid -->
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        <div class="text-center text-xs font-bold p-1">××³</div>
                        <div class="text-center text-xs font-bold p-1">×‘×³</div>
                        <div class="text-center text-xs font-bold p-1">×’×³</div>
                        <div class="text-center text-xs font-bold p-1">×“×³</div>
                        <div class="text-center text-xs font-bold p-1">×”×³</div>
                        <div class="text-center text-xs font-bold p-1">×•×³</div>
                        <div class="text-center text-xs font-bold p-1">×©×³</div>
                    </div>
                    <div id="miniCalendarGrid" class="grid grid-cols-7 gap-1 mb-4"></div>
                    
                    <!-- Selected Day Appointments -->
                    <div id="miniDayAppointments" class="text-sm max-h-60 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
      const firebaseConfig = {
            apiKey: "AIzaSyCdSRfJCoU6xwDych3l_3K_hBZBHOi9jVg",
            authDomain: "garage-17263.firebaseapp.com",
            projectId: "garage-17263",
            storageBucket: "garage-17263.firebasestorage.app",
            messagingSenderId: "332265903935",
            appId: "1:332265903935:web:237c0787a161fd36a7a58a",
            measurementId: "G-KLLCPECCDQ"
        };


        // ==========================================
        // CAR LOOKUP API - Israeli Government Data
        // ==========================================
        
        // API Configuration (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© API Key Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
        // API Configuration (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© API Key Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
        const CAR_API_CONFIG = {
            // âœ… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ API Key Ù…Ø¬Ø§Ù†ÙŠ (5 Ø¯Ù‚Ø§Ø¦Ù‚ ÙÙ‚Ø·):
            // 1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰: https://data.gov.il
            // 2. Ø§Ø¶ØºØ· "×”×¨×©××”" (ØªØ³Ø¬ÙŠÙ„) 
            // 3. ÙØ¹Ù‘Ù„ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯
            // 4. Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ API Key Ù…Ø¬Ø§Ù†Ø§Ù‹
            // 5. Ø¶Ø¹Ù‡ Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ø¨ÙŠÙ† Ø¹Ù„Ø§Ù…ØªÙŠ Ø§Ù„ØªÙ†ØµÙŠØµ
            apiKey: '', // â† Ø¶Ø¹ API Key Ù‡Ù†Ø§
            baseUrl: 'https://data.gov.il/api/3/action/datastore_search',
            resourceId: '053cea08-09bc-40ec-8f7a-156f0677aff3',
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¯ÙˆÙ† API Key Ø³ÙŠØ¹Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        };

        // Format plate number as user types (XX-XXX-XX)
        function formatPlateNumber(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length > 2 && value.length <= 5) {
                value = value.slice(0, 2) + '-' + value.slice(2);
            } else if (value.length > 5) {
                value = value.slice(0, 2) + '-' + value.slice(2, 5) + '-' + value.slice(5, 7);
            }
            input.value = value;
        }

        // Lookup car information from Israeli Government API
        async function lookupCarInfoFromAPI() {
            const plateInput = document.getElementById('plateNumber');
            const plateNumber = plateInput.value.replace(/[-\s]/g, '').trim();
            const statusDiv = document.getElementById('apiStatus');
            
            if (!plateNumber) {
                statusDiv.innerHTML = '<p class="text-sm text-red-600 font-semibold">âŒ ×× × ×”×–×Ÿ ××¡×¤×¨ ×¨×™×©×•×™</p>';
                return;
            }
            
            // Check if API key is configured
            if (!CAR_API_CONFIG.apiKey) {
                statusDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-3 text-sm">
                        <p class="text-yellow-800 font-bold mb-2">âš ï¸ API Key ×œ× ×”×•×’×“×¨</p>
                        <p class="text-yellow-700 mb-2">×›×“×™ ×œ×”×©×ª××© ×‘×—×™×¤×•×© ××•×˜×•××˜×™, ×™×© ×œ×§×‘×œ API Key ×:</p>
                        <a href="https://data.gov.il" target="_blank" class="text-blue-600 underline font-semibold hover:text-blue-800">
                            https://data.gov.il
                        </a>
                        <p class="text-yellow-700 mt-2 text-xs">
                            ×”×”×¨×©××” ×—×™× ××™×ª ×œ×—×œ×•×˜×™×Ÿ! ×œ××—×¨ ×§×‘×œ×ª ×”-API Key, ×”×•×¡×£ ××•×ª×• ×‘×§×•×“.
                        </p>
                    </div>
                `;
                return;
            }
            
            // Show loading
            const button = event.target;
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'â³ ××—×¤×©...';
            
            statusDiv.innerHTML = `
                <div class="flex items-center gap-2 text-blue-600 text-sm font-semibold">
                    <div class="animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent"></div>
                    ××—×¤×© ×‘×××’×¨ ×¨×©×•×ª ×”×¨×™×©×•×™...
                </div>
            `;
            
            try {
                // Build API URL with filters
                const url = `${CAR_API_CONFIG.baseUrl}?resource_id=${CAR_API_CONFIG.resourceId}&filters={"mispar_rechev":"${plateNumber}"}`;
                
                // Make API request
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': CAR_API_CONFIG.apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-API');
                }
                
                const data = await response.json();
                
                if (data.success && data.result && data.result.records && data.result.records.length > 0) {
                    const carInfo = data.result.records[0];
                    
                    // Fill form with API data
                    if (carInfo.tozeret_nm) {
                        document.getElementById('carType').value = carInfo.tozeret_nm;
                    }
                    if (carInfo.kinuy_mishari) {
                        document.getElementById('model').value = carInfo.kinuy_mishari;
                    }
                    if (carInfo.shnat_yitzur) {
                        document.getElementById('year').value = carInfo.shnat_yitzur;
                    }
                    if (carInfo.degem_nm) {
                        document.getElementById('engineType').value = carInfo.degem_nm;
                    }
                    
                    // Show success message
                    statusDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-300 rounded-lg p-3 text-sm">
                            <p class="text-green-800 font-bold mb-1">âœ“ × ××¦× ××™×“×¢ ×¢×‘×•×¨ ×”×¨×›×‘!</p>
                            <div class="text-green-700 text-xs space-y-1">
                                <p>ğŸš— <strong>×™×¦×¨×Ÿ:</strong> ${carInfo.tozeret_nm || '×œ× ×–××™×Ÿ'}</p>
                                <p>ğŸ“‹ <strong>×“×’×:</strong> ${carInfo.kinuy_mishari || '×œ× ×–××™×Ÿ'}</p>
                                <p>ğŸ“… <strong>×©× ×”:</strong> ${carInfo.shnat_yitzur || '×œ× ×–××™×Ÿ'}</p>
                                ${carInfo.tzeva_rechev ? `<p>ğŸ¨ <strong>×¦×‘×¢:</strong> ${carInfo.tzeva_rechev}</p>` : ''}
                            </div>
                        </div>
                    `;
                    
                    showNotification('âœ“ ×¤×¨×˜×™ ×”×¨×›×‘ ××•×œ××• ×‘×”×¦×œ×—×”!');
                    
                } else {
                    // No results found
                    statusDiv.innerHTML = `
                        <div class="bg-orange-50 border border-orange-300 rounded-lg p-3 text-sm">
                            <p class="text-orange-800 font-bold">âŒ ×œ× × ××¦× ××™×“×¢ ×¢×‘×•×¨ ××¡×¤×¨ ×¨×™×©×•×™ ×–×”</p>
                            <p class="text-orange-700 text-xs mt-1">×× × ××œ× ××ª ×”×¤×¨×˜×™× ×™×“× ×™×ª</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('API Error:', error);
                statusDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-300 rounded-lg p-3 text-sm">
                        <p class="text-red-800 font-bold">âŒ ×©×’×™××” ×‘×—×™×¤×•×©</p>
                        <p class="text-red-700 text-xs mt-1">${error.message || '×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨'}</p>
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        }

        // ==========================================
        // DARK MODE FUNCTIONALITY
        // ==========================================
        
        // Initialize theme from localStorage
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }
        
        // Toggle theme
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            
            // Show notification
            const message = newTheme === 'dark' ? '×”×•×¤×¢×œ ××¦×‘ ×œ×™×œ×” ğŸŒ™' : '×”×•×¤×¢×œ ××¦×‘ ×™×•× â˜€ï¸';
            showNotification(message);
        }
        
        // Update theme icon
        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
            }
            // Update sidebar theme icon
            updateSidebarTheme();
        }
        
        // Initialize theme on page load
        initTheme();
        
        // ==========================================
        // Initialize Firebase
        let app, db, auth, messaging; // â­ Ø¥Ø¶Ø§ÙØ© messaging Ù‡Ù†Ø§
        let currentUser = null;
        let cars = [];
        let appointments = [];
        let editingCarId = null;
        let currentCarId = null;
        let editingMaintenanceId = null;
        let editingAppointmentId = null;
        let maintenanceImages = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let miniMonth = new Date().getMonth();
        let miniYear = new Date().getFullYear();
        let miniSelectedDate = null;
        
        // Helper function to safely convert timestamp to millis
        function safeToMillis(timestamp) {
            if (!timestamp) return null;
            // If it's a Firestore Timestamp with toMillis method
            if (timestamp && typeof timestamp.toMillis === 'function') {
                return timestamp.toMillis();
            }
            // If it's already a number (milliseconds)
            if (typeof timestamp === 'number') {
                return timestamp;
            }
            // If it's a string date
            if (typeof timestamp === 'string') {
                const date = new Date(timestamp);
                return isNaN(date.getTime()) ? null : date.getTime();
            }
            // If it has seconds property (Firestore Timestamp format)
            if (timestamp && timestamp.seconds) {
                return timestamp.seconds * 1000;
            }
            return null;
        }

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log('Firebase initialized with maintenance system!');
            
            // Initialize Firebase Messaging
            try {
                messaging = firebase.messaging(); // â­ Ø¨Ø¯ÙˆÙ† let
                console.log('Firebase Messaging initialized!');
            } catch (msgError) {
                console.log('Firebase Messaging not supported:', msgError);
                messaging = null;
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('loadingScreen').innerHTML = 
                '<div class="text-center"><p class="text-red-600">×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¢×¨×›×ª</p></div>';
        }

        // ==========================================
        // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© - Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        // ==========================================
        let isAuthChecked = false;
        
        auth.onAuthStateChanged(async (user) => {
            if (isAuthChecked) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù…ØªÙƒØ±Ø±
            isAuthChecked = true;
            
            if (!user) {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ â†’ ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                console.log('No user logged in, redirecting to login.html');
                window.location.href = 'login.html';
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await user.reload();
            
            // Check BOTH Firebase Auth AND Firestore for verification status
            console.log('ğŸ” Checking verification status in index.html...');
            console.log('Firebase Auth emailVerified:', user.emailVerified);
            
            // Check Firestore for manual verification by admin
            const userDocRef = db.collection('users').doc(user.uid);
            const userDocSnap = await userDocRef.get();
            const userData = userDocSnap.data();
            
            console.log('Firestore emailVerified:', userData?.emailVerified);
            console.log('Firestore verifiedManually:', userData?.verifiedManually);
            
            // Allow access if EITHER Firebase Auth verified OR Firestore verified (manual)
            const isVerified = user.emailVerified || userData?.emailVerified === true;
            
            if (!isVerified) {
                console.log('âŒ User not verified in either system');
                // Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± Ù…Ø¤ÙƒØ¯ â†’ ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹\n\n×× × ×××ª ××ª ×”××™××™×™×œ ×ª×—×™×œ×”');
                await auth.signOut();
                window.location.href = 'login.html';
                return;
            }
            
            console.log('âœ… User verified - allowing access to system');
            if (userData?.verifiedManually) {
                console.log('â„¹ï¸ User was verified manually by admin');
            }
            
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ÙˆÙ…Ø¤ÙƒØ¯
            console.log('User authenticated:', user.email);
            currentUser = user;
            
            // ØªÙ‡ÙŠØ¦Ø© OneSignal Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            initOneSignalUser();
            
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†Ø¸Ø§Ù…
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
            }, 500);
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await checkUserSubscription();
        });
        
        // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        async function checkUserSubscription() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (!userDoc.exists) {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯ (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰)
                    const trialEndDate = new Date();
                    trialEndDate.setDate(trialEndDate.getDate() + 30); // 30 ÙŠÙˆÙ… ØªØ¬Ø±ÙŠØ¨ÙŠ
                    
                    await db.collection('users').doc(currentUser.uid).set({
                        userId: currentUser.uid,
                        email: currentUser.email,
                        subscriptionStatus: 'trial',
                        subscriptionEndDate: firebase.firestore.Timestamp.fromDate(trialEndDate),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        emailVerified: true
                    });
                    
                    console.log('Created new user document with trial subscription');
                }
            } catch (error) {
                console.error('Error checking user subscription:', error);
            }
        }

        // Compress Image Function
        async function compressImage(file, maxSizeKB = 700) {
            return new Promise((resolve, reject) => {
                // Simple validation
                if (!file || !file.type || !file.type.startsWith('image/')) {
                    reject(new Error('×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ'));
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onerror = () => {
                    reject(new Error('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥'));
                };
                
                reader.onload = (event) => {
                    const img = new Image();
                    
                    img.onerror = () => {
                        reject(new Error('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”×ª××•× ×”'));
                    };
                    
                    img.onload = () => {
                        try {
                            // Create canvas
                            const canvas = document.createElement('canvas');
                            let width = img.width || 800;
                            let height = img.height || 600;
                            
                            // Resize if too large
                            const maxDimension = 1200;
                            if (width > maxDimension || height > maxDimension) {
                                if (width > height) {
                                    height = Math.round((height * maxDimension) / width);
                                    width = maxDimension;
                                } else {
                                    width = Math.round((width * maxDimension) / height);
                                    height = maxDimension;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            // Get context
                            const ctx = canvas.getContext('2d');
                            if (!ctx) {
                                reject(new Error('×©×’×™××” ×‘×™×¦×™×¨×ª Canvas'));
                                return;
                            }
                            
                            // White background for transparency
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, width, height);
                            
                            // Draw image
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Convert to JPEG with compression
                            let quality = 0.8;
                            let result = canvas.toDataURL('image/jpeg', quality);
                            
                            // Try to reduce size if needed (max 5 attempts)
                            for (let i = 0; i < 5 && result.length > maxSizeKB * 1024 * 1.37; i++) {
                                quality -= 0.1;
                                if (quality < 0.3) break;
                                result = canvas.toDataURL('image/jpeg', quality);
                            }
                            
                            resolve(result);
                        } catch (error) {
                            reject(new Error('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª××•× ×”'));
                        }
                    };
                    
                    // Set image source
                    try {
                        img.src = event.target.result;
                    } catch (error) {
                        reject(new Error('×©×’×™××” ×‘×”×’×“×¨×ª ×”×ª××•× ×”'));
                    }
                };
                
                // Read file
                try {
                    reader.readAsDataURL(file);
                } catch (error) {
                    reject(new Error('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥'));
                }
            });
        }

        // Calculate Total Cost
        function calculateTotalCost() {
            const partsCost = parseFloat(document.getElementById('partsCost').value) || 0;
            const laborCost = parseFloat(document.getElementById('laborCost').value) || 0;
            const otherCost = parseFloat(document.getElementById('otherCost').value) || 0;
            const total = partsCost + laborCost + otherCost;
            document.getElementById('totalCostDisplay').textContent = total.toFixed(2);
            return total;
        }

        // Auth State Observer
        // Subscription variables
        let userSubscription = null;
        let isSubscriptionActive = false;
        const ADMIN_EMAIL = 'h-26-7@hotmail.com';

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Check subscription status
                await checkSubscriptionStatus();
                
                // Setup realtime listener for subscription changes
                setupSubscriptionListener();
                
                await loadUserName();
                loadCars();
                loadAppointments();
                
                // Show subscription banner if expired
                showSubscriptionBanner();
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
            
            document.getElementById('loadingScreen').classList.add('hidden');
        });

        // ==========================================
        // SUBSCRIPTION SYSTEM
        // ==========================================
        
        // Check Subscription Status
        async function checkSubscriptionStatus() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (!userDoc.exists) {
                    // New user - create with trial
                    const trialEnd = new Date();
                    trialEnd.setDate(trialEnd.getDate() + 30); // 30 days trial
                    
                    userSubscription = {
                        trialEndDate: trialEnd.toISOString(),
                        isPaid: false,
                        subscriptionExpiry: null,
                        createdAt: new Date().toISOString()
                    };
                    
                    await db.collection('users').doc(currentUser.uid).set({
                        email: currentUser.email,
                        ...userSubscription,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    isSubscriptionActive = true;
                } else {
                    userSubscription = userDoc.data();
                    updateSubscriptionStatus();
                }
            } catch (error) {
                console.error('Error checking subscription:', error);
                isSubscriptionActive = false;
            }
        }
        
        // Update subscription status from userSubscription data
        function updateSubscriptionStatus() {
            const now = new Date();
            isSubscriptionActive = false;
            let endDate = null;
            
            // Check if trial period
            if (userSubscription.trialEndDate) {
                const trialEnd = new Date(userSubscription.trialEndDate);
                if (now < trialEnd) {
                    isSubscriptionActive = true;
                    endDate = trialEnd;
                }
            }
            
            // Check if paid subscription
            if (userSubscription.isPaid && userSubscription.subscriptionExpiry) {
                const expiry = new Date(userSubscription.subscriptionExpiry);
                if (now < expiry) {
                    isSubscriptionActive = true;
                    endDate = expiry;
                }
            }
            
            // Check subscriptionEndDate from admin
            if (userSubscription.subscriptionEndDate) {
                let adminEndDate;
                if (userSubscription.subscriptionEndDate.toDate) {
                    adminEndDate = userSubscription.subscriptionEndDate.toDate();
                } else {
                    adminEndDate = new Date(userSubscription.subscriptionEndDate);
                }
                
                if (now < adminEndDate) {
                    isSubscriptionActive = true;
                    endDate = adminEndDate;
                }
            }
            
            // Update days counter in header
            updateDaysCounter(endDate);
        }
        
        // Update days counter display
        function updateDaysCounter(endDate) {
            const counter = document.getElementById('daysCounter');
            const daysLeftSpan = document.getElementById('daysLeft');
            
            if (!counter || !daysLeftSpan) return;
            
            if (endDate) {
                const now = new Date();
                const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                
                if (daysLeft > 0) {
                    daysLeftSpan.textContent = daysLeft;
                    counter.classList.remove('hidden');
                    
                    // Change color based on days left
                    counter.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
                    if (daysLeft > 7) {
                        counter.classList.add('bg-green-500');
                    } else if (daysLeft > 3) {
                        counter.classList.add('bg-yellow-500');
                    } else {
                        counter.classList.add('bg-red-500');
                    }
                } else {
                    counter.classList.add('hidden');
                }
            } else {
                counter.classList.add('hidden');
            }
        }
        
        // Setup realtime subscription listener
        function setupSubscriptionListener() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    userSubscription = doc.data();
                    updateSubscriptionStatus();
                    showSubscriptionBanner();
                }
            }, (error) => {
                console.error('Subscription listener error:', error);
            });
        }
        
        // Show Subscription Banner
        function showSubscriptionBanner() {
            // Remove existing banner
            const existingBanner = document.getElementById('subscriptionBanner');
            if (existingBanner) existingBanner.remove();
            
            if (isSubscriptionActive) return;
            if (currentUser.email === ADMIN_EMAIL) return; // Admin bypass
            
            const banner = document.createElement('div');
            banner.id = 'subscriptionBanner';
            banner.className = 'fixed top-0 left-0 right-0 bg-red-600 text-white p-4 text-center z-50 shadow-lg';
            banner.innerHTML = `
                <div class="container mx-auto flex items-center justify-between flex-wrap gap-4">
                    <div class="flex-1">
                        <p class="text-lg font-bold">âš ï¸ ×”×× ×•×™ ×©×œ×š ×¤×’ ×ª×•×§×£</p>
                        <p class="text-sm">××ª×” ×™×›×•×œ ×œ×¦×¤×•×ª ×‘× ×ª×•× ×™× ××‘×œ ×œ× ×œ×”×•×¡×™×£ ××• ×œ×¢×¨×•×š</p>
                    </div>
                    <button onclick="window.location.href='account.html'" class="bg-white text-red-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-100 transition">
                        ×—×“×© ×× ×•×™ - â‚ª200/×—×•×“×©
                    </button>
                </div>
            `;
            document.body.prepend(banner);
            
            // Adjust main content margin
            document.getElementById('mainApp').style.marginTop = '80px';
        }
        
        // Check if user can modify data
        function canModifyData() {
            if (currentUser && currentUser.email === ADMIN_EMAIL) return true;
            return isSubscriptionActive;
        }
        
        // Show upgrade message
        function showUpgradeMessage() {
            alert('×”×× ×•×™ ×©×œ×š ×¤×’ ×ª×•×§×£.\n\n××ª×” ×™×›×•×œ ×œ×¦×¤×•×ª ×‘× ×ª×•× ×™× ××‘×œ ×œ× ×œ×”×•×¡×™×£ ××• ×œ×¢×¨×•×š.\n\n×—×“×© ××ª ×”×× ×•×™ ×›×“×™ ×œ×”××©×™×š ×œ×”×©×ª××© ×‘×›×œ ×”×ª×›×•× ×•×ª.');
        }

        // Load User Name
        async function loadUserName() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists && userDoc.data().displayName) {
                    document.getElementById('userName').textContent = userDoc.data().displayName;
                } else {
                    document.getElementById('userName').textContent = currentUser.email.split('@')[0];
                }
            } catch (error) {
                console.error('Error loading user name:', error);
                document.getElementById('userName').textContent = currentUser.email.split('@')[0];
            }
        }

        // Edit User Name
        function editUserName() {
            const currentName = document.getElementById('userName').textContent;
            const newName = prompt('×”×›× ×¡ ×©× ×—×“×©:', currentName);
            
            if (newName && newName.trim() !== '' && newName !== currentName) {
                saveUserName(newName.trim());
            }
        }

        // Save User Name
        async function saveUserName(name) {
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    displayName: name,
                    email: currentUser.email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                document.getElementById('userName').textContent = name;
                updateSidebarUserInfo(); // Update sidebar
                alert('×”×©× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
            } catch (error) {
                console.error('Error saving user name:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”×©×');
            }
        }

        // Login/Register handled by login.html now
        // Old code removed - authentication now handled separately

        // Load Cars
        async function loadCars() {
            try {
                const snapshot = await db.collection('cars')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                cars = [];
                snapshot.forEach(doc => {
                    cars.push({ id: doc.id, ...doc.data() });
                });
                
                displayCars();
                
                // Load spare parts contacts
                await loadSparePartsContacts();
            } catch (error) {
                console.error('Error loading cars:', error);
            }
        }

        // Display Cars
        function displayCars() {
            const grid = document.getElementById('carsGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (cars.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            grid.innerHTML = cars.map(car => `
                <div class="card border-4 border-gray-800 shadow-xl" data-search="${car.plateNumber} ${car.ownerName || ''} ${car.phone || ''} ${car.carType || ''} ${car.model || ''} ${car.year || ''}">
                    ${car.imageUrl ? 
                        `<div class="relative overflow-hidden cursor-pointer group" onclick="viewCarDetails('${car.id}')">
                            <img src="${car.imageUrl}" class="car-image">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/0 to-black/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                <div class="absolute bottom-4 left-4 right-4">
                                    <p class="text-white font-bold text-sm">×œ×—×¥ ×œ×¤×¨×˜×™× ××œ××™× â†’</p>
                                </div>
                            </div>
                        </div>` : 
                        `<div class="car-image-placeholder cursor-pointer group" onclick="viewCarDetails('${car.id}')">
                            <div class="text-center">
                                <div class="text-5xl mb-2 opacity-20 group-hover:opacity-40 transition-opacity">ğŸš—</div>
                                <p class="text-sm text-gray-400 font-medium">××™×Ÿ ×ª××•× ×”</p>
                            </div>
                        </div>`
                    }
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-900 cursor-pointer hover:text-amber-600 transition-colors mb-2" onclick="viewCarDetails('${car.id}')">${car.plateNumber}</h3>
                                ${car.ownerName ? `<p class="text-gray-700 font-semibold text-base">${car.ownerName}</p>` : ''}
                                ${car.carStatus ? `
                                    <span class="inline-flex items-center gap-1 mt-3 text-xs px-3 py-1.5 rounded-lg font-semibold ${
                                        car.carStatus === 'waiting' ? 'status-waiting' :
                                        car.carStatus === 'in_progress' ? 'status-progress' :
                                        car.carStatus === 'ready' ? 'status-ready' :
                                        'status-completed'
                                    }">
                                        ${
                                            car.carStatus === 'waiting' ? 'â³ ×××ª×™×Ÿ ×œ×˜×™×¤×•×œ' :
                                            car.carStatus === 'in_progress' ? 'ğŸ”§ ×‘×˜×™×¤×•×œ' :
                                            car.carStatus === 'ready' ? 'âœ… ××•×›×Ÿ ×œ××™×¡×•×£' :
                                            'ğŸ ×”×•×©×œ×'
                                        }
                                    </span>
                                ` : ''}
                            </div>
                            <span class="badge badge-primary">
                                <span class="text-base">ğŸš—</span>
                            </span>
                        </div>
                        
                        <div class="divider mb-4"></div>
                        
                        <div class="space-y-2.5 mb-5">
                            ${car.phone ? `<div class="info-item"><span class="text-base">ğŸ“</span><span>${car.phone}</span></div>` : ''}
                            ${car.carType ? `<div class="info-item"><span class="text-base">ğŸ·ï¸</span><strong>${car.carType}</strong></div>` : ''}
                            ${car.model ? `<div class="info-item"><span class="text-base">ğŸ“‹</span><span>${car.model}</span></div>` : ''}
                            ${car.year ? `<div class="info-item"><span class="text-base">ğŸ“…</span><span>${car.year}</span></div>` : ''}
                        </div>
                        
                        <!-- Quick Actions for Mobile -->
                        ${car.phone ? `
                        <div class="mobile-quick-actions">
                            <a href="tel:${car.phone}" class="quick-action-btn bg-green-500 hover:bg-green-600">
                                ğŸ“ <span class="hidden sm:inline">×”×ª×§×©×¨</span>
                            </a>
                            <a href="https://wa.me/972${car.phone.replace(/^0/, '')}" target="_blank" class="quick-action-btn bg-emerald-500 hover:bg-emerald-600">
                                ğŸ’¬ <span class="hidden sm:inline">WhatsApp</span>
                            </a>
                        </div>
                        ` : ''}
                        
                        <div class="space-y-2.5">
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="viewCarDetails('${car.id}')" class="btn btn-success text-xs py-2.5">
                                    ×¤×¨×˜×™×
                                </button>
                                <button onclick="editCar('${car.id}')" class="btn btn-primary text-xs py-2.5">
                                    ×¢×¨×•×š
                                </button>
                                <button onclick="deleteCar('${car.id}')" class="btn btn-danger text-xs py-2.5">
                                    ××—×§
                                </button>
                            </div>
                            ${!car.carStatus ? `
                                <button onclick="addCarToDashboard('${car.id}')" class="btn btn-secondary w-full text-xs py-2.5">
                                    ğŸ“Š ×”×•×¡×£ ×œ×œ×•×— ×‘×§×¨×”
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // View Car Details
        async function viewCarDetails(carId) {
            currentCarId = carId;
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            // Display car details
            document.getElementById('detailsPlateNumber').textContent = car.plateNumber;
            
            // No phone action buttons - removed as per user request
            const phoneButtons = '';
            
            document.getElementById('carDetailsContent').innerHTML = `
                ${phoneButtons}
                
                <!-- Car Image with Change Button -->
                <div class="mb-6">
                    ${car.imageUrl ? `
                        <div class="relative">
                            <img src="${car.imageUrl}" class="w-full max-h-64 object-contain rounded border">
                        </div>
                    ` : `
                    `}
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    ${car.ownerName ? `<div><span class="font-bold">×©× ×”×‘×¢×œ×™×:</span> ${car.ownerName}</div>` : ''}
                    ${car.phone ? `<div><span class="font-bold">×˜×œ×¤×•×Ÿ:</span> ${car.phone}</div>` : ''}
                    ${car.carType ? `<div><span class="font-bold">×¡×•×’ ×¨×›×‘:</span> ${car.carType}</div>` : ''}
                    ${car.model ? `<div><span class="font-bold">×“×’×:</span> ${car.model}</div>` : ''}
                    ${car.year ? `<div><span class="font-bold">×©× ×ª ×™×™×¦×•×¨:</span> ${car.year}</div>` : ''}
                    ${car.vinCode ? `<div><span class="font-bold">×§×•×“ ×¨×›×‘ (VIN):</span> ${car.vinCode}</div>` : ''}
                    ${car.immobilizerCode ? `<div class="bg-yellow-50 border border-yellow-300 p-2 rounded"><span class="font-bold">ğŸ”‘ ×§×•×“ ×”×ª× ×¢×”:</span> <span class="font-mono">${car.immobilizerCode}</span></div>` : ''}
                    ${car.engineType ? `<div><span class="font-bold">×¡×•×’ ×× ×•×¢:</span> ${car.engineType}</div>` : ''}
                    ${car.enginePower ? `<div class="col-span-2"><span class="font-bold">×”×¡×¤×§ ×× ×•×¢:</span> ${car.enginePower}</div>` : ''}
                </div>
            `;
            
            // Load maintenance history
            await loadMaintenanceHistory(carId);
            
            document.getElementById('carDetailsModal').classList.remove('hidden');
        }

        // Load Maintenance History
        async function loadMaintenanceHistory(carId) {
            try {
                // Get car data first
                const car = cars.find(c => c.id === carId);
                
                const snapshot = await db.collection('maintenance')
                    .where('carId', '==', carId)
                    .get();
                
                const maintenanceList = [];
                snapshot.forEach(doc => {
                    maintenanceList.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by createdAt in JavaScript (no Firestore index needed)
                maintenanceList.sort((a, b) => {
                    const dateA = safeToMillis(a.createdAt) || 0;
                    const dateB = safeToMillis(b.createdAt) || 0;
                    return dateB - dateA; // Newest first
                });
                
                const historyDiv = document.getElementById('maintenanceHistory');
                
                if (maintenanceList.length === 0) {
                    historyDiv.innerHTML = '<p class="text-gray-500 text-center py-4">××™×Ÿ ×˜×™×¤×•×œ×™× ×¢×“×™×™×Ÿ</p>';
                    return;
                }
                
                historyDiv.innerHTML = maintenanceList.map(m => {
                    return `
                        <div class="border rounded-lg p-4 bg-gray-50">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    ${m.date ? `<div class="font-bold text-lg mb-1">ğŸ“… ${new Date(m.date).toLocaleDateString('he-IL')}</div>` : ''}
                                    ${m.kilometers ? `<div class="text-sm text-gray-600">ğŸš— ${m.kilometers} ×§×´×</div>` : ''}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="orderSparePartFromMaintenance('${car.id}', '${m.partName || ""}', '${m.workDescription || ""}')" class="text-green-600 hover:underline text-sm">ğŸ“¦ ×”×–××Ÿ ×—×œ×§</button>
                                    <button onclick="printMaintenance('${m.id}')" class="text-purple-600 hover:underline text-sm">ğŸ–¨ï¸ ×”×“×¤×¡</button>
                                    <button onclick="editMaintenance('${m.id}')" class="text-blue-600 hover:underline text-sm">×¢×¨×™×›×”</button>
                                    <button onclick="deleteMaintenance('${m.id}')" class="text-red-600 hover:underline text-sm">××—×™×§×”</button>
                                </div>
                            </div>
                            
                            ${m.partName ? `<p class="mb-2"><strong>ğŸ”§ ×—×œ×§:</strong> ${m.partName}</p>` : ''}
                            ${m.workDescription ? `<p class="mb-2"><strong>×ª×™××•×¨:</strong> ${m.workDescription}</p>` : ''}
                            
                            ${m.totalCost > 0 ? `
                                <div class="text-lg font-bold text-green-700 mb-2">
                                    ğŸ’° ${m.totalCost.toFixed(2)} â‚ª
                                </div>
                            ` : ''}
                            
                            ${m.images && m.images.length > 0 ? `
                                <div class="grid grid-cols-3 gap-2 mt-2">
                                    ${m.images.map(img => `<img src="${img}" class="w-full h-24 object-cover rounded cursor-pointer" onclick="window.open('${img}')">`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading maintenance:', error);
            }
        }

        // Close Car Details Modal
        function closeCarDetailsModal() {
            document.getElementById('carDetailsModal').classList.add('hidden');
            currentCarId = null;
        }

        // Open Car Modal
        function openCarModal() {
            editingCarId = null;
            document.getElementById('modalTitle').textContent = '×”×•×¡×£ ×¨×›×‘';
            document.getElementById('carForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('carModal').classList.remove('hidden');
            hideUIElements(); // Ø¥Ø®ÙØ§Ø¡ FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
        }

        // Close Car Modal
        function closeCarModal() {
            document.getElementById('carModal').classList.add('hidden');
            editingCarId = null;
            showUIElements(); // Ø¥Ø¸Ù‡Ø§Ø± FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
        }

        // Edit Car
        function editCar(carId) {
            // Check subscription
            if (!canModifyData()) {
                showUpgradeMessage();
                return;
            }
            
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            editingCarId = carId;
            document.getElementById('modalTitle').textContent = '×¢×¨×•×š ×¨×›×‘';
            document.getElementById('plateNumber').value = car.plateNumber || '';
            document.getElementById('ownerName').value = car.ownerName || '';
            document.getElementById('phone').value = car.phone || '';
            document.getElementById('carType').value = car.carType || '';
            document.getElementById('model').value = car.model || '';
            document.getElementById('year').value = car.year || '';
            document.getElementById('immobilizerCode').value = car.immobilizerCode || '';
            document.getElementById('engineType').value = car.engineType || '';
            document.getElementById('enginePower').value = car.enginePower || '';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            const imageInput = document.getElementById('carImage');
            imageInput.value = '';
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ù„Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‚ÙŠÙˆØ¯
            const newImageInput = imageInput.cloneNode(true);
            imageInput.parentNode.replaceChild(newImageInput, imageInput);
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© event listener
            newImageInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                const previewDiv = document.getElementById('imagePreview');
                
                if (!file) {
                    previewDiv.innerHTML = '';
                    return;
                }
                
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('×”×§×•×‘×¥ ×’×“×•×œ ××“×™ (××§×¡×™××•× 10MB)');
                    e.target.value = '';
                    previewDiv.innerHTML = '';
                    return;
                }
                
                // Show loading
                previewDiv.innerHTML = `
                    <div class="text-center py-4">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-amber-500"></div>
                        <p class="text-sm text-gray-600 mt-2">××¢×‘×“ ×ª××•× ×”...</p>
                    </div>
                `;
                
                // Small delay to show loading
                await new Promise(resolve => setTimeout(resolve, 100));
                
                try {
                    const originalSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    
                    // Compress image
                    const compressed = await compressImage(file, 700);
                    const compressedSizeKB = (compressed.length / 1024 / 1.37).toFixed(0);
                    
                    // Show preview with change button
                    previewDiv.innerHTML = `
                        <div class="inline-block">
                            <img src="${compressed}" class="w-48 h-48 object-cover rounded-lg border-2 border-green-400 shadow-lg" alt="×ª×¦×•×’×” ××§×“×™××” ×—×“×©×”">
                            <div class="mt-3 text-center">
                                <p class="text-sm text-green-600 font-bold mb-2">âœ“ ×”×ª××•× ×” ×”×—×“×©×” × ×“×—×¡×” ×‘×”×¦×œ×—×”</p>
                                <p class="text-xs text-gray-500 mb-3">${originalSizeMB}MB â†’ ${compressedSizeKB}KB</p>
                                <button type="button" onclick="document.getElementById('carImage').value=''; document.getElementById('carImage').click();" 
                                        class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                                    ğŸ”„ ×©× ×” ×ª××•× ×”
                                </button>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    // Show error
                    const errorMsg = error.message || '×©×’×™××” ×œ× ×™×“×•×¢×”';
                    previewDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-300 rounded-lg p-4 text-center">
                            <p class="text-red-700 text-sm font-semibold mb-2">âŒ ${errorMsg}</p>
                            <p class="text-red-600 text-xs mb-2">× ×¡×” ×œ×”×©×ª××© ×‘×ª××•× ×” ××—×¨×ª</p>
                            <button type="button" onclick="document.getElementById('carImage').value=''; document.getElementById('imagePreview').innerHTML=''; document.getElementById('carImage').click();" 
                                    class="text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                                × ×¡×” ×©×•×‘
                            </button>
                        </div>
                    `;
                    e.target.value = '';
                }
            });
            
            if (car.imageUrl) {
                document.getElementById('imagePreview').innerHTML = 
                    `<div class="inline-block">
                        <img src="${car.imageUrl}" class="w-48 h-48 object-cover rounded-lg border-2 border-amber-400 shadow-lg" alt="×ª××•× ×” × ×•×›×—×™×ª">
                        <div class="mt-3 text-center">
                            <p class="text-xs text-blue-600 font-semibold mb-2">ğŸ“· ×ª××•× ×” × ×•×›×—×™×ª</p>
                            <button type="button" onclick="document.getElementById('carImage').click()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                                ğŸ”„ ×©× ×” ×ª××•× ×”
                            </button>
                            <p class="text-xs text-gray-600 mt-2">××• ×œ×—×¥ ×¢×œ ××™×–×•×¨ ×”×”×¢×œ××” ×œ××¢×œ×”</p>
                        </div>
                    </div>`;
            } else {
                document.getElementById('imagePreview').innerHTML = '';
            }
            
            document.getElementById('carModal').classList.remove('hidden');
        }

        // Car Form Submit
        document.getElementById('carForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check subscription
            if (!canModifyData()) {
                showUpgradeMessage();
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '×©×•××¨...';
            
            try {
                const plateNumber = document.getElementById('plateNumber').value.trim();
                
                // Check for duplicate plate number (only when adding new car or changing plate number)
                if (!editingCarId || (editingCarId && plateNumber !== cars.find(c => c.id === editingCarId)?.plateNumber)) {
                    const duplicateCar = cars.find(c => c.plateNumber === plateNumber && c.id !== editingCarId);
                    
                    if (duplicateCar) {
                        alert('âš ï¸ ×”×¨×›×‘ ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª!\n\n××¡×¤×¨ ×¨×™×©×•×™: ' + plateNumber + '\n×‘×¢×œ×™×: ' + duplicateCar.ownerName);
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                }
                
                const carData = {
                    plateNumber: plateNumber,
                    ownerName: document.getElementById('ownerName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    carType: document.getElementById('carType').value.trim(),
                    model: document.getElementById('model').value.trim(),
                    year: document.getElementById('year').value.trim(),
                    immobilizerCode: document.getElementById('immobilizerCode').value.trim(),
                    engineType: document.getElementById('engineType').value.trim(),
                    enginePower: document.getElementById('enginePower').value.trim(),
                    userId: currentUser.uid,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Only add carStatus if editing existing car that has status
                if (editingCarId) {
                    const existingCar = cars.find(c => c.id === editingCarId);
                    if (existingCar && existingCar.carStatus) {
                        carData.carStatus = existingCar.carStatus;
                    }
                }
                
                const imageFile = document.getElementById('carImage').files[0];
                if (imageFile) {
                    try {
                        submitBtn.textContent = '×“×•×—×¡ ×ª××•× ×”...';
                        const compressedImage = await compressImage(imageFile, 700);
                        carData.imageUrl = compressedImage;
                        submitBtn.textContent = '×©×•××¨ × ×ª×•× ×™×...';
                    } catch (imageError) {
                        console.error('Image compression error:', imageError);
                        alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª××•× ×”. ×× × × ×¡×” ×©×•×‘.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                } else if (editingCarId) {
                    const existingCar = cars.find(c => c.id === editingCarId);
                    if (existingCar && existingCar.imageUrl) {
                        carData.imageUrl = existingCar.imageUrl;
                    }
                }
                
                if (editingCarId) {
                    await db.collection('cars').doc(editingCarId).update(carData);
                    alert('×”×¨×›×‘ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
                } else {
                    carData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('cars').add(carData);
                    alert('×”×¨×›×‘ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
                }
                
                document.getElementById('carForm').reset();
                document.getElementById('imagePreview').innerHTML = '';
                closeCarModal();
                await loadCars();
                
            } catch (error) {
                console.error('Error saving car:', error);
                alert('×©×’×™××”: ' + (error.message || '×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××ª ×”× ×ª×•× ×™×'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Delete Car
        async function deleteCar(carId) {
            // Check subscription
            if (!canModifyData()) {
                showUpgradeMessage();
                return;
            }
            
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×¨×›×‘? ×’× ×›×œ ×”×˜×™×¤×•×œ×™× ×™×™××—×§×•.')) return;
            
            try {
                // Delete all maintenance records
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('carId', '==', carId)
                    .get();
                
                const deletePromises = [];
                maintenanceSnapshot.forEach(doc => {
                    deletePromises.push(doc.ref.delete());
                });
                await Promise.all(deletePromises);
                
                // Delete car
                await db.collection('cars').doc(carId).delete();
                alert('×”×¨×›×‘ × ××—×§ ×‘×”×¦×œ×—×”');
                await loadCars();
            } catch (error) {
                console.error('Error deleting car:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×¨×›×‘');
            }
        }

        // Change Car Image
        function changeCarImage(carId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // Enable camera on mobile
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check if it's an image
                if (!file.type.startsWith('image/')) {
                    alert('×× × ×‘×—×¨ ×§×•×‘×¥ ×ª××•× ×” ×‘×œ×‘×“');
                    return;
                }
                
                // Check file size (max 30MB)
                if (file.size > 30 * 1024 * 1024) {
                    alert('×”×§×•×‘×¥ ×’×“×•×œ ××“×™. ×’×•×“×œ ××§×¡×™××œ×™: 30MB');
                    return;
                }
                
                try {
                    // Show loading
                    const loadingMsg = document.createElement('div');
                    loadingMsg.id = 'imageLoadingMsg';
                    loadingMsg.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    loadingMsg.textContent = 'ğŸ“· ××¢×œ×” ×ª××•× ×”...';
                    document.body.appendChild(loadingMsg);
                    
                    // Convert to base64
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const imageUrl = event.target.result;
                            
                            // Update car in database
                            await db.collection('cars').doc(carId).update({
                                imageUrl: imageUrl,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Remove loading message
                            const msg = document.getElementById('imageLoadingMsg');
                            if (msg) document.body.removeChild(msg);
                            
                            // Show success
                            alert('âœ… ×”×ª××•× ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!');
                            
                            // Reload car details
                            await loadCars();
                            viewCarDetails(carId);
                            
                        } catch (error) {
                            const msg = document.getElementById('imageLoadingMsg');
                            if (msg) document.body.removeChild(msg);
                            console.error('Error updating image:', error);
                            alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×ª××•× ×”');
                        }
                    };
                    
                    reader.onerror = () => {
                        const msg = document.getElementById('imageLoadingMsg');
                        if (msg) document.body.removeChild(msg);
                        alert('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥');
                    };
                    
                    reader.readAsDataURL(file);
                    
                } catch (error) {
                    console.error('Error processing image:', error);
                    alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª××•× ×”');
                }
            };
            input.click();
        }

        // Delete Car Image
        async function deleteCarImage(carId) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×ª××•× ×”?')) return;
            
            try {
                await db.collection('cars').doc(carId).update({
                    imageUrl: firebase.firestore.FieldValue.delete(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('âœ… ×”×ª××•× ×” × ××—×§×” ×‘×”×¦×œ×—×”!');
                await loadCars();
                viewCarDetails(carId);
                
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×ª××•× ×”');
            }
        }

        // Open Maintenance Modal
        function openMaintenanceModal() {
            // Check subscription
            if (!canModifyData()) {
                showUpgradeMessage();
                return;
            }
            
            if (!currentCarId) {
                alert('×× × ×‘×—×¨ ×¨×›×‘ ×ª×—×™×œ×”');
                return;
            }
            
            editingMaintenanceId = null;
            maintenanceImages = [];
            document.getElementById('maintenanceForm').reset();
            document.getElementById('maintenanceImagesPreview').innerHTML = '';
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('maintenanceDate').value = today;
            
            document.getElementById('maintenanceModal').classList.remove('hidden');
        }

        // Close Maintenance Modal
        function closeMaintenanceModal() {
            document.getElementById('maintenanceModal').classList.add('hidden');
            editingMaintenanceId = null;
            maintenanceImages = [];
        }

        // Edit Maintenance
        async function editMaintenance(maintenanceId) {
            // Check subscription
            if (!canModifyData()) {
                showUpgradeMessage();
                return;
            }
            
            try {
                const doc = await db.collection('maintenance').doc(maintenanceId).get();
                if (!doc.exists) return;
                
                const m = doc.data();
                editingMaintenanceId = maintenanceId;
                
                document.getElementById('maintenanceDate').value = m.date || '';
                document.getElementById('kilometers').value = m.kilometers || '';
                document.getElementById('partName').value = m.partName || '';
                document.getElementById('workDescription').value = m.workDescription || '';
                document.getElementById('totalCost').value = m.totalCost || '';
                
                maintenanceImages = m.images || [];
                
                if (maintenanceImages.length > 0) {
                    document.getElementById('maintenanceImagesPreview').innerHTML = 
                        maintenanceImages.map((img, i) => `
                            <div class="relative">
                                <img src="${img}" class="w-full h-24 object-cover rounded">
                                <button type="button" onclick="removeMaintenanceImage(${i})" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 text-xs">Ã—</button>
                            </div>
                        `).join('');
                }
                
                document.getElementById('maintenanceModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading maintenance:', error);
            }
        }

        // Delete Maintenance
        async function deleteMaintenance(maintenanceId) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×˜×™×¤×•×œ?')) return;
            
            try {
                await db.collection('maintenance').doc(maintenanceId).delete();
                alert('×”×˜×™×¤×•×œ × ××—×§ ×‘×”×¦×œ×—×”');
                await loadMaintenanceHistory(currentCarId);
            } catch (error) {
                console.error('Error deleting maintenance:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×˜×™×¤×•×œ');
            }
        }

        // Print Maintenance
        async function printMaintenance(maintenanceId) {
            try {
                const doc = await db.collection('maintenance').doc(maintenanceId).get();
                if (!doc.exists) return;
                
                const m = doc.data();
                const car = cars.find(c => c.id === currentCarId);
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="he" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>×“×•×— ×˜×™×¤×•×œ - ${car.plateNumber}</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                direction: rtl;
                                padding: 20px;
                                max-width: 800px;
                                margin: 0 auto;
                            }
                            .header {
                                text-align: center;
                                border-bottom: 3px solid #333;
                                padding-bottom: 20px;
                                margin-bottom: 30px;
                            }
                            .header h1 {
                                margin: 0;
                                font-size: 32px;
                            }
                            .header p {
                                margin: 5px 0;
                                color: #666;
                            }
                            .section {
                                margin-bottom: 20px;
                            }
                            .section-title {
                                font-weight: bold;
                                font-size: 18px;
                                border-bottom: 2px solid #eee;
                                padding-bottom: 5px;
                                margin-bottom: 10px;
                            }
                            .info-row {
                                margin: 10px 0;
                                font-size: 16px;
                            }
                            .info-label {
                                font-weight: bold;
                                display: inline-block;
                                width: 150px;
                            }
                            .cost {
                                font-size: 28px;
                                font-weight: bold;
                                color: #22c55e;
                                text-align: center;
                                padding: 20px;
                                border: 2px solid #22c55e;
                                border-radius: 10px;
                                margin: 20px 0;
                            }
                            .footer {
                                margin-top: 50px;
                                text-align: center;
                                color: #666;
                                font-size: 14px;
                                border-top: 1px solid #eee;
                                padding-top: 20px;
                            }
                            @media print {
                                body {
                                    padding: 0;
                                }
                                .no-print {
                                    display: none;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>×“×•×— ×˜×™×¤×•×œ</h1>
                            <p>${new Date().toLocaleDateString('he-IL', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">×¤×¨×˜×™ ×¨×›×‘</div>
                            <div class="info-row">
                                <span class="info-label">××¡×¤×¨ ×¨×™×©×•×™:</span>
                                <span>${car.plateNumber}</span>
                            </div>
                            ${car.ownerName ? `
                                <div class="info-row">
                                    <span class="info-label">×©× ×”×‘×¢×œ×™×:</span>
                                    <span>${car.ownerName}</span>
                                </div>
                            ` : ''}
                            ${car.phone ? `
                                <div class="info-row">
                                    <span class="info-label">×˜×œ×¤×•×Ÿ:</span>
                                    <span>${car.phone}</span>
                                </div>
                            ` : ''}
                            ${car.carType ? `
                                <div class="info-row">
                                    <span class="info-label">×¡×•×’ ×¨×›×‘:</span>
                                    <span>${car.carType}</span>
                                </div>
                            ` : ''}
                            ${car.model ? `
                                <div class="info-row">
                                    <span class="info-label">×“×’×:</span>
                                    <span>${car.model}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${m.workDescription ? `
                            <div class="section">
                                <div class="section-title">×ª×™××•×¨ ×”×¢×‘×•×“×”</div>
                                <div class="info-row">${m.workDescription}</div>
                            </div>
                        ` : ''}
                        
                        ${m.parts ? `
                            <div class="section">
                                <div class="section-title">×—×œ×§×™ ×—×™×œ×•×£</div>
                                <div class="info-row">${m.parts}</div>
                            </div>
                        ` : ''}
                        
                        ${m.notes ? `
                            <div class="section">
                                <div class="section-title">×”×¢×¨×•×ª</div>
                                <div class="info-row">${m.notes}</div>
                            </div>
                        ` : ''}
                        
                        ${m.totalCost > 0 ? `
                            <div class="cost">
                                ×¡×”"×› ×œ×ª×©×œ×•×: ${m.totalCost.toFixed(2)} â‚ª
                            </div>
                        ` : ''}
                        
                        <div class="footer">
                            <p>×ª×•×“×” ×©×‘×—×¨×ª ×‘×©×™×¨×•×ª×™× ×•!</p>
                            <p>×“×•×— ×–×” ×”×•×¤×§ ×‘×ª××¨×™×š ${new Date().toLocaleDateString('he-IL')}</p>
                        </div>
                        
                        <div class="no-print" style="text-align: center; margin-top: 30px;">
                            <button onclick="window.print()" style="padding: 10px 30px; font-size: 16px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                ğŸ–¨ï¸ ×”×“×¤×¡
                            </button>
                            <button onclick="window.close()" style="padding: 10px 30px; font-size: 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                ×¡×’×•×¨
                            </button>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
            } catch (error) {
                console.error('Error printing maintenance:', error);
                alert('×©×’×™××” ×‘×”×“×¤×¡×ª ×”×˜×™×¤×•×œ');
            }
        }

        // Remove Maintenance Image
        function removeMaintenanceImage(index) {
            maintenanceImages.splice(index, 1);
            document.getElementById('maintenanceImagesPreview').innerHTML = 
                maintenanceImages.map((img, i) => `
                    <div class="relative">
                        <img src="${img}" class="w-full h-24 object-cover rounded">
                        <button type="button" onclick="removeMaintenanceImage(${i})" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 text-xs">Ã—</button>
                    </div>
                `).join('');
        }

        // Maintenance Form Submit
        document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '×©×•××¨...';
            
            try {
                const maintenanceData = {
                    carId: currentCarId,
                    userId: currentUser.uid,
                    date: document.getElementById('maintenanceDate').value,
                    kilometers: document.getElementById('kilometers').value,
                    partName: document.getElementById('partName').value,
                    workDescription: document.getElementById('workDescription').value,
                    totalCost: parseFloat(document.getElementById('totalCost').value) || 0,
                    images: maintenanceImages,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Handle new images
                const imageFiles = document.getElementById('maintenanceImages').files;
                if (imageFiles.length > 0) {
                    submitBtn.textContent = '×“×•×—×¡ ×ª××•× ×•×ª...';
                    
                    for (let i = 0; i < Math.min(imageFiles.length, 5); i++) {
                        try {
                            const compressed = await compressImage(imageFiles[i], 500);
                            maintenanceImages.push(compressed);
                        } catch (err) {
                            console.error('Image compression error:', err);
                        }
                    }
                    
                    maintenanceData.images = maintenanceImages;
                }
                
                submitBtn.textContent = '×©×•××¨ × ×ª×•× ×™×...';
                
                if (editingMaintenanceId) {
                    await db.collection('maintenance').doc(editingMaintenanceId).update(maintenanceData);
                    alert('×”×˜×™×¤×•×œ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
                } else {
                    maintenanceData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('maintenance').add(maintenanceData);
                    alert('×”×˜×™×¤×•×œ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
                }
                
                closeMaintenanceModal();
                await loadMaintenanceHistory(currentCarId);
                
            } catch (error) {
                console.error('Error saving maintenance:', error);
                alert('×©×’×™××”: ' + (error.message || '×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××ª ×”× ×ª×•× ×™×'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Search Cars
        function searchCars() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
            const allCards = document.querySelectorAll('#carsGrid > .card');
            
            if (searchTerm === '') {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« ÙØ§Ø±ØºØ§Ù‹ØŒ Ø£Ø¸Ù‡Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
                allCards.forEach(card => {
                    card.style.display = 'block';
                });
                return;
            }
            
            let foundCount = 0;
            
            allCards.forEach(card => {
                const searchData = card.getAttribute('data-search');
                if (searchData) {
                    const text = searchData.toLowerCase();
                    if (text.includes(searchTerm)) {
                        card.style.display = 'block';
                        foundCount++;
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
            
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬
            const emptyState = document.getElementById('emptyState');
            if (foundCount === 0) {
                emptyState.innerHTML = '<p class="text-gray-500 text-xl">âŒ ×œ× × ××¦××• ×ª×•×¦××•×ª ×¢×‘×•×¨: "' + document.getElementById('searchBox').value + '"</p>';
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }
        }

        // Export CSV
        function exportCSV() {
            if (cars.length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×');
                return;
            }
            
            let csv = '××¡×¤×¨ ×¨×™×©×•×™,×©× ×‘×¢×œ×™×,×˜×œ×¤×•×Ÿ,×¡×•×’,×“×’×,×©× ×”\n';
            cars.forEach(car => {
                csv += `${car.plateNumber},${car.ownerName || ''},${car.phone || ''},${car.carType || ''},${car.model || ''},${car.year || ''}\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `cars_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Sign Out
        async function signOut() {
            if (confirm('×”×× ×œ×¦××ª ××”××¢×¨×›×ª?')) {
                try {
                    await auth.signOut();
                    // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
                }
            }
        }

        // Show Message
        function showMessage(message, type) {
            const errorDiv = document.getElementById('errorMsg');
            const successDiv = document.getElementById('successMsg');
            
            if (type === 'error') {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
            } else {
                successDiv.textContent = message;
                successDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
            }
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
            }, 5000);
        }

        // Image Preview - Simplified for mobile
        document.getElementById('carImage').addEventListener('change', async (e) => {
            console.log('File input changed!');
            const file = e.target.files[0];
            console.log('Selected file:', file);
            const previewDiv = document.getElementById('imagePreview');
            
            if (!file) {
                console.log('No file selected');
                previewDiv.innerHTML = '';
                return;
            }
            
            console.log('File details:', {
                name: file.name,
                size: file.size,
                type: file.type
            });
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('×”×§×•×‘×¥ ×’×“×•×œ ××“×™ (××§×¡×™××•× 10MB)');
                e.target.value = '';
                previewDiv.innerHTML = '';
                return;
            }
            
            // Show loading
            previewDiv.innerHTML = `
                <div class="text-center py-4">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-amber-500"></div>
                    <p class="text-sm text-gray-600 mt-2">××¢×‘×“ ×ª××•× ×”...</p>
                </div>
            `;
            
            // Small delay to show loading
            await new Promise(resolve => setTimeout(resolve, 100));
            
            try {
                console.log('Starting compression...');
                const originalSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                
                // Compress image
                const compressed = await compressImage(file, 700);
                console.log('Compression successful!');
                const compressedSizeKB = (compressed.length / 1024 / 1.37).toFixed(0);
                
                // Show preview with change button
                previewDiv.innerHTML = `
                    <div class="inline-block">
                        <img src="${compressed}" class="w-48 h-48 object-cover rounded-lg border-2 border-green-400 shadow-lg" alt="×ª×¦×•×’×” ××§×“×™××”">
                        <div class="mt-3 text-center">
                            <p class="text-sm text-green-600 font-bold mb-2">âœ“ ×”×ª××•× ×” × ×“×—×¡×” ×‘×”×¦×œ×—×”</p>
                            <p class="text-xs text-gray-500 mb-3">${originalSizeMB}MB â†’ ${compressedSizeKB}KB</p>
                            <button type="button" onclick="document.getElementById('carImage').value=''; document.getElementById('carImage').click();" 
                                    class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                                ğŸ”„ ×©× ×” ×ª××•× ×”
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Compression error:', error);
                // Show error
                const errorMsg = error.message || '×©×’×™××” ×œ× ×™×“×•×¢×”';
                previewDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-300 rounded-lg p-4 text-center">
                        <p class="text-red-700 text-sm font-semibold mb-2">âŒ ${errorMsg}</p>
                        <p class="text-red-600 text-xs mb-2">× ×¡×” ×œ×”×©×ª××© ×‘×ª××•× ×” ××—×¨×ª</p>
                        <button type="button" onclick="document.getElementById('carImage').value=''; document.getElementById('imagePreview').innerHTML=''; document.getElementById('carImage').click();" 
                                class="text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                            × ×¡×” ×©×•×‘
                        </button>
                    </div>
                `;
                e.target.value = '';
            }
        });

        // Maintenance Images Preview
        document.getElementById('maintenanceImages').addEventListener('change', async (e) => {
            const files = e.target.files;
            const previewDiv = document.getElementById('maintenanceImagesPreview');
            
            if (files.length > 0) {
                const previews = [];
                for (let i = 0; i < Math.min(files.length, 5); i++) {
                    const file = files[i];
                    if (file.type.match(/image\/(jpeg|jpg|png|gif)/)) {
                        const reader = new FileReader();
                        const preview = await new Promise((resolve) => {
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                        previews.push(preview);
                    }
                }
                
                previewDiv.innerHTML = previews.map((img, i) => `
                    <img src="${img}" class="w-full h-24 object-cover rounded">
                `).join('');
            }
        });

        // ==========================================
        // APPOINTMENTS SYSTEM
        // ==========================================

        // Load Appointments from Firebase
        async function loadAppointments() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.collection('appointments')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                appointments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Sort by date locally
                appointments.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateA - dateB;
                });
                
                console.log('Loaded appointments:', appointments.length);
            } catch (error) {
                console.error('Error loading appointments:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×’×™×©×•×ª: ' + error.message);
            }
        }

        // Open Calendar Modal
        async function openCalendarModal() {
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
            const sidebar = document.getElementById('sidebar');
            if (sidebar && sidebar.classList.contains('open')) {
                toggleSidebar();
            }
            // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ modals Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹
            closeAllModals();
            // ÙØªØ­ Ø§Ù„ÙŠÙˆÙ…Ù†
            document.getElementById('calendarModal').classList.remove('hidden');
            await loadAppointments(); // Reload appointments
            renderCalendar();
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù†
            updateActiveNav(2);
            hideUIElements(); // Ø¥Ø®ÙØ§Ø¡ FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
        }

        // Close Calendar Modal
        function closeCalendarModal() {
            document.getElementById('calendarModal').classList.add('hidden');
            showUIElements(); // Ø¥Ø¸Ù‡Ø§Ø± FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØª ÙÙŠ Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù†
            updateActiveNav(0);
        }

        // Open Appointment Modal
        function openAppointmentModal() {
            editingAppointmentId = null;
            document.getElementById('appointmentForm').reset();
            
            // Populate car dropdown
            const carSelect = document.getElementById('appointmentCar');
            carSelect.innerHTML = '<option value="">×‘×—×¨ ×¨×›×‘...</option>';
            
            document.getElementById('appointmentModal').classList.remove('hidden');
            
            cars.forEach(car => {
                const option = document.createElement('option');
                option.value = car.id;
                option.textContent = `${car.plateNumber} - ${car.ownerName}`;
                if (currentCarId && car.id === currentCarId) {
                    option.selected = true;
                }
                carSelect.appendChild(option);
            });
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').value = today;
            miniSelectedDate = today;
            
            // Reset mini calendar to current month
            miniMonth = new Date().getMonth();
            miniYear = new Date().getFullYear();
            
            document.getElementById('appointmentModal').classList.remove('hidden');
            renderMiniCalendar();
            hideUIElements(); // Ø¥Ø®ÙØ§Ø¡ FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
        }

        // Close Appointment Modal
        function closeAppointmentModal() {
            document.getElementById('appointmentModal').classList.add('hidden');
            editingAppointmentId = null;
            showUIElements(); // Ø¥Ø¸Ù‡Ø§Ø± FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
        }

        // Previous Month for Mini Calendar
        function previousMonthMini() {
            miniMonth--;
            if (miniMonth < 0) {
                miniMonth = 11;
                miniYear--;
            }
            renderMiniCalendar();
        }

        // Next Month for Mini Calendar
        function nextMonthMini() {
            miniMonth++;
            if (miniMonth > 11) {
                miniMonth = 0;
                miniYear++;
            }
            renderMiniCalendar();
        }

        // Render Mini Calendar
        function renderMiniCalendar() {
            const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
            document.getElementById('miniMonthYear').textContent = `${monthNames[miniMonth]} ${miniYear}`;
            
            const firstDay = new Date(miniYear, miniMonth, 1).getDay();
            const daysInMonth = new Date(miniYear, miniMonth + 1, 0).getDate();
            
            const calendarGrid = document.getElementById('miniCalendarGrid');
            calendarGrid.innerHTML = '';
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'p-1';
                calendarGrid.appendChild(emptyCell);
            }
            
            // Add days of month
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${miniYear}-${String(miniMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayAppointments = appointments.filter(apt => apt.date === dateStr);
                
                const dayCell = document.createElement('div');
                
                // Build class name
                let className = 'p-1 text-center text-sm border rounded cursor-pointer hover:bg-blue-50';
                
                // Today gets purple border
                if (dateStr === todayStr) {
                    className += ' border-purple-500 bg-purple-50';
                }
                
                // Has appointments - show red dot
                if (dayAppointments.length > 0) {
                    className += ' font-bold text-red-600';
                }
                
                // Selected date
                if (dateStr === miniSelectedDate) {
                    className += ' bg-blue-200';
                }
                
                dayCell.className = className;
                dayCell.onclick = () => selectMiniDate(dateStr);
                
                // Add dot indicator for days with appointments
                if (dayAppointments.length > 0) {
                    dayCell.innerHTML = `
                        <div class="relative">
                            ${day}
                            <span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                        </div>
                    `;
                } else {
                    dayCell.innerHTML = `<div>${day}</div>`;
                }
                
                calendarGrid.appendChild(dayCell);
            }
            
            // Show appointments for selected date
            showMiniDayAppointments();
        }

        // Select date in mini calendar
        function selectMiniDate(dateStr) {
            miniSelectedDate = dateStr;
            document.getElementById('appointmentDate').value = dateStr;
            renderMiniCalendar();
        }

        // Show appointments for selected day in mini calendar
        function showMiniDayAppointments() {
            const container = document.getElementById('miniDayAppointments');
            
            if (!miniSelectedDate) {
                container.innerHTML = '<p class="text-gray-500 text-center py-2">×‘×—×¨ ×ª××¨×™×š</p>';
                return;
            }
            
            const date = new Date(miniSelectedDate);
            const dateFormatted = date.toLocaleDateString('he-IL', { day: 'numeric', month: 'long' });
            
            const dayAppointments = appointments.filter(apt => apt.date === miniSelectedDate).sort((a, b) => a.time.localeCompare(b.time));
            
            if (dayAppointments.length === 0) {
                container.innerHTML = `<p class="text-green-600 text-center py-2">âœ“ ${dateFormatted} - ×œ×œ× ×¤×’×™×©×•×ª</p>`;
                return;
            }
            
            container.innerHTML = `
                <div class="font-bold mb-2 text-red-600">âš ï¸ ×¤×’×™×©×•×ª ×‘-${dateFormatted}:</div>
                ${dayAppointments.map(apt => `
                    <div class="border-r-4 border-red-500 bg-red-50 p-2 mb-2 rounded">
                        <div class="font-bold">${apt.time} - ${apt.plateNumber}</div>
                        <div class="text-xs text-gray-600">${apt.type}</div>
                    </div>
                `).join('')}
            `;
        }

        // Listen to date changes in appointment form
        document.getElementById('appointmentDate').addEventListener('change', (e) => {
            miniSelectedDate = e.target.value;
            renderMiniCalendar();
        });

        // Save Appointment
        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const carId = document.getElementById('appointmentCar').value;
            const car = cars.find(c => c.id === carId);
            
            const appointmentData = {
                userId: currentUser.uid,
                carId: carId,
                plateNumber: car.plateNumber,
                ownerName: car.ownerName,
                phone: car.phone || '',
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                type: document.getElementById('appointmentType').value,
                notes: document.getElementById('appointmentNotes').value,
                reminder: document.getElementById('appointmentReminder').checked,
                status: 'scheduled',
                createdAt: new Date().toISOString()
            };
            
            try {
                if (editingAppointmentId) {
                    await db.collection('appointments').doc(editingAppointmentId).update(appointmentData);
                    console.log('Appointment updated:', editingAppointmentId);
                } else {
                    const docRef = await db.collection('appointments').add(appointmentData);
                    console.log('Appointment created:', docRef.id);
                }
                
                await loadAppointments();
                console.log('Appointments reloaded. Total:', appointments.length);
                closeAppointmentModal();
                
                // Refresh calendar if it's open
                const calendarModal = document.getElementById('calendarModal');
                if (calendarModal && !calendarModal.classList.contains('hidden')) {
                    renderCalendar();
                }
                
                // Send WhatsApp reminder if checked
                if (appointmentData.reminder && appointmentData.phone) {
                    sendAppointmentReminder(appointmentData);
                }
                
                alert('×”×¤×’×™×©×” × ×©××¨×” ×‘×”×¦×œ×—×”!');
            } catch (error) {
                console.error('Error saving appointment:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”×¤×’×™×©×”: ' + error.message);
            }
        });

        // Send WhatsApp Reminder
        function sendAppointmentReminder(appointment) {
            const phone = appointment.phone.replace(/^0/, '972');
            const date = new Date(appointment.date).toLocaleDateString('he-IL');
            const message = `×©×œ×•× ${appointment.ownerName},\n\n××–×›×™×¨×™× ×œ×š ×¢×œ ×¤×’×™×©×” ×‘××•×¡×š:\nğŸ“… ×ª××¨×™×š: ${date}\nâ° ×©×¢×”: ${appointment.time}\nğŸš— ×¨×›×‘: ${appointment.plateNumber}\nğŸ“‹ ×¡×•×’: ${appointment.type}\n\n× ×ª×¨××”!`;
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Previous Month
        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        // Next Month
        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        // Render Calendar
        function renderCalendar() {
            const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
            const dayNames = ['××³', '×‘×³', '×’×³', '×“×³', '×”×³', '×•×³', '×©×³'];
            document.getElementById('currentMonthYear').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.style.visibility = 'hidden';
                calendarGrid.appendChild(emptyCell);
            }
            
            // Add days of month
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayDate = new Date(currentYear, currentMonth, day);
                const dayOfWeek = dayNames[dayDate.getDay()];
                const dayAppointments = appointments.filter(apt => apt.date === dateStr);
                
                const dayCell = document.createElement('div');
                
                // Ø¥Ø¶Ø§ÙØ© classes Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
                let classes = [];
                
                if (dateStr === todayStr) {
                    classes.push('today');
                }
                
                if (dateStr === selectedDate) {
                    classes.push('selected');
                }
                
                if (dayAppointments.length > 0) {
                    classes.push('has-appointments');
                }
                
                dayCell.className = classes.join(' ');
                dayCell.onclick = () => selectDate(dateStr);
                
                dayCell.innerHTML = `
                    <span>${dayOfWeek}</span>
                    <span>${day}</span>
                `;
                
                calendarGrid.appendChild(dayCell);
            }
            
            // Show selected date or today's appointments by default
            if (!selectedDate) {
                selectDate(todayStr);
            } else {
                // Just update the display without changing selectedDate
                const date = new Date(selectedDate);
                const dateFormatted = date.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('selectedDayTitle').textContent = `×¤×’×™×©×•×ª ×œ×™×•× ${dateFormatted}`;
                
                const dayAppointments = appointments.filter(apt => apt.date === selectedDate).sort((a, b) => a.time.localeCompare(b.time));
                const container = document.getElementById('dayAppointments');
                
                if (dayAppointments.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">××™×Ÿ ×¤×’×™×©×•×ª ××ª×•×›× × ×•×ª ×œ×™×•× ×–×”</p>';
                } else {
                    container.innerHTML = dayAppointments.map(apt => `
                        <div class="border rounded-lg p-4 mb-3 bg-gray-50">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-bold text-lg">${apt.time} - ${apt.type}</div>
                                    <div class="text-gray-700">ğŸš— ${apt.plateNumber} - ${apt.ownerName}</div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editAppointment('${apt.id}')" class="text-blue-600 hover:text-blue-800">âœï¸</button>
                                    <button onclick="deleteAppointment('${apt.id}')" class="text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            ${apt.notes ? `<div class="text-sm text-gray-600 mt-2">ğŸ“ ${apt.notes}</div>` : ''}
                            ${apt.phone ? `<button onclick="sendAppointmentReminder(${JSON.stringify(apt).replace(/"/g, '&quot;')})" class="mt-2 text-sm text-green-600 hover:text-green-800">ğŸ“± ×©×œ×— ×ª×–×›×•×¨×ª ×•×•×˜×¡××¤</button>` : ''}
                        </div>
                    `).join('');
                }
            }
        }

        // Select Date
        function selectDate(dateStr) {
            selectedDate = dateStr;
            renderCalendar(); // Re-render to update the purple highlight
        }

        // Edit Appointment
        async function editAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;
            
            editingAppointmentId = appointmentId;
            
            document.getElementById('appointmentCar').value = appointment.carId;
            document.getElementById('appointmentDate').value = appointment.date;
            document.getElementById('appointmentTime').value = appointment.time;
            document.getElementById('appointmentType').value = appointment.type;
            document.getElementById('appointmentNotes').value = appointment.notes || '';
            document.getElementById('appointmentReminder').checked = appointment.reminder || false;
            
            document.getElementById('appointmentModal').classList.remove('hidden');
        }

        // Delete Appointment
        async function deleteAppointment(appointmentId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¤×’×™×©×” ×–×•?')) return;
            
            try {
                await db.collection('appointments').doc(appointmentId).delete();
                await loadAppointments();
                renderCalendar();
                alert('×”×¤×’×™×©×” × ××—×§×” ×‘×”×¦×œ×—×”');
            } catch (error) {
                console.error('Error deleting appointment:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×¤×’×™×©×”');
            }
        }

        // ==========================================
        // DASHBOARD FUNCTIONS
        // ==========================================

        // Open Dashboard
        function openDashboard() {
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
            const sidebar = document.getElementById('sidebar');
            if (sidebar && sidebar.classList.contains('open')) {
                toggleSidebar();
            }
            // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ modals Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹
            closeAllModals();
            // ÙØªØ­ Ù„ÙˆØ­ Ø§Ù„Ø¨ÙƒØ±Ø©
            document.getElementById('dashboardModal').classList.remove('hidden');
            renderDashboard();
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù†
            updateActiveNav(1);
            hideUIElements(); // Ø¥Ø®ÙØ§Ø¡ FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
        }

        // Close Dashboard
        function closeDashboard() {
            document.getElementById('dashboardModal').classList.add('hidden');
            showUIElements(); // Ø¥Ø¸Ù‡Ø§Ø± FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØª ÙÙŠ Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù†
            updateActiveNav(0);
        }

        // Render Dashboard
        function renderDashboard() {
            // Count cars by status - ONLY cars with explicit status
            const waiting = cars.filter(c => c.carStatus === 'waiting');
            const inProgress = cars.filter(c => c.carStatus === 'in_progress');
            const ready = cars.filter(c => c.carStatus === 'ready');
            const completed = cars.filter(c => c.carStatus === 'completed');
            
            // Update counters
            document.getElementById('waitingCount').textContent = waiting.length;
            document.getElementById('inProgressCount').textContent = inProgress.length;
            document.getElementById('readyCount').textContent = ready.length;
            document.getElementById('completedCount').textContent = completed.length;
            
            // Render columns
            renderDashboardColumn('waitingColumn', waiting, 'waiting');
            renderDashboardColumn('inProgressColumn', inProgress, 'in_progress');
            renderDashboardColumn('readyColumn', ready, 'ready');
            renderDashboardColumn('completedColumn', completed, 'completed');
        }

        // Render Dashboard Column
        function renderDashboardColumn(columnId, carsList, status) {
            const column = document.getElementById(columnId);
            
            if (carsList.length === 0) {
                column.innerHTML = '<p class="text-gray-400 text-center py-4 text-sm">××™×Ÿ ×¨×›×‘×™×</p>';
                return;
            }
            
            column.innerHTML = carsList.map(car => `
                <div class="bg-white rounded-lg p-3 shadow hover:shadow-md transition cursor-pointer border-r-4 ${getStatusColor(status)}" 
                     onclick="openCarDetailsModal('${car.id}')">
                    <div class="font-bold text-sm mb-1">${car.plateNumber}</div>
                    <div class="text-xs text-gray-600 mb-2">${car.ownerName || ''}</div>
                    ${car.carType || car.model ? `<div class="text-xs text-gray-500">${car.carType || ''} ${car.model || ''}</div>` : ''}
                    
                    <!-- Status Buttons -->
                    <div class="mt-2 flex gap-1 flex-wrap" onclick="event.stopPropagation()">
                        ${status !== 'waiting' ? `<button onclick="changeCarStatus('${car.id}', 'waiting')" class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded hover:bg-yellow-200" title="×”×¢×‘×¨ ×œ×××ª×™×Ÿ">â³</button>` : ''}
                        ${status !== 'in_progress' ? `<button onclick="changeCarStatus('${car.id}', 'in_progress')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200" title="×”×¢×‘×¨ ×œ×˜×™×¤×•×œ">ğŸ”§</button>` : ''}
                        ${status !== 'ready' ? `<button onclick="changeCarStatus('${car.id}', 'ready')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200" title="×¡××Ÿ ×›××•×›×Ÿ">âœ…</button>` : ''}
                        ${status !== 'completed' ? `<button onclick="changeCarStatus('${car.id}', 'completed')" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200" title="×¡××Ÿ ×›×”×•×©×œ×">ğŸ</button>` : ''}
                        <button onclick="removeCarFromDashboard('${car.id}')" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200" title="×”×¡×¨ ××œ×•×— ×”×‘×§×¨×”">âŒ</button>
                    </div>
                </div>
            `).join('');
        }

        // Get Status Color
        function getStatusColor(status) {
            const colors = {
                'waiting': 'border-yellow-500',
                'in_progress': 'border-blue-500',
                'ready': 'border-green-500',
                'completed': 'border-gray-500'
            };
            return colors[status] || 'border-gray-300';
        }

        // Change Car Status
        async function changeCarStatus(carId, newStatus) {
            try {
                // Get car data first
                const car = cars.find(c => c.id === carId);
                if (!car) {
                    alert('×©×’×™××”: ×¨×›×‘ ×œ× × ××¦×');
                    return;
                }
                
                // Update status in database
                await db.collection('cars').doc(carId).update({
                    carStatus: newStatus,
                    statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local cars array
                const carIndex = cars.findIndex(c => c.id === carId);
                if (carIndex !== -1) {
                    cars[carIndex].carStatus = newStatus;
                }
                
                // Update both dashboard and main grid
                renderDashboard();
                displayCars();
                
                // Show notification
                const statusNames = {
                    'waiting': '×××ª×™×Ÿ ×œ×˜×™×¤×•×œ',
                    'in_progress': '×‘×˜×™×¤×•×œ',
                    'ready': '××•×›×Ÿ ×œ××™×¡×•×£',
                    'completed': '×”×•×©×œ×'
                };
                
                showNotification(`${car.plateNumber} ×”×•×¢×‘×¨ ×œ: ${statusNames[newStatus]}`);
                
                // Send WhatsApp message based on status change
                if (car.phone) {
                    sendWhatsAppForStatus(car, newStatus);
                }
                
            } catch (error) {
                console.error('Error changing car status:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¡×˜×˜×•×¡');
            }
        }
        
        // Send WhatsApp message based on status
        function sendWhatsAppForStatus(car, status) {
            let message = '';
            const ownerName = car.ownerName || '×œ×§×•×— ×™×§×¨';
            const plateNumber = car.plateNumber;
            
            switch(status) {
                case 'in_progress':
                    message = `×©×œ×•× ${ownerName}, ×¨×›×‘×š ${plateNumber} × ×›× ×¡ ×œ×˜×™×¤×•×œ ×‘××•×¡×š ×©×œ× ×• ğŸ”§\n× ×¢×“×›×Ÿ ××•×ª×š ×›×©×™×”×™×” ××•×›×Ÿ ×œ××™×¡×•×£.`;
                    break;
                case 'ready':
                    message = `×©×œ×•× ${ownerName}, ×¨×›×‘×š ${plateNumber} ××•×›×Ÿ ×•××—×›×” ×œ××™×¡×•×£ âœ…\n× ×™×ª×Ÿ ×œ×‘×•× ×œ×§×—×ª ××ª ×”×¨×›×‘.`;
                    break;
                case 'completed':
                    message = `×©×œ×•× ${ownerName}, ×¨×›×‘×š ${plateNumber} × ××¡×¨ ×‘×”×¦×œ×—×” ğŸ‰\n×ª×•×“×” ×©×‘×—×¨×ª ×‘×©×™×¨×•×ª×™× ×•!`;
                    break;
                default:
                    // No message for 'waiting' status
                    return;
            }
            
            // Open WhatsApp with pre-filled message
            const phoneNumber = car.phone.replace(/^0/, '972');
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Show Notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification fixed top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-4 rounded-xl shadow-xl z-[100] font-semibold flex items-center gap-3';
            notification.innerHTML = `
                <span class="text-xl">âœ“</span>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -100%)';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Delete Car from Dashboard
        // Remove Car From Dashboard (only remove status, not delete car)
        async function removeCarFromDashboard(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            if (!confirm(`×”×× ×œ×”×¡×™×¨ ××ª ${car.plateNumber} ××œ×•×— ×”×‘×§×¨×”?`)) return;
            
            try {
                // Remove status from car in Firebase
                await db.collection('cars').doc(carId).update({
                    carStatus: firebase.firestore.FieldValue.delete(),
                    statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local cars array - set to undefined
                const carIndex = cars.findIndex(c => c.id === carId);
                if (carIndex !== -1) {
                    cars[carIndex].carStatus = undefined;
                }
                
                // Update both dashboard and main grid
                renderDashboard();
                displayCars();
                
                showNotification('×”×¨×›×‘ ×”×•×¡×¨ ××œ×•×— ×”×‘×§×¨×”');
                
            } catch (error) {
                console.error('Error removing car from dashboard:', error);
                alert('×©×’×™××” ×‘×”×¡×¨×ª ×”×¨×›×‘ ××œ×•×— ×”×‘×§×¨×”');
            }
        }

        // Add Car To Dashboard
        async function addCarToDashboard(carId) {
            try {
                // Add car to dashboard with 'waiting' status
                await db.collection('cars').doc(carId).update({
                    carStatus: 'waiting',
                    statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local cars array
                const carIndex = cars.findIndex(c => c.id === carId);
                if (carIndex !== -1) {
                    cars[carIndex].carStatus = 'waiting';
                }
                
                // Reload the main grid to show updated status
                displayCars();
                
                showNotification('×”×¨×›×‘ × ×•×¡×£ ×œ×œ×•×— ×”×‘×§×¨×”');
                
            } catch (error) {
                console.error('Error adding car to dashboard:', error);
                alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×¨×›×‘ ×œ×œ×•×— ×”×‘×§×¨×”');
            }
        }

        // ==========================================
        // SETTINGS FUNCTIONS
        // ==========================================

        // ==========================================
        // SPARE PARTS CONTACTS MANAGEMENT
        // ==========================================

        let sparePartsContacts = [];

        // Load Spare Parts Contacts
        async function loadSparePartsContacts() {
            try {
                const snapshot = await db.collection('sparePartsContacts')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                sparePartsContacts = [];
                snapshot.forEach(doc => {
                    sparePartsContacts.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
            } catch (error) {
                console.error('Error loading spare parts contacts:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”×¡×¤×§×™×: ' + error.message);
                sparePartsContacts = [];
            }
        }

        // Display Spare Parts Contacts List
        function displaySparePartsContacts() {
            const list = document.getElementById('sparePartsContactsList');
            
            if (sparePartsContacts.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">××™×Ÿ ×¡×¤×§×™× ×‘××¢×¨×›×ª. ×”×•×¡×£ ×¡×¤×§ ×—×“×© ××˜×”.</p>';
                return;
            }
            
            list.innerHTML = sparePartsContacts.map((contact, index) => `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-800">${contact.name}</p>
                        <p class="text-gray-600 text-sm">${contact.phone}</p>
                    </div>
                    <button onclick="removeSparePartsContact(${index})" 
                            class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">
                        ğŸ—‘ï¸ ××—×§
                    </button>
                </div>
            `).join('');
        }

        // Add New Spare Parts Contact
        async function addSparePartsContact() {
            const name = document.getElementById('newSupplierName').value.trim();
            const phone = document.getElementById('newSupplierPhone').value.trim();
            
            if (!name || !phone) {
                alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }
            
            try {
                await db.collection('sparePartsContacts').add({
                    userId: currentUser.uid,
                    name: name,
                    phone: phone,
                    createdAt: new Date().toISOString()
                });
                
                document.getElementById('newSupplierName').value = '';
                document.getElementById('newSupplierPhone').value = '';
                
                await loadSparePartsContacts();
                displaySparePartsContacts();
                showNotification('×”×¡×¤×§ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
            } catch (error) {
                console.error('Error saving contact:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”×¡×¤×§: ' + error.message);
            }
        }

        // Remove Spare Parts Contact
        async function removeSparePartsContact(index) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¡×¤×§ ×–×”?')) {
                return;
            }
            
            const contact = sparePartsContacts[index];
            
            try {
                await db.collection('sparePartsContacts').doc(contact.id).delete();
                
                await loadSparePartsContacts();
                displaySparePartsContacts();
                showNotification('×”×¡×¤×§ × ××—×§ ×‘×”×¦×œ×—×”!');
            } catch (error) {
                console.error('Error removing contact:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×¡×¤×§: ' + error.message);
            }
        }

        // Open Settings (Spare Parts Contacts)
        async function openSettings() {
            await loadSparePartsContacts();
            displaySparePartsContacts();
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        // Close Settings
        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // Order Spare Part with Supplier Selection and Engine Size
        async function orderSparePart(carId) {
            await loadSparePartsContacts();
            
            if (sparePartsContacts.length === 0) {
                alert('×× × ×”×•×¡×£ ×¡×¤×§ ×—×œ×¤×™× ×‘××¡×¤×¨×™ ×—×œ×§×™ ×—×™×œ×•×£');
                openSettings();
                return;
            }
            
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            // Create supplier selection HTML
            const supplierOptions = sparePartsContacts.map((contact, index) => 
                `<option value="${index}">${contact.name} - ${contact.phone}</option>`
            ).join('');
            
            // Show modal to select supplier and enter part details
            const modalHTML = `
                <div id="orderPartModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full">
                        <div class="bg-green-600 text-white p-6 rounded-t-lg">
                            <h2 class="text-2xl font-bold">ğŸ›’ ×”×–×× ×ª ×—×œ×§ ×—×™×œ×•×£</h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div>
                                <p class="font-bold">×¨×›×‘: ${car.plateNumber}</p>
                                <p class="text-sm text-gray-600">${car.carType || ''} ${car.model || ''} ${car.year || ''}</p>
                                ${car.enginePower ? `<p class="text-sm text-gray-600">×× ×•×¢: ${car.enginePower}</p>` : ''}
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-bold mb-2">×‘×—×¨ ×¡×¤×§</label>
                                <select id="supplierSelect" class="w-full px-4 py-2 border rounded-lg">
                                    ${supplierOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-bold mb-2">×©× ×”×—×œ×§</label>
                                <input type="text" id="partName" 
                                       class="w-full px-4 py-2 border rounded-lg"
                                       placeholder="×œ×“×•×’××”: ××¡× ×Ÿ ×©××Ÿ, ×‘×œ××™×">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™× (××•×¤×¦×™×•× ×œ×™)</label>
                                <textarea id="partDetails" rows="3"
                                          class="w-full px-4 py-2 border rounded-lg"
                                          placeholder="××¡×¤×¨ ×§×˜×œ×•×’×™, ×›××•×ª, ×”×¢×¨×•×ª..."></textarea>
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="sendSparePartOrder('${carId}')" 
                                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-bold">
                                    ğŸ“¤ ×©×œ×— ×”×–×× ×”
                                </button>
                                <button onclick="closeOrderPartModal()" 
                                        class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 font-bold">
                                    ×‘×™×˜×•×œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Send Spare Part Order via WhatsApp
        function sendSparePartOrder(carId) {
            const supplierIndex = document.getElementById('supplierSelect').value;
            const partName = document.getElementById('partName').value.trim();
            const partDetails = document.getElementById('partDetails').value.trim();
            
            if (!partName) {
                alert('× × ×œ×”×–×™×Ÿ ×©× ×—×œ×§');
                return;
            }
            
            const supplier = sparePartsContacts[supplierIndex];
            const car = cars.find(c => c.id === carId);
            
            if (!supplier || !car) return;
            
            // Build WhatsApp message with engine size
            let message = `×©×œ×•× ${supplier.name},\n\n`;
            message += `×× ×™ ××¢×•× ×™×™×Ÿ ×œ×”×–××™×Ÿ ×—×œ×§ ×—×™×œ×•×£:\n\n`;
            message += `ğŸ“‹ *×¤×¨×˜×™ ×”×¨×›×‘:*\n`;
            if (car.carType) message += `×¡×•×’ ×¨×›×‘: ${car.carType}\n`;
            if (car.model) message += `×“×’×: ${car.model}\n`;
            if (car.year) message += `×©× ×”: ${car.year}\n`;
            if (car.enginePower) message += `ğŸ”§ ×× ×•×¢: ${car.enginePower}\n`;
            message += `\nğŸ› ï¸ *×”×—×œ×§ ×”××‘×•×§×©:*\n`;
            message += `${partName}\n`;
            if (partDetails) {
                message += `\n×¤×¨×˜×™× × ×•×¡×¤×™×:\n${partDetails}\n`;
            }
            message += `\n×ª×•×“×”!`;
            
            const cleanPhone = supplier.phone.replace(/\D/g, '');
            const phoneWithCode = cleanPhone.startsWith('972') ? cleanPhone : '972' + cleanPhone.replace(/^0/, '');
            
            const whatsappUrl = `https://wa.me/${phoneWithCode}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            closeOrderPartModal();
        }

        // Close Order Part Modal

        // Order Spare Part From Maintenance Record (with pre-filled part name)
        async function orderSparePartFromMaintenance(carId, partName, workDescription) {
            await loadSparePartsContacts();
            
            if (sparePartsContacts.length === 0) {
                alert('×× × ×”×•×¡×£ ×¡×¤×§ ×—×œ×¤×™× ×‘××¡×¤×¨×™ ×—×œ×§×™ ×—×™×œ×•×£');
                openSettings();
                return;
            }
            
            const car = cars.find(c => c.id === carId);
            if (!car) return;
            
            // Create supplier selection HTML
            const supplierOptions = sparePartsContacts.map((contact, index) => 
                `<option value="${index}">${contact.name} - ${contact.phone}</option>`
            ).join('');
            
            // Show simplified modal - only supplier selection
            const modalHTML = `
                <div id="orderPartModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full">
                        <div class="bg-green-600 text-white p-6 rounded-t-lg">
                            <h2 class="text-2xl font-bold">ğŸ›’ ×”×–×× ×ª ×—×œ×§ ×—×™×œ×•×£</h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                <p class="font-bold text-lg mb-2">×¨×›×‘: ${car.plateNumber}</p>
                                <p class="text-sm text-gray-600">${car.carType || ''} ${car.model || ''} ${car.year || ''}</p>
                                ${car.enginePower ? `<p class="text-sm text-gray-600">×× ×•×¢: ${car.enginePower}</p>` : ''}
                                ${partName ? `
                                    <div class="mt-3 pt-3 border-t border-blue-300">
                                        <p class="font-bold text-green-700">ğŸ› ï¸ ×”×—×œ×§: ${partName}</p>
                                        ${workDescription ? `<p class="text-sm text-gray-600 mt-1">${workDescription}</p>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-bold mb-2 text-lg">×××™×–×” ×¡×¤×§ ×ª×¨×¦×” ×œ×”×–××™×Ÿ?</label>
                                <select id="supplierSelect" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg font-semibold">
                                    ${supplierOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™× (××•×¤×¦×™×•× ×œ×™)</label>
                                <textarea id="partDetails" rows="3"
                                          class="w-full px-4 py-2 border rounded-lg"
                                          placeholder="××¡×¤×¨ ×§×˜×œ×•×’×™, ×›××•×ª, ×”×¢×¨×•×ª..."></textarea>
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="sendSparePartOrderSimple('${carId}', '${partName.replace(/'/g, "\\'")}', '${workDescription.replace(/'/g, "\\'")}')" 
                                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-bold text-lg">
                                    ğŸ“¤ ×©×œ×— ×”×–×× ×”
                                </button>
                                <button onclick="closeOrderPartModal()" 
                                        class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 font-bold">
                                    ×‘×™×˜×•×œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Send Order with Pre-filled Part Info
        function sendSparePartOrderSimple(carId, partName, workDescription) {
            const supplierIndex = document.getElementById('supplierSelect').value;
            const partDetails = document.getElementById('partDetails').value.trim();
            
            const supplier = sparePartsContacts[supplierIndex];
            const car = cars.find(c => c.id === carId);
            
            if (!supplier || !car) return;
            
            // Build WhatsApp message
            let message = `×©×œ×•× ${supplier.name},\n\n`;
            message += `×× ×™ ××¢×•× ×™×™×Ÿ ×œ×”×–××™×Ÿ ×—×œ×§ ×—×™×œ×•×£:\n\n`;
            message += `ğŸ“‹ *×¤×¨×˜×™ ×”×¨×›×‘:*\n`;
            if (car.carType) message += `×¡×•×’ ×¨×›×‘: ${car.carType}\n`;
            if (car.model) message += `×“×’×: ${car.model}\n`;
            if (car.year) message += `×©× ×”: ${car.year}\n`;
            if (car.enginePower) message += `ğŸ”§ ×× ×•×¢: ${car.enginePower}\n`;
            message += `\nğŸ› ï¸ *×”×—×œ×§ ×”××‘×•×§×©:*\n`;
            message += `${partName}\n`;
            if (workDescription) {
                message += `\n×ª×™××•×¨: ${workDescription}\n`;
            }
            if (partDetails) {
                message += `\n×¤×¨×˜×™× × ×•×¡×¤×™×:\n${partDetails}\n`;
            }
            message += `\n×ª×•×“×”!`;
            
            const cleanPhone = supplier.phone.replace(/\D/g, '');
            const phoneWithCode = cleanPhone.startsWith('972') ? cleanPhone : '972' + cleanPhone.replace(/^0/, '');
            
            const whatsappUrl = `https://wa.me/${phoneWithCode}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            closeOrderPartModal();
        }

        function closeOrderPartModal() {
            const modal = document.getElementById('orderPartModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show Notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }


        // ==========================================
        // BACKUP & RESTORE FUNCTIONS
        // ==========================================

        // Open Backup Modal
        function openBackupModal() {
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
            const sidebar = document.getElementById('sidebar');
            if (sidebar && sidebar.classList.contains('open')) {
                toggleSidebar();
            }
            // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ modals Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹
            closeAllModals();
            
            // Ù…Ù†Ø¹ Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ù€ body Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
            document.body.classList.add('modal-open');
            
            // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            document.getElementById('backupModal').classList.remove('hidden');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø´ÙƒÙ„ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù† Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
            setTimeout(() => {
                try {
                    updateBackupInfo();
                } catch (e) {
                    console.error('Error updating backup info:', e);
                }
            }, 100);
            
            setTimeout(() => {
                try {
                    updateAutoBackupInfo();
                } catch (e) {
                    console.error('Error updating auto backup info:', e);
                }
            }, 200);
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù†
            updateActiveNav(3);
            hideUIElements(); // Ø¥Ø®ÙØ§Ø¡ FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
        }

        // Close Backup Modal
        function closeBackupModal() {
            const modal = document.getElementById('backupModal');
            const contentDiv = document.getElementById('backupModalContent');
            
            // Restore original content if it was changed
            if (window.backupModalOriginalContent && contentDiv) {
                contentDiv.innerHTML = window.backupModalOriginalContent;
                console.log('âœ… Content restored to original');
            }
            
            modal.classList.add('hidden');
            // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ù€ body Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
            document.body.classList.remove('modal-open');
            showUIElements(); // Ø¥Ø¸Ù‡Ø§Ø± FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØª ÙÙŠ Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù†
            updateActiveNav(0);
        }

        // Update Backup Info
        async function updateBackupInfo() {
            try {
                // Check if elements exist (modal might be closed)
                const totalDataElement = document.getElementById('totalDataCount');
                const lastBackupElement = document.getElementById('lastBackupDate');
                
                if (!totalDataElement || !lastBackupElement) {
                    console.log('Backup info elements not found - modal might be closed');
                    return;
                }
                
                const totalCars = cars.length;
                
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('userId', '==', currentUser.uid)
                    .get();
                const totalMaintenance = maintenanceSnapshot.size;
                
                const appointmentsSnapshot = await db.collection('appointments')
                    .where('userId', '==', currentUser.uid)
                    .get();
                const totalAppointments = appointmentsSnapshot.size;
                
                totalDataElement.textContent = 
                    `${totalCars} ×¨×›×‘×™×, ${totalMaintenance} ×˜×™×¤×•×œ×™×, ${totalAppointments} ×¤×’×™×©×•×ª`;
                
                // Get last backup date from localStorage
                const lastBackup = localStorage.getItem('lastBackupDate');
                if (lastBackup) {
                    lastBackupElement.textContent = 
                        new Date(lastBackup).toLocaleString('he-IL');
                } else {
                    lastBackupElement.textContent = '-';
                }
                
            } catch (error) {
                console.error('Error updating backup info:', error);
            }
        }

        // Create Backup (without images)
        async function createBackup() {
            try {
                showBackupProgress(true);
                updateBackupProgress(10, '××•×¡×£ × ×ª×•× ×™×...');
                
                // Collect all data
                const backupData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    cars: [],
                    maintenance: [],
                    appointments: [],
                    settings: {}
                };
                
                updateBackupProgress(30, '××™×™×¦× ×¨×›×‘×™×...');
                // Get cars (without images)
                backupData.cars = cars.map(car => ({
                    ...car,
                    imageUrl: null // Remove images to keep backup small
                }));
                
                updateBackupProgress(50, '××™×™×¦× ×˜×™×¤×•×œ×™×...');
                // Get maintenance (without images)
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                maintenanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    backupData.maintenance.push({
                        id: doc.id,
                        ...data,
                        images: [], // Remove images
                        createdAt: safeToMillis(data.createdAt),
                        updatedAt: safeToMillis(data.updatedAt)
                    });
                });
                
                updateBackupProgress(70, '××™×™×¦× ×¤×’×™×©×•×ª...');
                // Get appointments
                const appointmentsSnapshot = await db.collection('appointments')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                appointmentsSnapshot.forEach(doc => {
                    const data = doc.data();
                    backupData.appointments.push({
                        id: doc.id,
                        ...data,
                        createdAt: safeToMillis(data.createdAt)
                    });
                });
                
                updateBackupProgress(90, '×©×•××¨ ×§×•×‘×¥...');
                // Get settings
                const settingsDoc = await db.collection('settings').doc(currentUser.uid).get();
                if (settingsDoc.exists) {
                    backupData.settings = settingsDoc.data();
                }
                
                // Create and download file
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `garage-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                // Save last backup date
                localStorage.setItem('lastBackupDate', new Date().toISOString());
                
                updateBackupProgress(100, '×”×’×™×‘×•×™ ×”×•×©×œ×!');
                setTimeout(() => {
                    showBackupProgress(false);
                    showNotification('×”×’×™×‘×•×™ × ×•×¦×¨ ×‘×”×¦×œ×—×”!');
                    updateBackupInfo();
                }, 1000);
                
            } catch (error) {
                console.error('Error creating backup:', error);
                alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×‘×•×™: ' + error.message);
                showBackupProgress(false);
            }
        }

        // Create Backup with Images
        async function createBackupWithImages() {
            if (!confirm('×’×™×‘×•×™ ×¢× ×ª××•× ×•×ª ×¢×©×•×™ ×œ×”×™×•×ª ×§×•×‘×¥ ×’×“×•×œ ×××•×“. ×œ×”××©×™×š?')) return;
            
            try {
                showBackupProgress(true);
                updateBackupProgress(10, '××•×¡×£ × ×ª×•× ×™×...');
                
                // Same as createBackup but include images
                const backupData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    cars: [],
                    maintenance: [],
                    appointments: [],
                    settings: {}
                };
                
                updateBackupProgress(30, '××™×™×¦× ×¨×›×‘×™× ×¢× ×ª××•× ×•×ª...');
                backupData.cars = [...cars]; // Include images
                
                updateBackupProgress(50, '××™×™×¦× ×˜×™×¤×•×œ×™× ×¢× ×ª××•× ×•×ª...');
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                maintenanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    backupData.maintenance.push({
                        id: doc.id,
                        ...data,
                        createdAt: safeToMillis(data.createdAt),
                        updatedAt: safeToMillis(data.updatedAt)
                    });
                });
                
                updateBackupProgress(70, '××™×™×¦× ×¤×’×™×©×•×ª...');
                const appointmentsSnapshot = await db.collection('appointments')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                appointmentsSnapshot.forEach(doc => {
                    const data = doc.data();
                    backupData.appointments.push({
                        id: doc.id,
                        ...data,
                        createdAt: safeToMillis(data.createdAt)
                    });
                });
                
                updateBackupProgress(90, '×©×•××¨ ×§×•×‘×¥...');
                const settingsDoc = await db.collection('settings').doc(currentUser.uid).get();
                if (settingsDoc.exists) {
                    backupData.settings = settingsDoc.data();
                }
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `garage-backup-full-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                localStorage.setItem('lastBackupDate', new Date().toISOString());
                
                updateBackupProgress(100, '×”×’×™×‘×•×™ ×”×•×©×œ×!');
                setTimeout(() => {
                    showBackupProgress(false);
                    showNotification('×”×’×™×‘×•×™ × ×•×¦×¨ ×‘×”×¦×œ×—×”!');
                    updateBackupInfo();
                }, 1000);
                
            } catch (error) {
                console.error('Error creating backup with images:', error);
                alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×‘×•×™: ' + error.message);
                showBackupProgress(false);
            }
        }

        // Show/Hide Backup Progress
        function showBackupProgress(show) {
            const progress = document.getElementById('backupProgress');
            if (!progress) {
                console.warn('Backup progress element not found');
                return;
            }
            if (show) {
                progress.classList.remove('hidden');
            } else {
                progress.classList.add('hidden');
                updateBackupProgress(0, '');
            }
        }

        // Update Backup Progress
        function updateBackupProgress(percent, text) {
            const progressBar = document.getElementById('backupProgressBar');
            const progressText = document.getElementById('backupProgressText');
            
            if (!progressBar || !progressText) {
                console.warn('Progress elements not found');
                return;
            }
            
            progressBar.style.width = percent + '%';
            progressText.textContent = text;
        }

        // Handle Restore File
        async function handleRestoreFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if user is authenticated
            if (!currentUser) {
                alert('âŒ ×©×’×™××”: × × ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×”');
                event.target.value = '';
                return;
            }
            
            if (!confirm('âš ï¸ ×”×× ××ª×” ×‘×˜×•×—? ×–×” ×™××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ×•×™×©×—×–×¨ ××ª ×”×’×™×‘×•×™!')) {
                event.target.value = '';
                return;
            }
            
            // Ensure backup modal is open
            const backupModal = document.getElementById('backupModal');
            if (backupModal && backupModal.classList.contains('hidden')) {
                openBackupModal();
                // Wait for modal to render
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            try {
                showBackupProgress(true);
                updateBackupProgress(5, '×§×•×¨× ×§×•×‘×¥...');
                
                const text = await file.text();
                const backupData = JSON.parse(text);
                
                // Validate backup
                if (!backupData.version || !backupData.cars) {
                    throw new Error('×§×•×‘×¥ ×’×™×‘×•×™ ×œ× ×ª×§×™×Ÿ - ×—×¡×¨ ××™×“×¢ ×—×™×•× ×™');
                }
                
                // Validate userId matches
                if (backupData.cars.length > 0 && backupData.cars[0].userId !== currentUser.uid) {
                    if (!confirm('âš ï¸ ×”×’×™×‘×•×™ ×œ× ×©×™×™×š ×œ××©×ª××© ×”× ×•×›×—×™. ×œ×”××©×™×š ×‘×›×œ ×–××ª?')) {
                        throw new Error('×”×’×™×‘×•×™ ×‘×•×˜×œ');
                    }
                }
                
                updateBackupProgress(10, '××•×—×§ × ×ª×•× ×™× ×™×©× ×™×...');
                
                try {
                    // Delete existing data with better error handling
                    await deleteAllUserData();
                } catch (deleteError) {
                    console.warn('Warning during delete:', deleteError);
                    // Continue even if delete partially fails
                }
                
                updateBackupProgress(30, '××©×—×–×¨ ×¨×›×‘×™×...');
                // Restore cars with userId fix and create mapping
                let carsRestored = 0;
                const plateToCarIdMap = {}; // Map old plate numbers to new car IDs
                
                for (const car of backupData.cars) {
                    try {
                        const carData = { ...car };
                        const oldPlate = carData.plateNumber;
                        delete carData.id;
                        // Ensure userId is set correctly
                        carData.userId = currentUser.uid;
                        carData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        
                        const docRef = await db.collection('cars').add(carData);
                        plateToCarIdMap[oldPlate] = docRef.id; // Store mapping
                        console.log(`ğŸš— Car added: ${oldPlate} -> ${docRef.id}`);
                        carsRestored++;
                    } catch (carError) {
                        console.error('Error restoring car:', carError);
                    }
                }
                
                updateBackupProgress(50, `××©×—×–×¨ ×˜×™×¤×•×œ×™×... (${carsRestored} ×¨×›×‘×™×)` );
                // Restore maintenance with correct carId
                let maintenanceRestored = 0;
                console.log('ğŸ“‹ Plate to CarId Map:', plateToCarIdMap);
                
                for (const maintenance of backupData.maintenance) {
                    try {
                        const maintenanceData = { ...maintenance };
                        delete maintenanceData.id;
                        
                        // Map to new carId using plate number
                        const newCarId = plateToCarIdMap[maintenanceData.plateNumber];
                        console.log(`ğŸ”§ Maintenance: ${maintenanceData.plateNumber} -> ${newCarId}`);
                        
                        if (newCarId) {
                            maintenanceData.carId = newCarId;
                        } else {
                            console.warn(`âš ï¸ No carId found for plate: ${maintenanceData.plateNumber}`);
                        }
                        
                        // Ensure userId is set correctly
                        maintenanceData.userId = currentUser.uid;
                        
                        // Convert timestamps back
                        if (maintenanceData.createdAt) {
                            if (typeof maintenanceData.createdAt === 'number') {
                                maintenanceData.createdAt = firebase.firestore.Timestamp.fromMillis(maintenanceData.createdAt);
                            }
                        } else {
                            maintenanceData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        }
                        
                        if (maintenanceData.updatedAt) {
                            if (typeof maintenanceData.updatedAt === 'number') {
                                maintenanceData.updatedAt = firebase.firestore.Timestamp.fromMillis(maintenanceData.updatedAt);
                            }
                        } else {
                            maintenanceData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        }
                        
                        await db.collection('maintenance').add(maintenanceData);
                        maintenanceRestored++;
                    } catch (maintenanceError) {
                        console.error('Error restoring maintenance:', maintenanceError);
                    }
                }
                
                updateBackupProgress(70, `××©×—×–×¨ ×¤×’×™×©×•×ª... (${maintenanceRestored} ×˜×™×¤×•×œ×™×)`);
                // Restore appointments with correct carId
                let appointmentsRestored = 0;
                for (const appointment of backupData.appointments) {
                    try {
                        const appointmentData = { ...appointment };
                        delete appointmentData.id;
                        
                        // Map to new carId using plate number
                        const newCarId = plateToCarIdMap[appointmentData.plateNumber];
                        console.log(`ğŸ“… Appointment: ${appointmentData.plateNumber} -> ${newCarId}`);
                        
                        if (newCarId) {
                            appointmentData.carId = newCarId;
                        } else {
                            console.warn(`âš ï¸ No carId found for plate: ${appointmentData.plateNumber}`);
                        }
                        
                        // Ensure userId is set correctly
                        appointmentData.userId = currentUser.uid;
                        
                        if (appointmentData.createdAt) {
                            if (typeof appointmentData.createdAt === 'number') {
                                appointmentData.createdAt = firebase.firestore.Timestamp.fromMillis(appointmentData.createdAt);
                            }
                        } else {
                            appointmentData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        }
                        
                        await db.collection('appointments').add(appointmentData);
                        appointmentsRestored++;
                    } catch (appointmentError) {
                        console.error('Error restoring appointment:', appointmentError);
                    }
                }
                
                updateBackupProgress(90, `××©×—×–×¨ ×”×’×“×¨×•×ª... (${appointmentsRestored} ×¤×’×™×©×•×ª)`);
                // Restore settings
                if (backupData.settings) {
                    try {
                        await db.collection('settings').doc(currentUser.uid).set(backupData.settings, { merge: true });
                    } catch (settingsError) {
                        console.error('Error restoring settings:', settingsError);
                    }
                }
                
                updateBackupProgress(100, 'âœ… ×”×©×—×–×•×¨ ×”×•×©×œ×!');
                setTimeout(() => {
                    showBackupProgress(false);
                    alert(`âœ… ×”×©×—×–×•×¨ ×”×•×©×œ× ×‘×”×¦×œ×—×”!

ğŸ“Š ×¡×™×›×•×:
â€¢ ${carsRestored} ×¨×›×‘×™×
â€¢ ${maintenanceRestored} ×˜×™×¤×•×œ×™×
â€¢ ${appointmentsRestored} ×¤×’×™×©×•×ª

×”×“×£ ×™×ª×¨×¢× ×Ÿ ×›×¢×ª.`);
                    window.location.reload();
                }, 1500);
                
            } catch (error) {
                console.error('Error restoring backup:', error);
                showBackupProgress(false);
                
                let errorMsg = '×©×’×™××” ×‘×©×—×–×•×¨ ×’×™×‘×•×™';
                if (error.code === 'permission-denied') {
                    errorMsg = 'âŒ ×©×’×™××ª ×”×¨×©××•×ª: ××™×Ÿ ×œ×š ×”×¨×©××” ×œ×’×©×ª ×œ× ×ª×•× ×™× ××œ×”.\n\n×™×™×ª×›×Ÿ ×©×”×‘×¢×™×” ×”×™×:\nâ€¢ ×œ× ××—×•×‘×¨ ×›××©×ª××© ×”× ×›×•×Ÿ\nâ€¢ ×”×’×™×‘×•×™ ×©×™×™×š ×œ××©×ª××© ××—×¨\nâ€¢ ×‘×¢×™×™×ª ×”×¨×©××•×ª ×‘-Firebase';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                alert(errorMsg);
            }
            
            event.target.value = '';
        }

        // Delete All User Data
        async function deleteAllUserData() {
            if (!currentUser) {
                throw new Error('No user authenticated');
            }
            
            const deletePromises = [];
            
            try {
                // Delete cars
                const carsSnapshot = await db.collection('cars')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                carsSnapshot.forEach(doc => {
                    deletePromises.push(
                        db.collection('cars').doc(doc.id).delete()
                            .catch(err => console.warn('Failed to delete car:', doc.id, err))
                    );
                });
            } catch (error) {
                console.error('Error querying cars:', error);
            }
            
            try {
                // Delete maintenance
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                maintenanceSnapshot.forEach(doc => {
                    deletePromises.push(
                        db.collection('maintenance').doc(doc.id).delete()
                            .catch(err => console.warn('Failed to delete maintenance:', doc.id, err))
                    );
                });
            } catch (error) {
                console.error('Error querying maintenance:', error);
            }
            
            try {
                // Delete appointments
                const appointmentsSnapshot = await db.collection('appointments')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                appointmentsSnapshot.forEach(doc => {
                    deletePromises.push(
                        db.collection('appointments').doc(doc.id).delete()
                            .catch(err => console.warn('Failed to delete appointment:', doc.id, err))
                    );
                });
            } catch (error) {
                console.error('Error querying appointments:', error);
            }
            
            // Wait for all deletions to complete (or fail)
            await Promise.allSettled(deletePromises);
        }

        // ==========================================
        // AUTOMATIC BACKUP SYSTEM - PROFESSIONAL
        // ==========================================
        
        // Simple encryption/decryption (for backup security) - UTF-8 Compatible
        function encryptData(data, password) {
            const jsonStr = JSON.stringify(data);
            // Convert to UTF-8 bytes first
            const utf8Bytes = new TextEncoder().encode(jsonStr);
            let encrypted = '';
            for (let i = 0; i < utf8Bytes.length; i++) {
                encrypted += String.fromCharCode(utf8Bytes[i] ^ password.charCodeAt(i % password.length));
            }
            // Use base64 encoding that works with all characters
            return btoa(unescape(encodeURIComponent(encrypted)));
        }
        
        function decryptData(encrypted, password) {
            // Decode from base64
            const decoded = decodeURIComponent(escape(atob(encrypted)));
            let decryptedBytes = [];
            for (let i = 0; i < decoded.length; i++) {
                decryptedBytes.push(decoded.charCodeAt(i) ^ password.charCodeAt(i % password.length));
            }
            // Convert bytes back to UTF-8 string
            const decrypted = new TextDecoder().decode(new Uint8Array(decryptedBytes));
            return JSON.parse(decrypted);
        }
        
        // Compress data (simple compression)
        function compressBackup(data) {
            const jsonStr = JSON.stringify(data);
            // Remove unnecessary whitespace
            return jsonStr.replace(/\s+/g, ' ');
        }
        
        // Auto backup configuration
        const AUTO_BACKUP_CONFIG = {
            enabled: true,
            dayOfWeek: 5, // Friday (0=Sunday, 5=Friday)
            hour: 23, // 11 PM
            minute: 0,
            encryptionEnabled: true
        };
        
        // Get user's encryption password
        function getBackupPassword() {
            const saved = localStorage.getItem('backupPassword');
            if (saved) return saved;
            
            const password = prompt('ğŸ”’ ×”×’×“×¨ ×¡×™×¡××ª ×”×¦×¤× ×” ×œ×’×™×‘×•×™ (×–×›×•×¨ ××•×ª×”!)');
            if (password && password.length >= 4) {
                localStorage.setItem('backupPassword', password);
                return password;
            }
            return null;
        }
        
        // Save backup to IndexedDB with proper version handling
        async function saveBackupLocally(backupData) {
            if (!currentUser) {
                console.error('No user logged in');
                return;
            }
            
            const dbName = `DRVN_Backups_${currentUser.uid}`;
            
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                
                request.onerror = () => {
                    console.error('IndexedDB error:', request.error);
                    reject(request.error);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('backups')) {
                        const objectStore = db.createObjectStore('backups', { keyPath: 'id' });
                        objectStore.createIndex('date', 'date', { unique: false });
                    }
                };
                
                request.onsuccess = async (event) => {
                    const db = event.target.result;
                    
                    try {
                        // First, get all existing backups
                        const getAllTransaction = db.transaction(['backups'], 'readonly');
                        const getAllStore = getAllTransaction.objectStore('backups');
                        const getAllRequest = getAllStore.getAll();
                        
                        getAllRequest.onsuccess = () => {
                            const allBackups = getAllRequest.result;
                            
                            // Sort by date (newest first)
                            allBackups.sort((a, b) => new Date(b.date) - new Date(a.date));
                            
                            // If we have 4 or more backups, delete the oldest ones
                            if (allBackups.length >= 4) {
                                const transaction = db.transaction(['backups'], 'readwrite');
                                const store = transaction.objectStore('backups');
                                
                                // Keep only the 3 newest, delete the rest
                                for (let i = 3; i < allBackups.length; i++) {
                                    store.delete(allBackups[i].id);
                                }
                                
                                transaction.oncomplete = () => {
                                    // Now add the new backup
                                    addNewBackup(db, backupData, resolve, reject);
                                };
                                
                                transaction.onerror = () => {
                                    // Even if deletion fails, try to add new backup
                                    addNewBackup(db, backupData, resolve, reject);
                                };
                            } else {
                                // Less than 4 backups, just add the new one
                                addNewBackup(db, backupData, resolve, reject);
                            }
                        };
                        
                        getAllRequest.onerror = () => {
                            // If getting fails, just add the new backup
                            addNewBackup(db, backupData, resolve, reject);
                        };
                        
                    } catch (error) {
                        db.close();
                        reject(error);
                    }
                };
                
                function addNewBackup(db, backupData, resolve, reject) {
                    try {
                        const transaction = db.transaction(['backups'], 'readwrite');
                        const store = transaction.objectStore('backups');
                        
                        const backup = {
                            id: Date.now(),
                            date: new Date().toISOString(),
                            data: backupData,
                            size: JSON.stringify(backupData).length,
                            carsCount: backupData.cars ? backupData.cars.length : 0,
                            maintenanceCount: backupData.maintenance ? backupData.maintenance.length : 0,
                            userId: currentUser.uid // Add userId
                        };
                        
                        const addRequest = store.add(backup);
                        
                        addRequest.onsuccess = () => {
                            db.close();
                            console.log(`âœ… Backup saved for user ${currentUser.uid}. Total backups: up to 4`);
                            resolve(backup);
                        };
                        
                        addRequest.onerror = () => {
                            db.close();
                            reject(addRequest.error);
                        };
                        
                        transaction.onerror = () => {
                            db.close();
                            reject(transaction.error);
                        };
                    } catch (error) {
                        db.close();
                        reject(error);
                    }
                }
            });
        }
        
        // Clean old backups (keep only last 4)
        // Get all saved backups with proper error handling
        async function getSavedBackups() {
            if (!currentUser) {
                console.warn('No user logged in');
                return [];
            }
            
            const dbName = `DRVN_Backups_${currentUser.uid}`;
            
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                
                request.onerror = () => {
                    console.error('Error opening database:', request.error);
                    resolve([]); // Return empty array on error
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('backups')) {
                        const objectStore = db.createObjectStore('backups', { keyPath: 'id' });
                        objectStore.createIndex('date', 'date', { unique: false });
                    }
                };
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('backups')) {
                        db.close();
                        resolve([]);
                        return;
                    }
                    
                    try {
                        const transaction = db.transaction(['backups'], 'readonly');
                        const store = transaction.objectStore('backups');
                        const getAllRequest = store.getAll();
                        
                        getAllRequest.onsuccess = () => {
                            const backups = getAllRequest.result || [];
                            backups.sort((a, b) => new Date(b.date) - new Date(a.date));
                            db.close();
                            resolve(backups);
                        };
                        
                        getAllRequest.onerror = () => {
                            db.close();
                            resolve([]);
                        };
                    } catch (error) {
                        db.close();
                        resolve([]);
                    }
                };
            });
        }
        
        // Create automatic backup (simplified with localStorage fallback)
        async function createAutoBackup(isManual = false) {
            try {
                if (!isManual) {
                    console.log('ğŸ”„ Starting automatic backup...');
                }
                
                // Collect all data
                const backupData = {
                    version: '2.0',
                    type: isManual ? 'manual' : 'automatic',
                    exportDate: new Date().toISOString(),
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    cars: [],
                    maintenance: [],
                    appointments: [],
                    settings: {}
                };
                
                // Get cars (without images to keep size small)
                backupData.cars = cars.map(car => ({
                    ...car,
                    imageUrl: null
                }));
                
                // Get maintenance
                const maintenanceSnapshot = await db.collection('maintenance')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                maintenanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    backupData.maintenance.push({
                        id: doc.id,
                        ...data,
                        images: [],
                        createdAt: safeToMillis(data.createdAt),
                        updatedAt: safeToMillis(data.updatedAt)
                    });
                });
                
                // Get appointments
                const appointmentsSnapshot = await db.collection('appointments')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                appointmentsSnapshot.forEach(doc => {
                    const data = doc.data();
                    backupData.appointments.push({
                        id: doc.id,
                        ...data,
                        createdAt: safeToMillis(data.createdAt)
                    });
                });
                
                // Get settings
                const settingsDoc = await db.collection('settings').doc(currentUser.uid).get();
                if (settingsDoc.exists) {
                    backupData.settings = settingsDoc.data();
                }
                
                // Try IndexedDB first, fallback to localStorage
                try {
                    await saveBackupLocally(backupData);
                } catch (indexedDBError) {
                    console.warn('IndexedDB failed, using localStorage:', indexedDBError);
                    // Fallback to localStorage (simpler but limited to ~5-10MB)
                    saveBackupToLocalStorage(backupData);
                }
                
                // Update last backup date
                localStorage.setItem('lastAutoBackupDate', new Date().toISOString());
                
                // Log backup history (per user)
                const historyKey = `backupHistory_${currentUser.uid}`;
                const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                history.unshift({
                    date: new Date().toISOString(),
                    type: isManual ? 'manual' : 'automatic',
                    carsCount: backupData.cars.length,
                    size: JSON.stringify(backupData).length
                });
                // Keep only last 10 records
                if (history.length > 10) history.length = 10;
                localStorage.setItem(historyKey, JSON.stringify(history));
                
                if (isManual) {
                    showNotification('âœ… ×”×’×™×‘×•×™ × ×•×¦×¨ ×‘×”×¦×œ×—×”!');
                } else {
                    console.log('âœ… Automatic backup completed successfully');
                }
                
                updateBackupInfo();
                
                return true;
            } catch (error) {
                console.error('Error creating auto backup:', error);
                if (isManual) {
                    alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×‘×•×™: ' + error.message);
                }
                return false;
            }
        }
        
        // LocalStorage backup fallback (simpler and more reliable)
        function saveBackupToLocalStorage(backupData) {
            if (!currentUser) {
                console.error('No user logged in');
                return;
            }
            
            const storageKey = `localBackups_${currentUser.uid}`;
            
            try {
                const backups = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                const backup = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    data: backupData,
                    size: JSON.stringify(backupData).length,
                    carsCount: backupData.cars ? backupData.cars.length : 0,
                    maintenanceCount: backupData.maintenance ? backupData.maintenance.length : 0,
                    userId: currentUser.uid
                };
                
                backups.unshift(backup);
                
                // Keep only last 4 backups
                if (backups.length > 4) {
                    backups.length = 4;
                }
                
                const compressed = JSON.stringify(backups);
                localStorage.setItem(storageKey, compressed);
                
                console.log(`âœ… Backup saved to localStorage for user ${currentUser.uid}. Total: ${backups.length}/4`);
            } catch (error) {
                console.error('LocalStorage backup failed:', error);
                // If localStorage is full, remove old backups and retry
                if (error.name === 'QuotaExceededError') {
                    const backups = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    // Keep only last 2 to free space
                    if (backups.length > 2) {
                        backups.length = 2;
                        localStorage.setItem(storageKey, JSON.stringify(backups));
                    }
                    saveBackupToLocalStorage(backupData);
                }
            }
        }
        
        // Get backups from localStorage
        function getLocalStorageBackups() {
            if (!currentUser) {
                return [];
            }
            
            const storageKey = `localBackups_${currentUser.uid}`;
            
            try {
                return JSON.parse(localStorage.getItem(storageKey) || '[]');
            } catch (error) {
                console.error('Error reading localStorage backups:', error);
                return [];
            }
        }
        
        // Check if backup is needed today
        function shouldRunBackup() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const hour = now.getHours();
            const minute = now.getMinutes();
            
            // Check if it's the right day and time
            if (dayOfWeek !== AUTO_BACKUP_CONFIG.dayOfWeek) return false;
            if (hour !== AUTO_BACKUP_CONFIG.hour) return false;
            if (minute !== AUTO_BACKUP_CONFIG.minute) return false;
            
            // Check if already backed up today
            const lastBackup = localStorage.getItem('lastAutoBackupDate');
            if (lastBackup) {
                const lastDate = new Date(lastBackup);
                const today = new Date();
                if (lastDate.toDateString() === today.toDateString()) {
                    return false; // Already backed up today
                }
            }
            
            return true;
        }
        
        // Start automatic backup scheduler
        function startAutoBackupScheduler() {
            if (!AUTO_BACKUP_CONFIG.enabled) return;
            
            // Update backup info immediately
            updateAutoBackupInfo();
            
            // Update info every minute
            setInterval(() => {
                updateAutoBackupInfo();
            }, 60000);
            
            // Check for backup every minute
            setInterval(() => {
                if (shouldRunBackup()) {
                    createAutoBackup(false);
                }
            }, 60000);
            
            console.log('ğŸ• Auto backup scheduler started');
            console.log(`ğŸ“… Next backup: Friday at ${AUTO_BACKUP_CONFIG.hour}:${AUTO_BACKUP_CONFIG.minute.toString().padStart(2, '0')}`);
        }
        
        // Update auto backup information display
        function updateAutoBackupInfo() {
            try {
                // Last backup time - simplified
                const lastBackup = localStorage.getItem('lastAutoBackupDate');
                const lastBackupEl = document.getElementById('lastAutoBackupTime');
                if (lastBackupEl) {
                    if (lastBackup) {
                        const date = new Date(lastBackup);
                        const now = new Date();
                        const days = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                        
                        if (days > 0) {
                            lastBackupEl.textContent = `×œ×¤× ×™ ${days} ×™××™×`;
                        } else {
                            lastBackupEl.textContent = '×”×™×•×';
                        }
                    } else {
                        lastBackupEl.textContent = '×˜×¨× ×‘×•×¦×¢';
                    }
                }
                
                // Time until backup - simplified
                const timeUntilEl = document.getElementById('timeUntilBackup');
                if (timeUntilEl) {
                    const now = new Date();
                    const dayOfWeek = now.getDay();
                    const daysUntilFriday = (5 - dayOfWeek + 7) % 7 || 7;
                    
                    if (daysUntilFriday > 1) {
                        timeUntilEl.textContent = `${daysUntilFriday} ×™××™×`;
                    } else if (daysUntilFriday === 1) {
                        timeUntilEl.textContent = '××—×¨';
                    } else {
                        timeUntilEl.textContent = '×”×™×•×';
                    }
                }
            } catch (error) {
                console.error('Error updating auto backup info:', error);
            }
        }
        
        // Get next backup date
        function getNextBackupDate() {
            const now = new Date();
            let next = new Date();
            
            // Set to next Friday at 23:00
            const daysUntilFriday = (5 - now.getDay() + 7) % 7;
            next.setDate(now.getDate() + daysUntilFriday);
            next.setHours(AUTO_BACKUP_CONFIG.hour, AUTO_BACKUP_CONFIG.minute, 0, 0);
            
            // If Friday 23:00 already passed this week, go to next week
            if (next <= now) {
                next.setDate(next.getDate() + 7);
            }
            
            return next;
        }
        
        // Test auto backup now (forces backup)
        
        // Show backup list modal
        async function showBackupList() {
            try {
                // Try to get backups from both sources
                let indexedBackups = [];
                let localBackups = [];
                
                try {
                    indexedBackups = await getSavedBackups();
                } catch (e) {
                    console.warn('IndexedDB not available:', e);
                }
                
                try {
                    localBackups = getLocalStorageBackups();
                } catch (e) {
                    console.warn('LocalStorage not available:', e);
                }
                
                // Combine and deduplicate backups
                const allBackups = [...indexedBackups, ...localBackups];
                const uniqueBackups = allBackups.filter((backup, index, self) =>
                    index === self.findIndex((b) => b.id === backup.id)
                );
                uniqueBackups.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const backups = uniqueBackups; // Show all backups, no limit
                
                // Get history for current user only
                const historyKey = currentUser ? `backupHistory_${currentUser.uid}` : 'backupHistory';
                const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                
                let html = `
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-lg border-2 border-amber-200">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-bold text-amber-900">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ×’×™×‘×•×™</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div class="bg-white p-3 rounded-lg">
                                    <div class="text-gray-600">×’×™×‘×•×™×™× ×©××•×¨×™×</div>
                                    <div class="text-2xl font-bold text-amber-600">${backups.length}</div>
                                </div>
                                <div class="bg-white p-3 rounded-lg">
                                    <div class="text-gray-600">×’×™×‘×•×™ ×”×‘×</div>
                                    <div class="text-lg font-bold text-blue-600">×™×•× ×•×³ 23:00</div>
                                </div>
                            </div>
                        </div>
                `;
                
                if (backups.length > 0) {
                    html += `
                        <div class="bg-white p-4 rounded-lg border-2">
                            <h3 class="text-lg font-bold mb-3">ğŸ’¾ ×’×™×‘×•×™×™× ×–××™× ×™×</h3>
                            <div class="space-y-2">
                    `;
                    
                    backups.forEach((backup, index) => {
                        const date = new Date(backup.date);
                        const size = (backup.size / 1024).toFixed(2);
                        html += `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border hover:border-amber-500 transition">
                                <div class="flex-1">
                                    <div class="font-bold">${index === 0 ? 'ğŸŒŸ ' : ''}×’×™×‘×•×™ ${index + 1}</div>
                                    <div class="text-sm text-gray-600">${date.toLocaleString('he-IL')}</div>
                                    <div class="text-xs text-gray-500">${backup.carsCount} ×¨×›×‘×™× â€¢ ${size} KB</div>
                                </div>
                                <button onclick="restoreBackup(${backup.id})" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold">
                                    ×©×—×–×¨
                                </button>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                if (history.length > 0) {
                    html += `
                        <div class="bg-white p-4 rounded-lg border-2">
                            <h3 class="text-lg font-bold mb-3">ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª ×’×™×‘×•×™×™×</h3>
                            <div class="space-y-1 max-h-48 overflow-y-auto">
                    `;
                    
                    history.slice(0, 10).forEach(record => {
                        const date = new Date(record.date);
                        const typeIcon = record.type === 'manual' ? 'ğŸ‘¤' : 'ğŸ¤–';
                        const typeName = record.type === 'manual' ? '×™×“× ×™' : '××•×˜×•××˜×™';
                        html += `
                            <div class="flex items-center justify-between text-sm p-2 hover:bg-gray-50 rounded">
                                <div class="flex items-center gap-2">
                                    <span>${typeIcon}</span>
                                    <span>${date.toLocaleDateString('he-IL')} ${date.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'})}</span>
                                </div>
                                <div class="text-gray-600">${typeName} â€¢ ${record.carsCount} ×¨×›×‘×™×</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    </div>
                `;
                
                // Show in a modal (reuse backup modal)
                const modal = document.getElementById('backupModal');
                if (!modal) {
                    console.error('Modal not found');
                    return;
                }
                
                // Get content div by ID
                let contentDiv = document.getElementById('backupModalContent');
                
                if (!contentDiv) {
                    console.error('Content div not found');
                    alert('×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×”×¦×™×’ ××ª ×¨×©×™××ª ×”×’×™×‘×•×™×™×');
                    return;
                }
                
                // Save original content globally (only once)
                if (!window.backupModalOriginalContent) {
                    window.backupModalOriginalContent = contentDiv.innerHTML;
                    console.log('âœ… Original content saved');
                }
                const originalContent = window.backupModalOriginalContent;
                
                contentDiv.innerHTML = html;
                
                // Add modal-open class
                document.body.classList.add('modal-open');
                modal.classList.remove('hidden');
                
                // Add back button
                const backBtn = document.createElement('button');
                backBtn.className = 'mt-4 w-full bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white py-3 rounded-lg font-bold transition';
                backBtn.textContent = 'â† ×—×–×•×¨';
                backBtn.onclick = () => {
                    const contentDiv = document.getElementById('backupModalContent');
                    if (contentDiv && originalContent) {
                        contentDiv.innerHTML = originalContent;
                        console.log('âœ… Returned to main backup screen');
                    }
                    // Re-initialize any event listeners if needed
                    setTimeout(() => {
                        try {
                            updateAutoBackupInfo();
                        } catch (e) {
                            console.error('Error updating info:', e);
                        }
                    }, 100);
                };
                contentDiv.appendChild(backBtn);
                
            } catch (error) {
                console.error('Error showing backup list:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×’×™×‘×•×™×™×');
            }
        }
        
        // Restore backup from IndexedDB or localStorage
        async function restoreBackup(backupId) {
            if (!confirm('âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×©×—×–×¨ ×’×™×‘×•×™ ×–×”?\n\nğŸ’¡ ×”× ×ª×•× ×™× ××”×’×™×‘×•×™ ×™×ª×•×•×¡×¤×• ×œ× ×ª×•× ×™× ×”×§×™×™××™× ×‘××¢×¨×›×ª.')) {
                return;
            }
            
            try {
                // Try to get the backup from both sources
                let backup = null;
                
                try {
                    const indexedBackups = await getSavedBackups();
                    backup = indexedBackups.find(b => b.id === backupId);
                    console.log('Found in IndexedDB:', backup ? 'yes' : 'no');
                } catch (e) {
                    console.warn('IndexedDB not available:', e);
                }
                
                if (!backup) {
                    try {
                        const localBackups = getLocalStorageBackups();
                        backup = localBackups.find(b => b.id === backupId);
                        console.log('Found in localStorage:', backup ? 'yes' : 'no');
                    } catch (e) {
                        console.warn('LocalStorage not available:', e);
                    }
                }
                
                if (!backup) {
                    alert('×’×™×‘×•×™ ×œ× × ××¦×');
                    console.error('Backup not found with ID:', backupId);
                    return;
                }
                
                showBackupProgress(true);
                updateBackupProgress(10, '×˜×•×¢×Ÿ ×’×™×‘×•×™...');
                
                let backupData = backup.data;
                
                // Decrypt if needed
                if (typeof backupData === 'string') {
                    const password = localStorage.getItem('backupPassword');
                    if (password) {
                        try {
                            backupData = decryptData(backupData, password);
                        } catch (e) {
                            const userPassword = prompt('ğŸ”’ ×”×–×Ÿ ×¡×™×¡××ª ×”×¦×¤× ×”:');
                            if (!userPassword) {
                                showBackupProgress(false);
                                return;
                            }
                            backupData = decryptData(backupData, userPassword);
                        }
                    }
                }
                
                updateBackupProgress(30, '×‘×•×“×§ ×¨×›×‘×™× ×§×™×™××™×...');
                // Check for existing cars to prevent duplicates
                const existingCarsSnapshot = await db.collection('cars')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                const existingPlateNumbers = new Set();
                existingCarsSnapshot.forEach(doc => {
                    const car = doc.data();
                    if (car.plateNumber) {
                        existingPlateNumbers.add(car.plateNumber);
                    }
                });
                
                console.log(`Found ${existingPlateNumbers.size} existing cars`);
                
                // Create mapping for plate numbers to new car IDs
                const plateToCarIdMap = {};
                
                updateBackupProgress(50, '××©×—×–×¨ ×¨×›×‘×™×...');
                let carsAdded = 0;
                let carsSkipped = 0;
                
                for (const car of backupData.cars) {
                    const carData = { ...car };
                    const plateNumber = carData.plateNumber;
                    
                    // Check if car already exists
                    if (existingPlateNumbers.has(plateNumber)) {
                        console.log(`âš ï¸ Car ${plateNumber} already exists - skipping`);
                        carsSkipped++;
                        continue;
                    }
                    
                    delete carData.id;
                    carData.userId = currentUser.uid;
                    carData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    const docRef = await db.collection('cars').add(carData);
                    plateToCarIdMap[plateNumber] = docRef.id;
                    console.log(`ğŸš— Car added: ${plateNumber} -> ${docRef.id}`);
                    carsAdded++;
                }
                
                updateBackupProgress(70, '××©×—×–×¨ ×˜×™×¤×•×œ×™×...');
                for (const maintenance of backupData.maintenance) {
                    const maintenanceData = { ...maintenance };
                    delete maintenanceData.id;
                    
                    // Map to new carId
                    const newCarId = plateToCarIdMap[maintenanceData.plateNumber];
                    if (newCarId) {
                        maintenanceData.carId = newCarId;
                    }
                    maintenanceData.userId = currentUser.uid;
                    
                    if (maintenanceData.createdAt) {
                        maintenanceData.createdAt = firebase.firestore.Timestamp.fromMillis(maintenanceData.createdAt);
                    }
                    if (maintenanceData.updatedAt) {
                        maintenanceData.updatedAt = firebase.firestore.Timestamp.fromMillis(maintenanceData.updatedAt);
                    }
                    
                    await db.collection('maintenance').add(maintenanceData);
                }
                
                updateBackupProgress(90, '××©×—×–×¨ ×¤×’×™×©×•×ª...');
                for (const appointment of backupData.appointments) {
                    const appointmentData = { ...appointment };
                    delete appointmentData.id;
                    
                    // Map to new carId
                    const newCarId = plateToCarIdMap[appointmentData.plateNumber];
                    if (newCarId) {
                        appointmentData.carId = newCarId;
                    }
                    appointmentData.userId = currentUser.uid;
                    
                    if (appointmentData.createdAt) {
                        appointmentData.createdAt = firebase.firestore.Timestamp.fromMillis(appointmentData.createdAt);
                    } else {
                        appointmentData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    }
                    
                    await db.collection('appointments').add(appointmentData);
                    console.log(`ğŸ“… Appointment restored for: ${appointmentData.plateNumber}`);
                }
                
                updateBackupProgress(100, '×”×©×—×–×•×¨ ×”×•×©×œ×!');
                setTimeout(() => {
                    showBackupProgress(false);
                    showNotification('âœ… ×”×’×™×‘×•×™ ×©×•×—×–×¨ ×‘×”×¦×œ×—×”!');
                    
                    let message = 'âœ… ×”×’×™×‘×•×™ ×©×•×—×–×¨ ×‘×”×¦×œ×—×”!\n\nğŸ“Š ×¡×™×›×•×:\n';
                    message += `â€¢ ${carsAdded} ×¨×›×‘×™× × ×•×¡×¤×•\n`;
                    if (carsSkipped > 0) {
                        message += `â€¢ ${carsSkipped} ×¨×›×‘×™× ×§×™×™××™× ×“×•×œ×’×• (×œ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª)\n`;
                    }
                    
                    alert(message);
                    closeBackupModal();
                    loadCars();
                }, 1500);
                
            } catch (error) {
                console.error('Error restoring backup:', error);
                alert('×©×’×™××” ×‘×©×—×–×•×¨ ×’×™×‘×•×™: ' + error.message);
                showBackupProgress(false);
            }
        }
        
        // Initialize auto backup system when app loads
        auth.onAuthStateChanged(user => {
            if (user) {
                // Start scheduler after a short delay
                setTimeout(() => {
                    startAutoBackupScheduler();
                }, 3000);
            }
        });


        // ==========================================
        // Browser Back Button Support for Mobile
        // ==========================================
        
        // Handle browser back button
        window.addEventListener('popstate', function(event) {
            const carModal = document.getElementById('carModal');
            const detailsModal = document.getElementById('carDetailsModal');
            const maintenanceModal = document.getElementById('maintenanceModal');
            const calendarModal = document.getElementById('calendarModal');
            const appointmentModal = document.getElementById('appointmentModal');
            const dashboardModal = document.getElementById('dashboardModal');
            
            // Close any open modal when back button is pressed
            if (dashboardModal && !dashboardModal.classList.contains('hidden')) {
                closeDashboard();
            } else if (appointmentModal && !appointmentModal.classList.contains('hidden')) {
                closeAppointmentModal();
            } else if (calendarModal && !calendarModal.classList.contains('hidden')) {
                closeCalendarModal();
            } else if (carModal && !carModal.classList.contains('hidden')) {
                closeCarModal();
            } else if (maintenanceModal && !maintenanceModal.classList.contains('hidden')) {
                closeMaintenanceModal();
            } else if (detailsModal && !detailsModal.classList.contains('hidden')) {
                closeCarDetailsModal();
            }
        });

        // Wrap modal open functions to add history state
        (function() {
            // Save original functions
            const _openCarModal = window.openCarModal;
            const _openCarDetailsModal = window.openCarDetailsModal;
            const _openMaintenanceModal = window.openMaintenanceModal;
            const _openCalendarModal = window.openCalendarModal;
            const _openAppointmentModal = window.openAppointmentModal;
            const _openDashboard = window.openDashboard;
            
            // Override openCarModal
            window.openCarModal = function() {
                _openCarModal();
                history.pushState({ modal: 'car' }, '', '');
            };
            
            // Override openCarDetailsModal
            window.openCarDetailsModal = function(carId) {
                _openCarDetailsModal(carId);
                history.pushState({ modal: 'details' }, '', '');
            };
            
            // Override openMaintenanceModal
            window.openMaintenanceModal = function() {
                _openMaintenanceModal();
                history.pushState({ modal: 'maintenance' }, '', '');
            };
            
            // Override openCalendarModal
            window.openCalendarModal = function() {
                _openCalendarModal();
                history.pushState({ modal: 'calendar' }, '', '');
            };
            
            // Override openAppointmentModal
            window.openAppointmentModal = function() {
                _openAppointmentModal();
                history.pushState({ modal: 'appointment' }, '', '');
            };
            
            // Override openDashboard
            window.openDashboard = function() {
                _openDashboard();
                history.pushState({ modal: 'dashboard' }, '', '');
            };
        })();

// ==========================================
// Data.gov.il API Integration
// ==========================================

let apiTimeout = null;

async function fetchCarDataFromAPI(plateNumber) {
    const apiStatus = document.getElementById('apiStatus');
    
    // Show loading
    apiStatus.innerHTML = '<div class="flex items-center gap-2 text-blue-600 text-sm"><div class="animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent"></div><span>××—×¤×© ××™×“×¢ ×‘×¨×©×•×™×•×ª...</span></div>';
    
    try {
        // Clean the plate number
        const cleanPlateNumber = plateNumber.replace(/[-\s]/g, '');
        
        /* 
         * Available fields from data.gov.il API:
         * - mispar_rechev: Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©
         * - tozeret_nm: Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø© (Toyota, Honda, etc.)
         * - kinuy_mishari: Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ
         * - shnat_yitzur: Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹
         * - baal_rechev: Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ
         * - delek: Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ‚ÙˆØ¯ (Ø¨Ù†Ø²×™×ŸØŒ ×“×™×–×œØŒ ×—×©××œ×™ØŒ etc.)
         * - koach_sus: Ù‚ÙˆØ© Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¨Ø§Ù„Ø­ØµØ§Ù†
         * - nefach_manoa: Ø³Ø¹Ø© Ø§Ù„Ù…Ø­Ø±Ùƒ (cmÂ³)
         * - degem_manoa: Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ
         * - tzeva_rechev: Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©
         */
        
        // Call the API
        const response = await fetch(`https://data.gov.il/api/3/action/datastore_search?resource_id=053cea08-09bc-40ec-8f7a-156f0677aff3&q=${cleanPlateNumber}`);
        
        if (!response.ok) {
            throw new Error('×©×’×™××” ×‘×§×‘×œ×ª × ×ª×•× ×™×');
        }
        
        const data = await response.json();
        
        if (data.success && data.result.records && data.result.records.length > 0) {
            const carInfo = data.result.records[0];
            
            console.log('Car Info from API:', carInfo); // Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
            
            // Fill basic info
            if (carInfo.tozeret_nm) document.getElementById('carType').value = carInfo.tozeret_nm;
            if (carInfo.kinuy_mishari) document.getElementById('model').value = carInfo.kinuy_mishari;
            if (carInfo.shnat_yitzur) document.getElementById('year').value = carInfo.shnat_yitzur;
            
            // Fill owner name if available
            if (carInfo.baal_rechev) {
                document.getElementById('ownerName').value = carInfo.baal_rechev;
            }
            
            // Fill engine type (delek = fuel type)
            if (carInfo.delek) {
                const fuelType = carInfo.delek.trim();
                const engineTypeSelect = document.getElementById('engineType');
                
                // Map fuel types to Hebrew
                const fuelMapping = {
                    '×‘× ×–×™×Ÿ': '×‘× ×–×™×Ÿ',
                    '×“×™×–×œ': '×“×™×–×œ',
                    '×”×™×‘×¨×™×“×™': '×”×™×‘×¨×™×“×™',
                    '×—×©××œ': '×—×©××œ×™',
                    '×—×©××œ×™': '×—×©××œ×™',
                    '×”×™×‘×¨×“×™': '×”×™×‘×¨×™×“×™',
                    'BENZIN': '×‘× ×–×™×Ÿ',
                    'DIESEL': '×“×™×–×œ',
                    'HYBRID': '×”×™×‘×¨×™×“×™',
                    'ELECTRIC': '×—×©××œ×™'
                };
                
                // Try to find matching fuel type
                for (const [key, value] of Object.entries(fuelMapping)) {
                    if (fuelType.includes(key) || fuelType.toUpperCase().includes(key)) {
                        engineTypeSelect.value = value;
                        break;
                    }
                }
            }
            
            // Fill engine power/size
            let enginePowerText = '';
            
            // Horse power (degem_manoa can contain HP info)
            if (carInfo.koach_sus) {
                enginePowerText += carInfo.koach_sus + ' ×›"×¡';
            }
            
            // Engine capacity (cmÂ³)
            if (carInfo.nefach_manoa) {
                if (enginePowerText) enginePowerText += ' / ';
                enginePowerText += carInfo.nefach_manoa + ' ×¡×"×§';
            }
            
            if (enginePowerText) {
                document.getElementById('enginePower').value = enginePowerText;
            }
            
            apiStatus.innerHTML = '<div class="text-green-600 text-sm font-semibold">âœ“ × ××¦××• ×¤×¨×˜×™ ×”×¨×›×‘ ××”×××’×¨ ×”×××©×œ×ª×™</div>';
            setTimeout(() => apiStatus.innerHTML = '', 3000);
        } else {
            apiStatus.innerHTML = '<div class="text-orange-600 text-sm">×œ× × ××¦××• ×¤×¨×˜×™× ×‘×××’×¨</div>';
            setTimeout(() => apiStatus.innerHTML = '', 3000);
        }
    } catch (error) {
        apiStatus.innerHTML = '<div class="text-gray-600 text-sm">× ×™×ª×Ÿ ×œ×”×–×™×Ÿ ×™×“× ×™×ª</div>';
        setTimeout(() => apiStatus.innerHTML = '', 3000);
    }
}

// Manual search function when button is clicked
function searchCarByPlateNumber() {
    const plateNumber = document.getElementById('plateNumber').value.trim();
    const apiStatus = document.getElementById('apiStatus');
    
    if (!plateNumber) {
        apiStatus.innerHTML = '<div class="text-red-600 text-sm">× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×¨×™×©×•×™</div>';
        setTimeout(() => apiStatus.innerHTML = '', 2000);
        return;
    }
    
    if (plateNumber.length < 7) {
        apiStatus.innerHTML = '<div class="text-orange-600 text-sm">××¡×¤×¨ ×¨×™×©×•×™ ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª 7 ×¡×¤×¨×•×ª</div>';
        setTimeout(() => apiStatus.innerHTML = '', 2000);
        return;
    }
    
    fetchCarDataFromAPI(plateNumber);
}

// Clear form fields (except plate number and image)
function clearCarFormFields() {
    // Don't clear: plateNumber, carImage, imagePreview
    // Clear all other fields
    document.getElementById('ownerName').value = '';
    document.getElementById('carType').value = '';
    document.getElementById('model').value = '';
    document.getElementById('year').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('engineType').value = '';
    document.getElementById('enginePower').value = '';
    document.getElementById('immobilizerCode').value = '';
    
    // Clear API status
    document.getElementById('apiStatus').innerHTML = '';
}

// Monitor plate number input
document.addEventListener('DOMContentLoaded', function() {
    const plateNumberInput = document.getElementById('plateNumber');
    
    if (plateNumberInput) {
        let previousValue = '';
        
        plateNumberInput.addEventListener('input', function(e) {
            // Remove non-digits
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
            
            // If user deleted the plate number (went from having value to empty)
            if (previousValue && !value) {
                clearCarFormFields();
            }
            
            previousValue = value;
        });
        
        // Also clear on backspace/delete when field becomes empty
        plateNumberInput.addEventListener('keyup', function(e) {
            if (!this.value.trim()) {
                clearCarFormFields();
            }
        });
    }
});

// Service Worker for PWA with auto-update and cleanup
if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
        try {
            // ğŸ§¹ Ø®Ø·ÙˆØ© 1: ØªÙ†Ø¸ÙŠÙ Service Workers Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            console.log('ğŸ§¹ Cleaning old service workers...');
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (let registration of registrations) {
                // Ø§Ø­Ø°Ù Ø£ÙŠ SW Ù‚Ø¯ÙŠÙ… Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠ
                if (!registration.active || registration.active.scriptURL.includes('v25')) {
                    console.log('ğŸ—‘ï¸ Unregistering old SW:', registration.active?.scriptURL);
                    await registration.unregister();
                }
            }
            
            // ğŸ§¹ Ø®Ø·ÙˆØ© 2: ØªÙ†Ø¸ÙŠÙ Cache Ø§Ù„Ù‚Ø¯ÙŠÙ…
            console.log('ğŸ§¹ Cleaning old caches...');
            const cacheNames = await caches.keys();
            for (let cacheName of cacheNames) {
                if (cacheName.includes('v25') || cacheName.includes('v24') || cacheName.includes('v23')) {
                    console.log('ğŸ—‘ï¸ Deleting old cache:', cacheName);
                    await caches.delete(cacheName);
                }
            }
            
            // âœ… Ø®Ø·ÙˆØ© 3: ØªØ³Ø¬ÙŠÙ„ Service Worker Ø§Ù„Ø¬Ø¯ÙŠØ¯
            console.log('ğŸ“ Registering new service worker...');
            const registration = await navigator.serviceWorker.register('/service-worker.js', {
                scope: '/',
                updateViaCache: 'none' // â­ Ù…Ù‡Ù…: Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… cache Ù„Ù„Ù€ SW Ù†ÙØ³Ù‡
            });
            
            console.log('âœ… Service Worker registered successfully');
            
            // â­ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙƒÙ„ Ø³Ø§Ø¹Ø© (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 30 Ø«Ø§Ù†ÙŠØ©)
            setInterval(() => {
                console.log('ğŸ” Checking for updates...');
                registration.update();
            }, 60 * 60 * 1000); // 1 hour
            
            // â­ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                console.log('ğŸ“¥ New version found, installing...');
                
                newWorker.addEventListener('statechange', () => {
                    console.log('Service Worker state:', newWorker.state);
                    
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        // â­ Ø¥Ø´Ø¹Ø§Ø± ÙÙ‚Ø· - Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
                        console.log('â„¹ï¸ New version available');
                        showToast('ğŸ”„ ×’×¨×¡×” ×—×“×©×” ×–××™× ×” - ×¨×¢× ×Ÿ ××ª ×”×“×£', 'info');
                        
                        // Ù„Ø§ Ù†Ø¬Ø¨Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ‚Ø±Ø±
                        // newWorker.postMessage({ type: 'SKIP_WAITING' });
                    }
                });
            });
            
            // â­ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† SW
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SW_ACTIVATED') {
                    console.log('âœ… Service Worker activated:', event.data.version);
                }
            });
            
            // â­ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ± Controller
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                console.log('ğŸ”„ Controller changed, reloading...');
                window.location.reload(true);
            });
            
        } catch (error) {
            console.error('âŒ Service Worker setup failed:', error);
        }
    });
}

// ========== SIDEBAR MENU FUNCTIONS ==========
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const bottomNav = document.querySelector('.mobile-bottom-nav');
    const fabButton = document.querySelector('.fab-button');
    
    if (sidebar && overlay) {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
        
        if (sidebar.classList.contains('open')) {
            // Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
            document.body.classList.add('sidebar-open');
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ ÙˆØ²Ø± FAB
            if (bottomNav) {
                bottomNav.style.transform = 'translateY(100%)';
                bottomNav.style.transition = 'transform 0.3s ease';
            }
            if (fabButton) {
                fabButton.style.transform = 'translateY(200%)';
                fabButton.style.transition = 'transform 0.3s ease';
            }
        } else {
            // Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
            document.body.classList.remove('sidebar-open');
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ ÙˆØ²Ø± FAB
            if (bottomNav) {
                bottomNav.style.transform = 'translateY(0)';
            }
            if (fabButton) {
                fabButton.style.transform = 'translateY(0)';
            }
        }
    }
}

// Close sidebar when pressing Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const sidebar = document.getElementById('sidebar');
        if (sidebar && sidebar.classList.contains('open')) {
            toggleSidebar();
        }
    }
});

// Update sidebar user info when user name changes
function updateSidebarUserInfo() {
    const userName = document.getElementById('userName');
    const sidebarUserName = document.getElementById('sidebarUserName');
    if (userName && sidebarUserName) {
        sidebarUserName.textContent = userName.textContent;
    }
}

// Update subscription counter in sidebar
function updateSidebarCounter() {
    const daysLeft = document.getElementById('daysLeft');
    const sidebarDaysLeft = document.getElementById('sidebarDaysLeft');
    const sidebarDaysCounter = document.getElementById('sidebarDaysCounter');
    
    if (daysLeft && sidebarDaysLeft && sidebarDaysCounter) {
        sidebarDaysLeft.textContent = daysLeft.textContent;
        if (daysLeft.textContent !== '0') {
            sidebarDaysCounter.classList.remove('hidden');
        }
    }
}

// Sync theme icon in sidebar
function updateSidebarTheme() {
    const themeIcon = document.getElementById('themeIcon');
    const sidebarThemeIcon = document.getElementById('sidebarThemeIcon');
    const sidebarThemeText = document.getElementById('sidebarThemeText');
    
    if (themeIcon && sidebarThemeIcon && sidebarThemeText) {
        sidebarThemeIcon.textContent = themeIcon.textContent;
        sidebarThemeText.textContent = themeIcon.textContent === 'ğŸŒ™' ? '××¦×‘ ×™×•×' : '××¦×‘ ×œ×™×œ×”';
    }
}

// Call these on page load
window.addEventListener('load', function() {
    updateSidebarUserInfo();
    updateSidebarCounter();
    updateSidebarTheme();
});

// Show Account Modal
function showAccountModal() {
    // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ modals Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹
    closeAllModals();
    
    const modal = document.getElementById('accountModal');
    if (!modal) {
        console.error('Account modal not found');
        return;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù†
    updateActiveNav(4);
    
    const detailsDiv = document.getElementById('subscriptionDetails');
    
    // Show loading
    detailsDiv.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">×˜×•×¢×Ÿ...</p>
        </div>
    `;
    
    modal.classList.remove('hidden');
    hideUIElements(); // Ø¥Ø®ÙØ§Ø¡ FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
    
    // Load subscription data
    db.collection('users').doc(currentUser.uid).get()
        .then(doc => {
            if (!doc.exists) {
                detailsDiv.innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <p>×œ× × ××¦××• × ×ª×•× ×™ ×× ×•×™</p>
                    </div>
                `;
                return;
            }
            
            const userData = doc.data();
            const now = new Date();
            let statusHTML = '';
            
            if (userData.subscriptionEndDate) {
                let endDate;
                if (userData.subscriptionEndDate.toDate) {
                    endDate = userData.subscriptionEndDate.toDate();
                } else {
                    endDate = new Date(userData.subscriptionEndDate);
                }
                
                const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                const endDateText = endDate.toLocaleDateString('he-IL');
                
                if (daysLeft > 0) {
                    statusHTML = `
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border-2 border-green-500">
                                <div>
                                    <div class="text-sm text-gray-600">×—×©×‘×•×Ÿ</div>
                                    <div class="font-bold text-lg">${currentUser.email}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-600">×ª×•×§×£ ×¢×“</div>
                                    <div class="font-bold text-lg">${endDateText}</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-white rounded-lg border-2">
                                <div>
                                    <div class="text-sm text-gray-600">×¡×˜×˜×•×¡</div>
                                    <div class="font-bold text-lg text-green-600">âœ… ×¤×¢×™×œ</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-600">×™××™× × ×•×ª×¨×•</div>
                                    <div class="font-bold text-3xl text-green-600">${daysLeft}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    statusHTML = `
                        <div class="p-6 bg-red-50 rounded-lg border-2 border-red-500 text-center">
                            <div class="text-2xl font-bold text-red-600 mb-2">âš ï¸ ×”×× ×•×™ ×¤×’ ×ª×•×§×£</div>
                            <div class="text-gray-700">××ª×” ×™×›×•×œ ×œ×¦×¤×•×ª ×‘× ×ª×•× ×™× ××‘×œ ×œ× ×œ×”×•×¡×™×£ ××• ×œ×¢×¨×•×š</div>
                        </div>
                    `;
                }
            } else {
                statusHTML = `
                    <div class="p-6 bg-gray-50 rounded-lg border-2 text-center">
                        <div class="text-xl font-bold text-gray-600 mb-2">××™×Ÿ ×× ×•×™ ×¤×¢×™×œ</div>
                    </div>
                `;
            }
            
            detailsDiv.innerHTML = statusHTML;
        })
        .catch(error => {
            console.error('Error loading subscription:', error);
            detailsDiv.innerHTML = `
                <div class="text-center py-8 text-red-600">
                    <p>×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</p>
                </div>
            `;
        });
}

function closeAccountModal() {
    const modal = document.getElementById('accountModal');
    if (modal) {
        modal.classList.add('hidden');
    }
    showUIElements(); // Ø¥Ø¸Ù‡Ø§Ø± FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
    // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØª ÙÙŠ Ø§Ù„Ù†Ø§ÙÙŠØ¬ÙŠØ´Ù†
    updateActiveNav(0);
}
    </script>

    <!-- Account Modal -->
    <div id="accountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="z-index: 99999;">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-amber-500 to-amber-600 text-white p-6 rounded-t-lg flex justify-between items-center sticky top-0">
                <h2 class="text-2xl font-bold">ğŸ’³ ×”×—×©×‘×•×Ÿ ×©×œ×™</h2>
                <button onclick="closeAccountModal()" class="text-white hover:text-gray-200 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="p-6">
                <div id="subscriptionDetails">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500 mx-auto"></div>
                        <p class="mt-4 text-gray-600">×˜×•×¢×Ÿ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Close all modals function
        // Helper functions to show/hide FAB and bottom nav
        function hideUIElements() {
            const fab = document.querySelector('.fab-button');
            const bottomNav = document.querySelector('.mobile-bottom-nav');
            if (fab) fab.classList.add('hide-on-modal');
            if (bottomNav) bottomNav.classList.add('hide-on-modal');
        }
        
        function showUIElements() {
            const fab = document.querySelector('.fab-button');
            const bottomNav = document.querySelector('.mobile-bottom-nav');
            if (fab) fab.classList.remove('hide-on-modal');
            if (bottomNav) bottomNav.classList.remove('hide-on-modal');
        }
        
        function closeAllModals() {
            // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
            const modals = ['dashboardModal', 'calendarModal', 'backupModal', 'accountModal', 'carModal', 'appointmentModal', 'carSelectorModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                }
            });
            // Ø¥Ø¸Ù‡Ø§Ø± FAB ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
            showUIElements();
        }
        
        // Scroll to top function
        function scrollToTop() {
            // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ modals Ø§Ù„Ù…ÙØªÙˆØ­Ø©
            closeAllModals();
            // Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // Update active state
            updateActiveNav(0);
        }
        
        // Update active nav item
        function updateActiveNav(index) {
            document.querySelectorAll('.nav-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
        let startY = 0;
        
        sidebar.addEventListener('touchstart', function(e) {
            startY = e.touches[0].pageY;
        }, { passive: true });
        
        sidebar.addEventListener('touchmove', function(e) {
            const currentY = e.touches[0].pageY;
            const scrollTop = sidebar.scrollTop;
            const scrollHeight = sidebar.scrollHeight;
            const clientHeight = sidebar.clientHeight;
            
            const isAtTop = scrollTop <= 0 && currentY > startY;
            const isAtBottom = scrollTop + clientHeight >= scrollHeight && currentY < startY;
            
            if (isAtTop || isAtBottom) {
                e.preventDefault();
            }
        }, { passive: false });
    }
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    checkNotificationStatus();
});

// ==========================================
// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª - OneSignal + Firebase
// ==========================================

// OneSignal App ID
const ONESIGNAL_APP_ID = 'e158d77c-3eb7-4959-b6dc-de8a0b581880';

// Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ ÙÙŠ Median/GoNative
function isMedianApp() {
    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù…Ù…ÙƒÙ†Ø©
    return typeof Median !== 'undefined' ||      // Median Ø§Ù„Ø¬Ø¯ÙŠØ¯
           typeof median !== 'undefined' ||      // median Ø§Ù„Ù‚Ø¯ÙŠÙ…
           typeof gonative !== 'undefined' ||    // GoNative
           (window.plugins && window.plugins.OneSignal) ||  // OneSignal Plugin
           navigator.userAgent.includes('median') ||
           navigator.userAgent.includes('gonative') ||
           navigator.userAgent.includes('Median') ||
           navigator.userAgent.includes('GoNative') ||
           document.documentElement.classList.contains('median') ||
           window.isMedianApp === true;
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function isNotificationSupported() {
    // OneSignal Ù…ØªØ§Ø­
    if (typeof OneSignal !== 'undefined') {
        return true;
    }
    // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ·Ø¨ÙŠÙ‚ MedianØŒ Ù†Ø³ØªØ®Ø¯Ù… Native Push
    if (isMedianApp()) {
        return true;
    }
    return ('Notification' in window) && ('serviceWorker' in navigator) && ('PushManager' in window);
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø°Ù† Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø©
function getNotificationPermission() {
    // OneSignal
    if (typeof OneSignal !== 'undefined') {
        try {
            const permission = OneSignal.Notifications.permission;
            return permission ? 'granted' : 'default';
        } catch (e) {
            return 'default';
        }
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ·Ø¨ÙŠÙ‚ Median
    if (isMedianApp()) {
        const medianPushEnabled = localStorage.getItem('medianPushEnabled');
        if (medianPushEnabled === 'true') return 'granted';
        if (medianPushEnabled === 'false') return 'denied';
        return 'default';
    }
    
    if (!('Notification' in window)) {
        return 'unsupported';
    }
    return Notification.permission;
}

// Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø©
async function requestNotificationPermission() {
    // OneSignal
    if (typeof OneSignal !== 'undefined') {
        try {
            await OneSignal.Notifications.requestPermission();
            const permission = OneSignal.Notifications.permission;
            
            if (permission) {
                // Ø­ÙØ¸ OneSignal Player ID ÙÙŠ Firestore
                const playerId = await OneSignal.User.PushSubscription.id;
                if (playerId && currentUser) {
                    await db.collection('users').doc(currentUser.uid).update({
                        oneSignalPlayerId: playerId,
                        pushEnabled: true,
                        pushEnabledAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('âœ… OneSignal Player ID saved:', playerId);
                }
                return 'granted';
            }
            return 'denied';
        } catch (error) {
            console.error('OneSignal permission error:', error);
            return 'error';
        }
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ·Ø¨ÙŠÙ‚ Median
    if (isMedianApp()) {
        return await requestMedianPushPermission();
    }
    
    if (!('Notification' in window)) {
        console.log('âŒ Notifications not supported');
        return 'unsupported';
    }
    
    try {
        const permission = await Notification.requestPermission();
        return permission;
    } catch (error) {
        console.error('Error requesting permission:', error);
        return 'error';
    }
}

// Ø·Ù„Ø¨ Ø¥Ø°Ù† Median Push
async function requestMedianPushPermission() {
    return new Promise((resolve) => {
        try {
            // Median/GoNative Push API
            if (typeof median !== 'undefined' && median.onesignal) {
                median.onesignal.requestPermission();
                median.onesignal.onesignalInfo({
                    callback: function(info) {
                        if (info && info.oneSignalUserId) {
                            localStorage.setItem('medianPushEnabled', 'true');
                            localStorage.setItem('oneSignalUserId', info.oneSignalUserId);
                            console.log('âœ… Median Push enabled:', info.oneSignalUserId);
                            
                            // Ø­ÙØ¸ ÙÙŠ Firestore
                            if (currentUser) {
                                db.collection('users').doc(currentUser.uid).update({
                                    oneSignalPlayerId: info.oneSignalUserId,
                                    pushEnabled: true,
                                    platform: 'median_android'
                                });
                            }
                            resolve('granted');
                        } else {
                            resolve('default');
                        }
                    }
                });
            } else if (typeof gonative !== 'undefined' && gonative.onesignal) {
                gonative.onesignal.requestPermission();
                setTimeout(() => {
                    localStorage.setItem('medianPushEnabled', 'true');
                    resolve('granted');
                }, 1000);
            } else {
                console.log('âš ï¸ Median Push API not found');
                resolve('default');
            }
        } catch (error) {
            console.error('Error with Median Push:', error);
            resolve('error');
        }
    });
}

// Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠ
async function showLocalNotification(title, body, data = {}) {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ·Ø¨ÙŠÙ‚ Median - Ù†Ø³ØªØ®Ø¯Ù… Toast
    if (isMedianApp()) {
        showToast(`ğŸ”” ${title}: ${body}`, 'info');
        return;
    }
    
    // Ù„Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    if ('serviceWorker' in navigator && getNotificationPermission() === 'granted') {
        try {
            const registration = await navigator.serviceWorker.ready;
            await registration.showNotification(title, {
                body: body,
                icon: '/icons/icon-192x192.png',
                badge: '/icons/badge-72x72.png',
                dir: 'rtl',
                vibrate: [200, 100, 200],
                data: data
            });
        } catch (error) {
            console.error('Error showing notification:', error);
            showToast(`ğŸ”” ${title}: ${body}`, 'info');
        }
    } else {
        showToast(`ğŸ”” ${title}: ${body}`, 'info');
    }
}

// ØªÙØ¹ÙŠÙ„ Push Ø¹Ø¨Ø± Median API
async function enableMedianPush() {
    console.log('ğŸ“± Enabling Median Push...');
    
    try {
        // Median JavaScript Bridge API
        // https://median.co/docs/javascript-bridge
        
        // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 1: Median Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (typeof Median !== 'undefined') {
            console.log('ğŸ“± Found Median (new API)');
            
            if (Median.onesignal) {
                Median.onesignal.register();
                
                setTimeout(() => {
                    Median.onesignal.info().then(async (info) => {
                        console.log('ğŸ“± Median OneSignal Info:', info);
                        if (info && info.userId) {
                            await savePushToken(info.userId, 'median_new');
                            showToast('ğŸ”” ×”×”×ª×¨××•×ª ×”×•×¤×¢×œ×• ×‘×”×¦×œ×—×”!', 'success');
                            updateNotificationButton(true);
                        }
                    }).catch(err => {
                        console.log('Info error:', err);
                        // Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
                        showToast('ğŸ”” ×”×”×ª×¨××•×ª ×”×•×¤×¢×œ×•!', 'success');
                        updateNotificationButton(true);
                    });
                }, 2000);
                return;
            }
        }
        
        // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 2: median (lowercase) Ø§Ù„Ù‚Ø¯ÙŠÙ…
        if (typeof median !== 'undefined') {
            console.log('ğŸ“± Found median (old API)');
            
            if (median.onesignal) {
                median.onesignal.requestPermission();
                
                setTimeout(() => {
                    median.onesignal.onesignalInfo({
                        callback: async function(info) {
                            console.log('ğŸ“± Median OneSignal Info:', info);
                            if (info && (info.oneSignalUserId || info.userId)) {
                                await savePushToken(info.oneSignalUserId || info.userId, 'median_old');
                                showToast('ğŸ”” ×”×”×ª×¨××•×ª ×”×•×¤×¢×œ×• ×‘×”×¦×œ×—×”!', 'success');
                                updateNotificationButton(true);
                            } else {
                                // Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù†Ø¬Ø­
                                showToast('ğŸ”” ×”×”×ª×¨××•×ª ×”×•×¤×¢×œ×•!', 'success');
                                updateNotificationButton(true);
                            }
                        }
                    });
                }, 2000);
                return;
            }
        }
        
        // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 3: gonative
        if (typeof gonative !== 'undefined') {
            console.log('ğŸ“± Found gonative API');
            
            if (gonative.onesignal) {
                gonative.onesignal.requestPermission();
                setTimeout(async () => {
                    await savePushToken(null, 'gonative');
                    showToast('ğŸ”” ×”×”×ª×¨××•×ª ×”×•×¤×¢×œ×•!', 'success');
                    updateNotificationButton(true);
                }, 2000);
                return;
            }
        }
        
        // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 4: Ø¥Ø°Ø§ Automatic Registration Ù…ÙØ¹Ù„ ÙÙŠ Median
        // Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…ÙØ¹Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        console.log('ğŸ“± Trying automatic registration...');
        
        // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ window.plugins.OneSignal
        if (window.plugins && window.plugins.OneSignal) {
            console.log('ğŸ“± Found window.plugins.OneSignal');
            window.plugins.OneSignal.promptForPushNotificationsWithUserResponse(function(accepted) {
                console.log("User accepted notifications: " + accepted);
                if (accepted) {
                    showToast('ğŸ”” ×”×”×ª×¨××•×ª ×”×•×¤×¢×œ×•!', 'success');
                    updateNotificationButton(true);
                }
            });
            return;
        }
        
        // Ø¥Ø°Ø§ ÙˆØµÙ„Ù†Ø§ Ù‡Ù†Ø§ - Ù†ÙØªØ±Ø¶ Ø£Ù† Automatic Registration ÙŠØ¹Ù…Ù„
        console.log('ğŸ“± Assuming automatic registration is enabled');
        localStorage.setItem('medianPushEnabled', 'true');
        
        if (currentUser) {
            await db.collection('users').doc(currentUser.uid).update({
                pushEnabled: true,
                platform: 'median_auto',
                pushEnabledAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        showToast('ğŸ”” ×”×”×ª×¨××•×ª ××•×¤×¢×œ×•×ª ××•×˜×•××˜×™×ª!', 'success');
        updateNotificationButton(true);
        
    } catch (error) {
        console.error('Error enabling Median Push:', error);
        
        // Ø­ØªÙ‰ Ù…Ø¹ Ø§Ù„Ø®Ø·Ø£ØŒ Ø¥Ø°Ø§ ÙƒØ§Ù† Automatic Registration Ù…ÙØ¹Ù„ØŒ Ù‚Ø¯ ØªØ¹Ù…Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        showToast('â„¹ï¸ ×”×”×ª×¨××•×ª ×¢×©×•×™×•×ª ×œ×”×™×•×ª ××•×¤×¢×œ×•×ª ××•×˜×•××˜×™×ª', 'info');
        updateNotificationButton(true);
        localStorage.setItem('medianPushEnabled', 'true');
    }
}

// Ø­ÙØ¸ Push Token ÙÙŠ Firestore
async function savePushToken(token, platform) {
    localStorage.setItem('medianPushEnabled', 'true');
    if (token) {
        localStorage.setItem('oneSignalUserId', token);
    }
    
    if (currentUser) {
        const updateData = {
            pushEnabled: true,
            platform: platform,
            pushEnabledAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (token) {
            updateData.oneSignalPlayerId = token;
        }
        await db.collection('users').doc(currentUser.uid).update(updateData);
    }
    console.log('âœ… Push token saved:', token, platform);
}

// ØªÙØ¹ÙŠÙ„ Push Ø¹Ø¨Ø± OneSignal Web SDK
async function enableOneSignalPush() {
    console.log('ğŸ“± Enabling OneSignal Push...');
    
    try {
        // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
        await OneSignal.Notifications.requestPermission();
        
        const permission = OneSignal.Notifications.permission;
        console.log('OneSignal permission:', permission);
        
        if (permission) {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Player ID
            const playerId = await OneSignal.User.PushSubscription.id;
            console.log('OneSignal Player ID:', playerId);
            
            // Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (currentUser) {
                await OneSignal.login(currentUser.uid);
                
                // Ø¥Ø¶Ø§ÙØ© tags
                await OneSignal.User.addTags({
                    user_id: currentUser.uid,
                    email: currentUser.email || ''
                });
                
                // Ø­ÙØ¸ ÙÙŠ Firestore
                await db.collection('users').doc(currentUser.uid).update({
                    oneSignalPlayerId: playerId,
                    pushEnabled: true,
                    platform: 'web_onesignal',
                    pushEnabledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            showToast('ğŸ”” ×”×”×ª×¨××•×ª ×”×•×¤×¢×œ×• ×‘×”×¦×œ×—×”!', 'success');
            updateNotificationButton(true);
            console.log('âœ… OneSignal Push enabled');
        } else {
            showToast('âš ï¸ ×‘×§×©×ª ×”×”×ª×¨××•×ª ×‘×•×˜×œ×”', 'warning');
            updateNotificationButton(false);
        }
    } catch (error) {
        console.error('Error enabling OneSignal Push:', error);
        showToast('âš ï¸ ×©×’×™××” ×‘×”×¤×¢×œ×ª ×”×ª×¨××•×ª: ' + error.message, 'error');
    }
}

// ØªÙ‡ÙŠØ¦Ø© OneSignal Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function initOneSignalUser() {
    if (typeof OneSignal === 'undefined' || !currentUser) return;
    
    try {
        // Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù€ OneSignal
        await OneSignal.login(currentUser.uid);
        
        // Ø¥Ø¶Ø§ÙØ© tags Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await OneSignal.User.addTags({
            user_id: currentUser.uid,
            email: currentUser.email || '',
            platform: isMedianApp() ? 'android_app' : 'web'
        });
        
        console.log('âœ… OneSignal user initialized');
    } catch (error) {
        console.error('Error initializing OneSignal user:', error);
    }
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Toast
function showToast(message, type = 'info') {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Toast
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-[99999] transition-all duration-300';
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    const colors = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        warning: 'bg-yellow-500 text-white',
        info: 'bg-blue-500 text-white'
    };
    
    toast.className += ' ' + (colors[type] || colors.info);
    toast.textContent = message;
    toast.style.opacity = '0';
    
    // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    document.body.appendChild(toast);
    
    // Ø¹Ø±Ø¶ Ù…Ø¹ Animation
    setTimeout(() => {
        toast.style.opacity = '1';
    }, 10);
    
    // Ø¥Ø®ÙØ§Ø¡ ÙˆØ­Ø°Ù Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
async function checkNotificationStatus() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    if (!isNotificationSupported()) {
        console.log('âŒ Notifications not supported on this device/browser');
        updateNotificationButton(false, false, true); // not supported
        return;
    }
    
    if (!messaging) {
        console.log('Messaging not available');
        return;
    }
    
    if (!currentUser) return;
    
    try {
        // â­ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Firestore Ø£ÙˆÙ„Ø§Ù‹
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        const permission = getNotificationPermission();
        console.log('ğŸ“± Notification permission:', permission);
        console.log('ğŸ“± Firestore data:', {
            hasToken: !!userData?.fcmToken,
            disabled: userData?.notificationsDisabled
        });
        
        // â­ Ø¥Ø°Ø§ Ø§Ù„Ø¥Ø°Ù† Ù…Ø­Ø¸ÙˆØ±
        if (permission === 'denied') {
            updateNotificationButton(false, true); // blocked
            return;
        }
        
        // â­ Ø¥Ø°Ø§ Ø§Ù„Ø¥Ø°Ù† Ù…Ù…Ù†ÙˆØ­
        if (permission === 'granted') {
            // ØªØ­Ù‚Ù‚ Ù…Ù† Firestore
            const isEnabled = userData?.fcmToken && !userData?.notificationsDisabled;
            
            if (isEnabled) {
                updateNotificationButton(true); // Ù…ÙØ¹Ù‘Ù„
            } else {
                updateNotificationButton(false); // Ù…Ø·ÙÙŠ
            }
            return;
        }
        
        // â­ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø¨Ø¹Ø¯
        updateNotificationButton(false, false);
        
    } catch (error) {
        console.error('Error checking notification status:', error);
        updateNotificationButton(false, false);
    }
}

// ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function updateNotificationButton(enabled, blocked = false, notSupported = false) {
    const btn = document.getElementById('notificationToggleBtn');
    const text = document.getElementById('notificationBtnText');
    const icon = btn?.querySelector('.sidebar-icon');
    
    if (!btn || !text) return;
    
    if (notSupported) {
        // âŒ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…
        btn.style.background = 'rgba(156, 163, 175, 0.2)';
        btn.style.borderLeft = '4px solid #9ca3af';
        text.textContent = '×”×ª×¨××•×ª ×œ× × ×ª××›×•×ª';
        if (icon) icon.textContent = 'ğŸ“µ';
        btn.style.opacity = '0.6';
    } else if (enabled) {
        // âœ… Ù…ÙØ¹Ù‘Ù„
        btn.style.background = 'rgba(34, 197, 94, 0.2)';
        btn.style.borderLeft = '4px solid #22c55e';
        text.textContent = 'âœ“ ×”×ª×¨××•×ª ×¤×¢×™×œ×•×ª';
        if (icon) icon.textContent = 'ğŸ””';
        btn.style.opacity = '1';
    } else if (blocked) {
        // ğŸš« Ù…Ø­Ø¸ÙˆØ±
        btn.style.background = 'rgba(239, 68, 68, 0.1)';
        btn.style.borderLeft = '4px solid #ef4444';
        text.textContent = '×”×ª×¨××•×ª ×—×¡×•××•×ª';
        if (icon) icon.textContent = 'ğŸš«';
        btn.style.opacity = '1';
    } else {
        // âšª ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ (default)
        btn.style.background = 'transparent';
        btn.style.borderLeft = '';
        text.textContent = '×”×¤×¢×œ ×”×ª×¨××•×ª';
        if (icon) icon.textContent = 'ğŸ””';
        btn.style.opacity = '1';
    }
}

// ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
async function toggleNotifications() {
    if (!currentUser) {
        showToast('âš ï¸ × × ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×”', 'error');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    if (!isNotificationSupported()) {
        showToast('âš ï¸ ×”×”×ª×¨××•×ª ××™× ×Ÿ × ×ª××›×•×ª ×‘××›×©×™×¨ ×–×”', 'error');
        return;
    }
    
    try {
        // â­ Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ·Ø¨ÙŠÙ‚ Median - Ø§Ø³ØªØ®Ø¯Ù… Median API
        if (isMedianApp()) {
            console.log('ğŸ“± Using Median Push API...');
            await enableMedianPush();
            return;
        }
        
        // â­ Ø¥Ø°Ø§ ÙƒØ§Ù† OneSignal Ù…ØªØ§Ø­ - Ø§Ø³ØªØ®Ø¯Ù…Ù‡
        if (typeof OneSignal !== 'undefined') {
            console.log('ğŸ“± Using OneSignal API...');
            await enableOneSignalPush();
            return;
        }
        
        // â­ Ù„Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø¹Ø§Ø¯ÙŠ - Ø§Ø³ØªØ®Ø¯Ù… Firebase
        if (!messaging) {
            showToast('âš ï¸ ×”×ª×¨××•×ª ×œ× × ×ª××›×•×ª ×‘×“×¤×“×¤×Ÿ ×–×”', 'error');
            return;
        }
        
        const currentPermission = getNotificationPermission();
        console.log('Current permission status:', currentPermission);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙÙŠ Firestore
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        const isEnabled = userData?.fcmToken && !userData?.notificationsDisabled;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø© â†’ Ø¥ÙŠÙ‚Ø§Ù
        if (currentPermission === 'granted' && isEnabled) {
            console.log('ğŸ”• Disabling notifications...');
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    fcmToken: null,
                    notificationsDisabled: true,
                    notificationsDisabledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('ğŸ”• ×”×”×ª×¨××•×ª ×”×•×©×‘×ª×•', 'success');
                updateNotificationButton(false);
                console.log('âœ… Notifications disabled');
            } catch (error) {
                console.error('Error disabling notifications:', error);
                showToast('âš ï¸ ×©×’×™××” ×‘×”×©×‘×ª×ª ×”×ª×¨××•×ª', 'error');
            }
            return;
        }
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø­Ø¸ÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ (denied)
        if (currentPermission === 'denied') {
            showToast('âš ï¸ ×”×”×ª×¨××•×ª ×—×¡×•××•×ª. ×× × ××¤×©×¨ ××•×ª×Ÿ ×‘×”×’×“×¨×•×ª', 'warning');
            return;
        }
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        console.log('ğŸ”” Enabling notifications...');
        
        if (currentPermission === 'granted') {
            await getNotificationToken();
            
            await db.collection('users').doc(currentUser.uid).update({
                notificationsDisabled: false,
                notificationsEnabledAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('ğŸ”” ×”×”×ª×¨××•×ª ×”×•×¤×¢×œ×•!', 'success');
            updateNotificationButton(true);
            return;
        }
        
        // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
        const permission = await requestNotificationPermission();
        
        if (permission === 'unsupported') {
            showToast('âš ï¸ ×”×”×ª×¨××•×ª ××™× ×Ÿ × ×ª××›×•×ª ×‘×“×¤×“×¤×Ÿ ×–×”', 'error');
            return;
        }
        
        if (permission === 'granted') {
            console.log('âœ… Notification permission granted!');
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
            await getNotificationToken();
            
            // ØªØ­Ø¯ÙŠØ« Firestore
            await db.collection('users').doc(currentUser.uid).update({
                notificationsDisabled: false,
                notificationsEnabledAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showToast('ğŸ”” ×”×”×ª×¨××•×ª ×”×•×¤×¢×œ×• ×‘×”×¦×œ×—×”!', 'success');
            updateNotificationButton(true);
        } else if (permission === 'denied') {
            console.log('âŒ Notification permission denied');
            showToast('âŒ ×”×”×¨×©××” ×œ×”×ª×¨××•×ª × ×“×—×ª×”', 'error');
            updateNotificationButton(false, true);
        } else {
            console.log('â„¹ï¸ Notification permission dismissed');
            showToast('â„¹ï¸ ×‘×§×©×ª ×”×”×ª×¨××•×ª ×‘×•×˜×œ×”', 'info');
        }
    } catch (error) {
        console.error('Error toggling notifications:', error);
        showToast('âš ï¸ ×©×’×™××”: ' + error.message, 'error');
    }
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
async function getNotificationToken() {
    if (!messaging || !currentUser) return;
    
    try {
        console.log('ğŸ”” Starting notification token registration...');
        
        // Ø®Ø·ÙˆØ© 1: Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØµØ¨Ø­ Service Worker Ø¬Ø§Ù‡Ø²
        await navigator.serviceWorker.ready;
        console.log('âœ… Main Service Worker is ready');
        
        // Ø®Ø·ÙˆØ© 2: ØªØ³Ø¬ÙŠÙ„ firebase-messaging-sw Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„
        let messagingRegistration;
        try {
            messagingRegistration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', {
                scope: '/',
                updateViaCache: 'none'
            });
            console.log('âœ… Firebase Messaging SW registered:', messagingRegistration);
            
            // Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØµØ¨Ø­ Ù†Ø´Ø·
            if (messagingRegistration.installing) {
                await new Promise((resolve) => {
                    messagingRegistration.installing.addEventListener('statechange', (e) => {
                        if (e.target.state === 'activated') {
                            console.log('âœ… Messaging SW activated');
                            resolve();
                        }
                    });
                });
            }
        } catch (swError) {
            console.error('âŒ Failed to register messaging SW:', swError);
            throw new Error('Failed to register messaging service worker');
        }
        
        // Ø®Ø·ÙˆØ© 3: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†
        console.log('ğŸ”‘ Getting FCM token...');
        let currentToken = null;
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ VAPID Key
        const vapidKey = 'BDJ7InAeHqovFzryLHPltWqqYokGOPBdlFaJrBiIx0BcsSCg9DbsKD2LRmsLO5fi1-H8sjEBMWvRhQuOd943aHM';
        
        try {
            currentToken = await messaging.getToken({
                vapidKey: vapidKey,
                serviceWorkerRegistration: messagingRegistration
            });
        } catch (tokenError) {
            console.error('âŒ Error getting token with VAPID:', tokenError);
            console.log('â„¹ï¸ Trying without VAPID key...');
            
            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙˆÙ† VAPID
                currentToken = await messaging.getToken({
                    serviceWorkerRegistration: messagingRegistration
                });
            } catch (fallbackError) {
                console.error('âŒ Both token attempts failed:', fallbackError);
                throw new Error('Cannot get notification token. Please check Firebase configuration.');
            }
        }
        
        if (currentToken) {
            console.log('âœ… FCM Token obtained:', currentToken.substring(0, 20) + '...');
            
            // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Firestore
            await db.collection('users').doc(currentUser.uid).update({
                fcmToken: currentToken,
                fcmTokenUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                notificationsEnabled: true
            });
            
            console.log('âœ… Token saved to Firestore');
            showToast('âœ… ×”×”×ª×¨××•×ª ×”×•×¤×¢×œ×• ×‘×”×¦×œ×—×”!', 'success');
            updateNotificationButton(true);
            
            // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ÙØªÙˆØ­
            messaging.onMessage((payload) => {
                console.log('ğŸ“© Message received:', payload);
                showInAppNotification(payload);
            });
            
        } else {
            console.log('âš ï¸ No registration token available');
            showToast('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ××¡×™××•×Ÿ ×”×ª×¨××•×ª', 'warning');
        }
    } catch (error) {
        console.error('âŒ Full error getting notification token:', error);
        console.error('Error stack:', error.stack);
        showToast('âš ï¸ ×©×’×™××” ×‘×”×¤×¢×œ×ª ×”×”×ª×¨××•×ª: ' + error.message, 'error');
        updateNotificationButton(false);
    }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
function showInAppNotification(payload) {
    const title = payload.notification?.title || 'DRVN';
    const body = payload.notification?.body || '×™×© ×œ×š ×¢×“×›×•×Ÿ ×—×“×©';
    
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…Ø®ØµØµØ© Ù‡Ù†Ø§
    showToast(`ğŸ”” ${title}: ${body}`, 'info');
    
    // ØªØ´ØºÙŠÙ„ ØµÙˆØª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    playNotificationSound();
}

// ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
function playNotificationSound() {
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
        audio.volume = 0.3;
        audio.play().catch(e => console.log('Could not play sound:', e));
    } catch (e) {
        console.log('Audio not supported');
    }
}

// Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
async function sendTestNotification() {
    if (!currentUser) {
        showToast('âš ï¸ × × ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×”', 'error');
        return;
    }
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const fcmToken = userDoc.data()?.fcmToken;
        
        if (!fcmToken) {
            showToast('âš ï¸ × × ×œ×”×¤×¢×™×œ ×”×ª×¨××•×ª ×ª×—×™×œ×”', 'error');
            return;
        }
        
        showToast('ğŸ“¨ ×©×•×œ×— ×”×ª×¨××ª ×‘×“×™×§×”...', 'info');
        
        // Ù‡Ù†Ø§ Ø³ØªØ­ØªØ§Ø¬ Ù„Ø¥Ù†Ø´Ø§Ø¡ Cloud Function ÙÙŠ Firebase Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        // Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Admin SDK Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
        
        console.log('Test notification would be sent to:', fcmToken);
        
    } catch (error) {
        console.error('Error sending test notification:', error);
        showToast('âš ï¸ ×©×’×™××” ×‘×©×œ×™×—×ª ×”×ª×¨××”', 'error');
    }
}
    </script>
        <script>
// ==========================================
// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ (Ø¨Ø¯ÙˆÙ† Cloud Functions)
// ==========================================

// 1ï¸âƒ£ ÙØ­Øµ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© (ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚)
async function checkUpcomingAppointments() {
    if (!currentUser) return;
    
    const now = new Date();
    const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
    
    try {
        // â­ Ù†Ø³ØªØ¹Ù„Ù… ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙÙ‡Ø±Ø³Ø© (date + notificationSent)
        const appointmentsSnapshot = await db.collection('appointments')
            .where('userId', '==', currentUser.uid)
            .where('date', '>=', now)
            .where('notificationSent', '==', false)  // â­ Ø§Ø³ØªØ®Ø¯Ù… == Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† !=
            .get();
        
        // â­ ÙÙ„ØªØ±Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø®Ù„Ø§Ù„ Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©
        const upcomingAppointments = appointmentsSnapshot.docs.filter(doc => {
            const appointmentDate = doc.data().date.toDate();
            return appointmentDate <= oneHourLater;
        });
        
        for (const doc of upcomingAppointments) {
            const appointment = doc.data();
            
            try {
                const carDoc = await db.collection('cars').doc(appointment.carId).get();
                if (!carDoc.exists) continue;
                
                const car = carDoc.data();
                const carInfo = `${car.manufacturer} ${car.model} (${car.licensePlate})`;
                
                // â­ Ø§Ø³ØªØ®Ø¯Ø§Ù… Service Worker Notification (Ø£ÙØ¶Ù„!)
                if (getNotificationPermission() === 'granted' && 'serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification('â° ×ª×–×›×•×¨×ª: ×¤×’×™×©×” ×‘×¢×•×“ ×©×¢×”', {
                            body: `×¤×’×™×©×” ×¢× ${carInfo} ×‘×©×¢×” ${appointment.time}`,
                            icon: '/icon-192.png',
                            badge: '/icon-192.png',
                            tag: `appointment-${doc.id}`,
                            requireInteraction: true,
                            vibrate: [200, 100, 200],
                            dir: 'rtl',
                            data: {
                                type: 'appointment',
                                appointmentId: doc.id,
                                carId: appointment.carId
                            }
                        });
                    });
                }
                
                await doc.ref.update({
                    notificationSent: true,
                    notificationSentAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('âœ… Appointment notification sent for:', carInfo);
            } catch (carError) {
                console.error('Error processing appointment:', carError);
            }
        }
    } catch (error) {
        console.error('Error checking appointments:', error);
    }
}

// 2ï¸âƒ£ ÙØ­Øµ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© (ÙƒÙ„ Ø³Ø§Ø¹Ø©)
async function checkUnpaidInvoices() {
    if (!currentUser) return;
    
    const threeDaysAgo = new Date();
    threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
    
    try {
        const carsSnapshot = await db.collection('cars')
            .where('userId', '==', currentUser.uid)
            .where('paymentStatus', '==', 'unpaid')
            .where('updatedAt', '<=', firebase.firestore.Timestamp.fromDate(threeDaysAgo))
            .get();
        
        const today = new Date().toDateString();
        const lastCheck = localStorage.getItem('lastUnpaidCheck');
        
        if (lastCheck === today) return;
        
        if (!carsSnapshot.empty && getNotificationPermission() === 'granted' && 'serviceWorker' in navigator) {
            const count = carsSnapshot.size;
            
            navigator.serviceWorker.ready.then(registration => {
                registration.showNotification('ğŸ’° ×ª×–×›×•×¨×ª: ×—×©×‘×•× ×™×•×ª ×××ª×™× ×•×ª', {
                    body: `×™×© ×œ×š ${count} ×—×©×‘×•× ×™×•×ª ×××ª×™× ×•×ª ×œ×ª×©×œ×•×`,
                    icon: '/icon-192.png',
                    badge: '/icon-192.png',
                    tag: 'unpaid-invoices',
                    requireInteraction: true,
                    vibrate: [200, 100, 200],
                    dir: 'rtl',
                    data: {
                        type: 'unpaid-invoices',
                        count: count
                    }
                });
            });
            
            localStorage.setItem('lastUnpaidCheck', today);
        }
    } catch (error) {
        console.error('Error checking unpaid invoices:', error);
    }
}

// 3ï¸âƒ£ ÙØ­Øµ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (ÙŠÙˆÙ…ÙŠØ§Ù‹)
async function checkSubscriptionExpiry() {
    if (!currentUser) return;
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (!userData.subscriptionEndDate) return;
        
        const endDate = userData.subscriptionEndDate.toDate();
        const now = new Date();
        const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
        
        const today = new Date().toDateString();
        const lastCheck = localStorage.getItem('lastSubscriptionCheck');
        
        if (lastCheck === today) return;
        
        let title, body;
        
        if (daysLeft <= 0) {
            title = 'âŒ ×”×× ×•×™ ×¤×’ ×ª×•×§×£';
            body = '×”×× ×•×™ ×©×œ×š ×¤×’ ×ª×•×§×£. ×—×“×© ××•×ª×• ×¢×›×©×™×•';
        } else if (daysLeft <= 3) {
            title = 'âš ï¸ ×”×× ×•×™ ××¡×ª×™×™× ×‘×§×¨×•×‘';
            body = `×”×× ×•×™ ×©×œ×š ××¡×ª×™×™× ×‘×¢×•×“ ${daysLeft} ×™××™×`;
        } else if (daysLeft <= 7) {
            title = 'â° ×”×× ×•×™ ××¡×ª×™×™× ×‘×¢×•×“ ×©×‘×•×¢';
            body = `×”×× ×•×™ ×©×œ×š ××¡×ª×™×™× ×‘×¢×•×“ ${daysLeft} ×™××™×`;
        } else {
            localStorage.setItem('lastSubscriptionCheck', today);
            return;
        }
        
        if (getNotificationPermission() === 'granted' && 'serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                registration.showNotification(title, {
                    body: body,
                    icon: '/icon-192.png',
                    badge: '/icon-192.png',
                    tag: 'subscription-expiry',
                    requireInteraction: true,
                    vibrate: [300, 100, 300],
                    dir: 'rtl',
                    data: {
                        type: 'subscription',
                        daysLeft: daysLeft
                    }
                });
            });
        }
        
        localStorage.setItem('lastSubscriptionCheck', today);
    } catch (error) {
        console.error('Error checking subscription:', error);
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­ÙˆØµØ§Øª
auth.onAuthStateChanged((user) => {
    if (user && getNotificationPermission() === 'granted') {
        // ÙØ­Øµ ÙÙˆØ±ÙŠ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        setTimeout(() => {
            checkUpcomingAppointments();
            checkUnpaidInvoices();
            checkSubscriptionExpiry();
        }, 5000);
        
        // ÙØ­Øµ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚
        setInterval(checkUpcomingAppointments, 10 * 60 * 1000);
        
        // ÙØ­Øµ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙƒÙ„ Ø³Ø§Ø¹Ø©
        setInterval(checkUnpaidInvoices, 60 * 60 * 1000);
        
        // ÙØ­Øµ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª
        setInterval(checkSubscriptionExpiry, 6 * 60 * 60 * 1000);
    }
});

// ========== Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ==========
async function testNotifications() {
    console.log('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...');
    
    // 1. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø°Ù†
    if (getNotificationPermission() !== 'granted') {
        console.log('âŒ Ø§Ù„Ø¥Ø°Ù† ØºÙŠØ± Ù…Ù…Ù†ÙˆØ­');
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©!');
        return;
    }
    
    // 2. ØªØ­Ù‚Ù‚ Ù…Ù† Service Worker
    if (!('serviceWorker' in navigator)) {
        console.log('âŒ Service Worker ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
        alert('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Service Worker');
        return;
    }
    
    try {
        const registration = await navigator.serviceWorker.ready;
        console.log('âœ… Service Worker Ø¬Ø§Ù‡Ø²');
        
        // 3. Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø­ÙŠØ¨ÙŠ (ÙÙˆØ±Ø§Ù‹)
        await registration.showNotification('ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ DRVN!', {
            body: 'Ø³Ù†Ø±Ø³Ù„ Ù„Ùƒ 3 Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©',
            icon: '/icon-192.png',
            badge: '/icon-192.png',
            tag: 'test-welcome',
            dir: 'rtl',
            requireInteraction: false
        });
        console.log('âœ… Ø¥Ø´Ø¹Ø§Ø± 1: ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡');
        
        // 4. Ø¥Ø´Ø¹Ø§Ø± Ù…ÙˆØ¹Ø¯ (Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ)
        setTimeout(async () => {
            await registration.showNotification('â° ×ª×–×›×•×¨×ª: ×¤×’×™×©×” ×‘×¢×•×“ ×©×¢×”', {
                body: '×¤×’×™×©×” ×¢× ×˜×•×™×•×˜×” ×§×××¨×™ (123-456) ×‘×¢×•×“ ×©×¢×” ××—×ª',
                icon: '/icon-192.png',
                badge: '/icon-192.png',
                tag: 'test-appointment',
                dir: 'rtl',
                requireInteraction: true,
                vibrate: [200, 100, 200]
            });
            console.log('âœ… Ø¥Ø´Ø¹Ø§Ø± 2: ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡');
        }, 3000);
        
        // 5. Ø¥Ø´Ø¹Ø§Ø± Ø³ÙŠØ§Ø±Ø© Ø¬Ø§Ù‡Ø²Ø© (Ø¨Ø¹Ø¯ 6 Ø«ÙˆØ§Ù†ÙŠ)
        setTimeout(async () => {
            await registration.showNotification('âœ… ×”×¨×›×‘ ××•×›×Ÿ ×œ××™×¡×•×£!', {
                body: 'BMW X5 (789-012) ××•×›×Ÿ ×œ××™×¡×•×£',
                icon: '/icon-192.png',
                badge: '/icon-192.png',
                tag: 'test-car-ready',
                dir: 'rtl',
                vibrate: [300, 100, 300, 100, 300],
                requireInteraction: true
            });
            console.log('âœ… Ø¥Ø´Ø¹Ø§Ø± 3: ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡');
        }, 6000);
        
        console.log('â³ Ø§Ù†ØªØ¸Ø± 10 Ø«ÙˆØ§Ù†ÙŠ Ù„Ø±Ø¤ÙŠØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...');
        showToast('âœ… × ×©×œ×—×• 3 ×”×ª×¨××•×ª × ×™×¡×™×•×Ÿ!', 'success');
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
        showToast('âš ï¸ ×©×’×™××”: ' + error.message, 'error');
    }
}

// Make functions globally accessible for onclick handlers
window.restoreBackup = restoreBackup;
window.showBackupList = showBackupList;
window.openBackupModal = openBackupModal;
window.closeBackupModal = closeBackupModal;
window.createAutoBackup = createAutoBackup;

// ==========================================
// ğŸ”” Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
// ==========================================

// ÙØ­Øµ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ±Ø§Øª
async function checkAndSendReminders() {
    if (!currentUser || !appointments || appointments.length === 0) {
        return;
    }
    
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ØºØ¯
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    for (const apt of appointments) {
        if (!apt.date || !apt.time) continue;
        
        const aptDateTime = new Date(`${apt.date}T${apt.time}`);
        const timeDiff = aptDateTime - now;
        const hoursDiff = timeDiff / (1000 * 60 * 60);
        
        // Ù…ÙØªØ§Ø­ Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ù…ÙØ±Ø³Ù„Ø©
        const reminderKey = `reminder_${apt.id || apt.date + apt.time}`;
        const sentReminders = JSON.parse(localStorage.getItem('sentReminders') || '{}');
        
        // ØªØ°ÙƒÙŠØ± Ù‚Ø¨Ù„ 24 Ø³Ø§Ø¹Ø©
        if (hoursDiff <= 24 && hoursDiff > 23 && !sentReminders[reminderKey + '_24h']) {
            await sendAppointmentPushNotification(apt, '24h');
            sentReminders[reminderKey + '_24h'] = true;
            localStorage.setItem('sentReminders', JSON.stringify(sentReminders));
        }
        
        // ØªØ°ÙƒÙŠØ± Ù‚Ø¨Ù„ Ø³Ø§Ø¹Ø©
        if (hoursDiff <= 1 && hoursDiff > 0 && !sentReminders[reminderKey + '_1h']) {
            await sendAppointmentPushNotification(apt, '1h');
            sentReminders[reminderKey + '_1h'] = true;
            localStorage.setItem('sentReminders', JSON.stringify(sentReminders));
        }
    }
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 7 Ø£ÙŠØ§Ù…)
    cleanOldReminders();
}

// Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Push Ù„Ù„Ù…ÙˆØ¹Ø¯
async function sendAppointmentPushNotification(appointment, type) {
    try {
        const registration = await navigator.serviceWorker.ready;
        
        let title, body;
        
        if (type === '24h') {
            title = 'ğŸ“… ×ª×–×›×•×¨×ª: ×¤×’×™×©×” ××—×¨';
            body = `${appointment.customerName || '×œ×§×•×—'} - ${appointment.time} - ${appointment.description || '×˜×™×¤×•×œ'}`;
        } else if (type === '1h') {
            title = 'â° ×ª×–×›×•×¨×ª: ×¤×’×™×©×” ×‘×¢×•×“ ×©×¢×”!';
            body = `${appointment.customerName || '×œ×§×•×—'} - ${appointment.time} - ${appointment.description || '×˜×™×¤×•×œ'}`;
        }
        
        await registration.showNotification(title, {
            body: body,
            icon: '/icons/icon-192x192.png',
            badge: '/icons/badge-72x72.png',
            tag: `appointment-${type}-${appointment.id}`,
            dir: 'rtl',
            vibrate: [200, 100, 200],
            requireInteraction: true,
            actions: [
                { action: 'view', title: '×¦×¤×”' },
                { action: 'call', title: '×”×ª×§×©×¨' }
            ],
            data: {
                appointmentId: appointment.id,
                phone: appointment.customerPhone || appointment.phone,
                type: 'appointment_reminder'
            }
        });
        
        console.log(`âœ… Reminder sent (${type}):`, appointment.customerName);
        
    } catch (error) {
        console.error('âŒ Error sending reminder:', error);
    }
}

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
function cleanOldReminders() {
    const sentReminders = JSON.parse(localStorage.getItem('sentReminders') || '{}');
    const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    
    // Ø­Ø°Ù Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    let cleaned = false;
    for (const key in sentReminders) {
        if (sentReminders[key] === true) {
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¥Ù„Ù‰ timestamp Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
            // Ù†Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        }
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹
    const lastClean = localStorage.getItem('lastReminderClean');
    if (!lastClean || Date.now() - parseInt(lastClean) > 7 * 24 * 60 * 60 * 1000) {
        localStorage.setItem('sentReminders', '{}');
        localStorage.setItem('lastReminderClean', Date.now().toString());
    }
}

// Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©
function startReminderChecker() {
    // ÙØ­Øµ ÙÙˆØ±ÙŠ
    checkAndSendReminders();
    
    // ÙØ­Øµ ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©
    setInterval(checkAndSendReminders, 15 * 60 * 1000);
    
    console.log('âœ… Reminder checker started (every 15 minutes)');
}

// Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± ÙŠØ¯ÙˆÙŠ Ø¹Ø¨Ø± WhatsApp
function sendWhatsAppReminder(appointment) {
    const phone = appointment.customerPhone || appointment.phone;
    if (!phone) {
        showToast('âš ï¸ ××™×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ', 'warning');
        return;
    }
    
    // ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    let cleanPhone = phone.replace(/\D/g, '');
    if (cleanPhone.startsWith('0')) {
        cleanPhone = '972' + cleanPhone.substring(1);
    }
    
    const message = encodeURIComponent(
        `×©×œ×•× ${appointment.customerName || ''}! ğŸ‘‹\n\n` +
        `×ª×–×›×•×¨×ª ×œ×¤×’×™×©×” ×©×œ×š ×‘××•×¡×š:\n` +
        `ğŸ“… ×ª××¨×™×š: ${appointment.date}\n` +
        `ğŸ• ×©×¢×”: ${appointment.time}\n` +
        `ğŸ”§ ×¡×•×’ ×˜×™×¤×•×œ: ${appointment.description || '×˜×™×¤×•×œ'}\n\n` +
        `× ×©××— ×œ×¨××•×ª×š! ğŸš—`
    );
    
    window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
}

// ØªØ´ØºÙŠÙ„ ÙØ§Ø­Øµ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
document.addEventListener('DOMContentLoaded', () => {
    // Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
    setTimeout(() => {
        if (currentUser) {
            startReminderChecker();
        }
    }, 5000);
    
    // ØªÙ‡ÙŠØ¦Ø© Median Push Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ ÙÙŠ Median
    if (isMedianApp()) {
        console.log('ğŸ“± Running in Median/GoNative app');
        initMedianPush();
    }
});

// ØªÙ‡ÙŠØ¦Ø© Median Push
function initMedianPush() {
    try {
        // OneSignal ÙÙŠ Median
        if (typeof median !== 'undefined' && median.onesignal) {
            console.log('âœ… Median OneSignal available');
            
            // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Push
            median.onesignal.onesignalInfo({
                callback: function(info) {
                    if (info && info.oneSignalUserId) {
                        console.log('ğŸ“± OneSignal User ID:', info.oneSignalUserId);
                        localStorage.setItem('oneSignalUserId', info.oneSignalUserId);
                        localStorage.setItem('medianPushEnabled', 'true');
                        
                        // Ø­ÙØ¸ ÙÙŠ Firestore
                        if (currentUser) {
                            db.collection('users').doc(currentUser.uid).update({
                                oneSignalUserId: info.oneSignalUserId,
                                pushEnabled: true,
                                platform: 'median_android'
                            }).then(() => {
                                console.log('âœ… OneSignal ID saved to Firestore');
                            });
                        }
                    }
                }
            });
        }
        
        // GoNative API
        if (typeof gonative !== 'undefined') {
            console.log('âœ… GoNative available');
        }
        
    } catch (error) {
        console.error('Error initializing Median Push:', error);
    }
}

// Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù€ window object
window.sendWhatsAppReminder = sendWhatsAppReminder;
window.checkAndSendReminders = checkAndSendReminders;
window.isMedianApp = isMedianApp;
window.showLocalNotification = showLocalNotification;
    </script>

</body>
</html>