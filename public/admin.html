<!DOCTYPE html>
<!-- DRVN Admin Dashboard v3.2 - Updated: 2024-11-20 -->
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ×‘×§×¨×” ××ª×§×“× - DRVN Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 28px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #f59e0b, #d97706);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        
        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }
        
        .stat-icon {
            width: 72px;
            height: 72px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.25) 100%);
        }
        
        .stat-card:hover .stat-icon {
            transform: scale(1.15) rotate(8deg);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .payment-row {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .payment-row:hover {
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%);
            border-left-color: #f59e0b;
            transform: translateX(-4px);
        }
        
        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .badge-pending {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }
        
        .badge-confirmed {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
        }
        
        .badge-active {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }
        
        .badge-expired {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
        }
        
        .badge-trial {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #3730a3;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 12px 28px;
            border-radius: 12px;
            font-weight: 700;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 14px;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.5);
        }
        
        .btn-primary:active {
            transform: translateY(-1px);
        }
        
        .btn-action {
            padding: 8px 18px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-extend {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-extend:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 18px rgba(59, 130, 246, 0.4);
        }
        
        .btn-cancel {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }
        
        .btn-cancel:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 18px rgba(249, 115, 22, 0.4);
        }
        
        .btn-verify {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .btn-verify:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 18px rgba(139, 92, 246, 0.4);
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .btn-delete:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 18px rgba(239, 68, 68, 0.5);
        }
        
        .filter-btn {
            padding: 10px 22px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
            background: white;
            color: #64748b;
        }
        
        .filter-btn:hover {
            background: #f8fafc;
            transform: translateY(-2px);
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-color: #f59e0b;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        
        .tab-button {
            padding: 16px 32px;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tab-button:hover {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }
        
        .tab-button.active {
            color: #f59e0b;
            border-bottom-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .card-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .table-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 13px;
            color: #475569;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }
        
        .animate-pulse-slow {
            animation: pulse 3s ease-in-out infinite;
        }
        
        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        body.dark-mode .stat-card,
        body.dark-mode .card-container,
        body.dark-mode .glass-effect {
            background: rgba(30, 30, 46, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
            color: #e5e7eb;
        }
        
        body.dark-mode .table-header {
            background: linear-gradient(135deg, #1e1e2e 0%, #252538 100%);
            color: #9ca3af;
        }
        
        body.dark-mode .payment-row {
            color: #d1d5db;
        }
        
        body.dark-mode .payment-row:hover {
            background: rgba(245, 158, 11, 0.1);
        }
        
        body.dark-mode .filter-btn {
            background: rgba(30, 30, 46, 0.8);
            color: #9ca3af;
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        body.dark-mode .filter-btn:hover {
            background: rgba(40, 40, 56, 0.9);
        }
        
        body.dark-mode .filter-btn.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        body.dark-mode tbody {
            background: rgba(30, 30, 46, 0.5);
        }
        
        /* Notifications Styles */
        .notification {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 320px;
            animation: slideInRight 0.4s ease-out;
            border-left: 4px solid;
            position: relative;
            overflow: hidden;
        }
        
        .notification::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: currentColor;
            animation: shrink 5s linear forwards;
        }
        
        @keyframes shrink {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        .notification.success {
            border-left-color: #10b981;
        }
        
        .notification.success::before {
            background: #10b981;
        }
        
        .notification.error {
            border-left-color: #ef4444;
        }
        
        .notification.error::before {
            background: #ef4444;
        }
        
        .notification.info {
            border-left-color: #3b82f6;
        }
        
        .notification.info::before {
            background: #3b82f6;
        }
        
        .notification.warning {
            border-left-color: #f59e0b;
        }
        
        .notification.warning::before {
            background: #f59e0b;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 2px;
            color: #1f2937;
        }
        
        .notification-message {
            font-size: 13px;
            color: #6b7280;
        }
        
        body.dark-mode .notification {
            background: rgba(30, 30, 46, 0.95);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        body.dark-mode .notification-title {
            color: #e5e7eb;
        }
        
        body.dark-mode .notification-message {
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect p-10 rounded-3xl shadow-2xl max-w-md w-full animate-slide-in">
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full mb-4 animate-pulse-slow">
                    <span class="text-5xl">ğŸ”</span>
                </div>
                <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">×œ×•×— ×‘×§×¨×” ××ª×§×“×</h1>
                <p class="text-gray-600 font-medium">××¢×¨×›×ª × ×™×”×•×œ DRVN Pro</p>
                <div class="mt-3 inline-block px-4 py-2 bg-red-50 border-2 border-red-300 rounded-full">
                    <p class="text-red-600 text-sm font-bold">âš ï¸ ×œ×× ×”×œ×™× ×‘×œ×‘×“ Â· Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡ ÙÙ‚Ø·</p>
                </div>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">××™××™×™×œ ×× ×”×œ</label>
                    <input type="email" id="adminEmail" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 focus:outline-none transition-all" placeholder="admin@drvn.com">
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">×¡×™×¡××”</label>
                    <input type="password" id="adminPassword" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 focus:outline-none transition-all" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                
                <button onclick="adminLogin()" class="btn-primary w-full">
                    ğŸ”“ ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª
                </button>
                
                <div id="loginError" class="hidden bg-red-50 border-2 border-red-300 text-red-700 px-4 py-3 rounded-xl text-sm font-medium"></div>
                
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-5 rounded-xl text-sm">
                    <p class="font-bold mb-2 text-blue-900">ğŸ’¡ ×”×¢×¨×” ×—×©×•×‘×”</p>
                    <p class="text-blue-800">×“×£ ×–×” ××™×•×¢×“ ×œ×× ×”×œ×™ ×”××¢×¨×›×ª ×‘×œ×‘×“.</p>
                    <p class="mt-2 text-blue-800">Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ø¹Ø§Ø¯ÙŠØ§Ù‹ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen">
        <!-- Notifications Container -->
        <div id="notificationsContainer" class="fixed top-4 left-4 z-50 space-y-3 max-w-md"></div>
        
        <!-- Header -->
        <header class="header-gradient text-white sticky top-0 z-40">
            <div class="container mx-auto px-6 py-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-1">ğŸš— DRVN Pro Dashboard</h1>
                    <p class="text-purple-100 font-medium">××¢×¨×›×ª × ×™×”×•×œ ××ª×§×“××ª</p>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleDarkMode()" id="darkModeBtn" class="bg-white/20 backdrop-blur-sm hover:bg-white/30 p-3 rounded-xl transition-all border border-white/30" title="×”×—×œ×£ ××¦×‘ ×ª×¦×•×’×”">
                        <span id="darkModeIcon" class="text-2xl">ğŸŒ™</span>
                    </button>
                    
                    <!-- Admin Info & Logout -->
                    <div class="text-left">
                        <p class="text-purple-100 font-medium mb-2" id="adminEmailDisplay">ğŸ‘¤ ×× ×”×œ</p>
                        <button onclick="logout()" class="bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white px-6 py-2 rounded-xl font-bold transition-all border border-white/30">
                            ğŸšª ×”×ª× ×ª×§
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="container mx-auto px-6 py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Total Users -->
                <div class="stat-card animate-slide-in">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="text-gray-500 text-sm font-semibold mb-2 uppercase tracking-wide">×¡×š ×›×œ ×”××©×ª××©×™×</p>
                            <p id="totalUsers" class="stat-value">-</p>
                            <p class="text-gray-400 text-xs mt-1 font-medium">Total Users</p>
                        </div>
                        <div class="stat-icon">
                            <span>ğŸ‘¥</span>
                        </div>
                    </div>
                </div>

                <!-- Active Subscriptions -->
                <div class="stat-card animate-slide-in" style="animation-delay: 0.1s">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="text-gray-500 text-sm font-semibold mb-2 uppercase tracking-wide">×× ×•×™×™× ×¤×¢×™×œ×™×</p>
                            <p id="activeSubscriptions" class="stat-value" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">-</p>
                            <p class="text-gray-400 text-xs mt-1 font-medium">Active Subscriptions</p>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.25) 100%);">
                            <span>âœ…</span>
                        </div>
                    </div>
                </div>

                <!-- Pending Payments -->
                <div class="stat-card animate-slide-in" style="animation-delay: 0.2s">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="text-gray-500 text-sm font-semibold mb-2 uppercase tracking-wide">×ª×©×œ×•××™× ×××ª×™× ×™×</p>
                            <p id="pendingPayments" class="stat-value" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">-</p>
                            <p class="text-gray-400 text-xs mt-1 font-medium">Pending Payments</p>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.25) 100%);">
                            <span>â³</span>
                        </div>
                    </div>
                </div>

                <!-- Monthly Revenue - HIDDEN -->
                <div class="stat-card animate-slide-in hidden" style="animation-delay: 0.3s" id="revenueCard">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="text-gray-500 text-sm font-semibold mb-2 uppercase tracking-wide">×”×›× ×¡×” ×—×•×“×©×™×ª</p>
                            <p id="monthlyRevenue" class="stat-value" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">-</p>
                            <p class="text-gray-400 text-xs mt-1 font-medium">Monthly Revenue</p>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.25) 100%);">
                            <span>ğŸ’°</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="card-container mb-8">
                <div class="border-b border-gray-100">
                    <nav class="flex">
                        <button onclick="switchTab('payments')" id="paymentsTab" class="tab-button active">
                            ğŸ’³ ×ª×©×œ×•××™×
                        </button>
                        <button onclick="switchTab('users')" id="usersTab" class="tab-button">
                            ğŸ‘¥ ××©×ª××©×™×
                        </button>
                        <button onclick="switchTab('stats')" id="statsTab" class="tab-button">
                            ğŸ“Š ×“×•×—×•×ª ×•×”×›× ×¡×•×ª
                        </button>
                    </nav>
                </div>

                <!-- Payments Tab -->
                <div id="paymentsContent" class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-1">×¨×©×™××ª ×ª×©×œ×•××™×</h2>
                            <p class="text-gray-500 text-sm">× ×”×œ ×•×”×¦×’ ××ª ×›×œ ×”×ª×©×œ×•××™× ×‘××¢×¨×›×ª</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="deleteOldPayments()" class="btn-action btn-delete">
                                ğŸ—‘ï¸ ××—×§ ×™×©× ×™×
                            </button>
                            <button onclick="refreshData()" class="btn-primary" style="padding: 10px 20px; font-size: 13px;">
                                ğŸ”„ ×¨×¢× ×Ÿ
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-3 mb-6">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-right text-sm font-bold text-gray-700">×ª××¨×™×š</th>
                                    <th class="px-4 py-3 text-right text-sm font-bold text-gray-700">××©×ª××©</th>
                                    <th class="px-4 py-3 text-right text-sm font-bold text-gray-700">××–×”×” ×ª×©×œ×•×</th>
                                    <th class="px-4 py-3 text-right text-sm font-bold text-gray-700">×¡×›×•×</th>
                                    <th class="px-4 py-3 text-right text-sm font-bold text-gray-700">×¡×˜×˜×•×¡</th>
                                    <th class="px-4 py-3 text-right text-sm font-bold text-gray-700">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="usersContent" class="p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-1">×¨×©×™××ª ××©×ª××©×™×</h2>
                            <p class="text-gray-500 text-sm">× ×”×œ ××©×ª××©×™× ×•×× ×•×™×™×</p>
                        </div>
                        <div class="flex gap-3">
                            <select id="userFilter" onchange="filterUsers()" class="px-4 py-2 border-2 border-gray-200 rounded-xl text-sm font-semibold focus:border-amber-500 focus:ring-4 focus:ring-amber-100 focus:outline-none transition-all">
                                <option value="all">ğŸ“Š ×›×œ ×”××©×ª××©×™×</option>
                                <option value="active">âœ… ×¤×¢×™×œ×™×</option>
                                <option value="trial">ğŸ†“ × ×™×¡×™×•×Ÿ</option>
                                <option value="expired">âŒ ×¤×’ ×ª×•×§×£</option>
                            </select>
                            <button onclick="refreshData()" class="btn-primary" style="padding: 10px 20px; font-size: 13px;">
                                ğŸ”„ ×¨×¢× ×Ÿ
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto rounded-xl border border-gray-100">
                        <table class="w-full">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-6 py-4 text-right">××™××™×™×œ</th>
                                    <th class="px-6 py-4 text-right">××™××•×ª</th>
                                    <th class="px-6 py-4 text-right">×”×¦×˜×¨×¤×•×ª</th>
                                    <th class="px-6 py-4 text-right">×¡×˜×˜×•×¡</th>
                                    <th class="px-6 py-4 text-right">×ª×•×§×£ ×¢×“</th>
                                    <th class="px-6 py-4 text-right">×™××™× × ×•×ª×¨×•</th>
                                    <th class="px-6 py-4 text-right">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="divide-y divide-gray-100 bg-white">
                                <tr>
                                    <td colspan="7" class="px-6 py-12 text-center">
                                        <div class="text-5xl mb-3 animate-pulse-slow">â³</div>
                                        <p class="text-gray-500 font-medium">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Stats Tab - NEW -->
                <div id="statsContent" class="p-6 hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-1">ğŸ“Š ×“×•×—×•×ª ×•×”×›× ×¡×•×ª</h2>
                        <p class="text-gray-500 text-sm">××™×“×¢ ×¤×™× × ×¡×™ ×•×“×•×—×•×ª ××¤×•×¨×˜×™×</p>
                    </div>

                    <!-- Revenue Card -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Monthly Revenue -->
                        <div class="stat-card" style="animation: none;">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-gray-500 text-sm font-semibold mb-2 uppercase tracking-wide">×”×›× ×¡×” ×—×•×“×©×™×ª</p>
                                    <p id="monthlyRevenue" class="stat-value" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">â‚ª0</p>
                                    <p class="text-gray-400 text-xs mt-1 font-medium">Monthly Revenue</p>
                                </div>
                                <div class="stat-icon" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.25) 100%);">
                                    <span>ğŸ’°</span>
                                </div>
                            </div>
                        </div>

                        <!-- Annual Revenue -->
                        <div class="stat-card" style="animation: none;">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-gray-500 text-sm font-semibold mb-2 uppercase tracking-wide">×”×›× ×¡×” ×©× ×ª×™×ª (×¦×¤×™)</p>
                                    <p id="annualRevenue" class="stat-value" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">â‚ª0</p>
                                    <p class="text-gray-400 text-xs mt-1 font-medium">Annual Revenue (Estimated)</p>
                                </div>
                                <div class="stat-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.25) 100%);">
                                    <span>ğŸ“ˆ</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Stats -->
                    <div class="card-container p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">×¡×˜×˜×™×¡×˜×™×§×•×ª ××¤×•×¨×˜×•×ª</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Active Subscribers Revenue -->
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-2xl border-2 border-green-200">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="bg-green-500 w-12 h-12 rounded-xl flex items-center justify-center text-white text-2xl">
                                        âœ…
                                    </div>
                                    <div>
                                        <p class="text-gray-600 text-sm font-semibold">×× ×•×™×™× ×¤×¢×™×œ×™×</p>
                                        <p id="activeRevenueCount" class="text-2xl font-bold text-green-700">-</p>
                                    </div>
                                </div>
                                <p class="text-green-600 font-bold text-lg" id="activeRevenue">â‚ª0</p>
                                <p class="text-green-500 text-xs mt-1">×”×›× ×¡×” ×—×•×“×©×™×ª</p>
                            </div>

                            <!-- Trial Users -->
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-2xl border-2 border-blue-200">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="bg-blue-500 w-12 h-12 rounded-xl flex items-center justify-center text-white text-2xl">
                                        ğŸ†“
                                    </div>
                                    <div>
                                        <p class="text-gray-600 text-sm font-semibold">× ×™×¡×™×•×Ÿ ×—×™× ×</p>
                                        <p id="trialCount" class="text-2xl font-bold text-blue-700">-</p>
                                    </div>
                                </div>
                                <p class="text-blue-600 font-bold text-lg">×”×›× ×¡×” ×¤×•×˜× ×¦×™××œ×™×ª</p>
                                <p class="text-blue-500 text-xs mt-1" id="trialPotential">â‚ª0 (×‘×¢×ª×™×“)</p>
                            </div>

                            <!-- Expired Users -->
                            <div class="bg-gradient-to-br from-red-50 to-pink-50 p-6 rounded-2xl border-2 border-red-200">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="bg-red-500 w-12 h-12 rounded-xl flex items-center justify-center text-white text-2xl">
                                        âŒ
                                    </div>
                                    <div>
                                        <p class="text-gray-600 text-sm font-semibold">×¤×’×™ ×ª×•×§×£</p>
                                        <p id="expiredCount" class="text-2xl font-bold text-red-700">-</p>
                                    </div>
                                </div>
                                <p class="text-red-600 font-bold text-lg">×”×¤×¡×“ ×”×›× ×¡×”</p>
                                <p class="text-red-500 text-xs mt-1" id="expiredLoss">â‚ª0 (×—×•×“×©×™)</p>
                            </div>
                        </div>

                        <!-- Additional Info -->
                        <div class="mt-6 p-4 bg-amber-50 border-2 border-amber-200 rounded-xl">
                            <p class="text-amber-800 font-bold mb-2">ğŸ’¡ ××™×“×¢ ×—×©×•×‘</p>
                            <ul class="text-amber-700 text-sm space-y-1">
                                <li>â€¢ ××—×™×¨ ×× ×•×™: â‚ª200 ×œ×—×•×“×©</li>
                                <li>â€¢ ×ª×§×•×¤×ª × ×™×¡×™×•×Ÿ: 30 ×™×•×</li>
                                <li>â€¢ ×”×›× ×¡×” ×©× ×ª×™×ª = ×× ×•×™×™× ×¤×¢×™×œ×™× Ã— 200 Ã— 12</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
       const firebaseConfig = {
            apiKey: "AIzaSyCdSRfJCoU6xwDych3l_3K_hBZBHOi9jVg",
            authDomain: "garage-17263.firebaseapp.com",
            projectId: "garage-17263",
            storageBucket: "garage-17263.firebasestorage.app",
            messagingSenderId: "332265903935",
            appId: "1:332265903935:web:237c0787a161fd36a7a58a",
            measurementId: "G-KLLCPECCDQ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Admin emails - Only these emails can access admin panel
        const ADMIN_EMAILS = [
            "admin@drvn.com",
            "h-26-7@hotmail.com"
        ];

        let allUsers = [];
        let allPayments = [];
        let currentAdminUser = null;
        
        // Version Check
        console.log('%cğŸš— DRVN Admin Dashboard v3.2', 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; font-size: 16px; font-weight: bold; border-radius: 8px;');
        console.log('%câœ… Real-time Updates Active', 'color: #10b981; font-weight: bold;');
        console.log('%cğŸ”” Notifications System Ready', 'color: #3b82f6; font-weight: bold;');
        console.log('%cTo test notifications: testNotifications()', 'color: #f59e0b; font-style: italic;');

        // Check if user is already logged in
        auth.onAuthStateChanged(async (user) => {
            if (user && ADMIN_EMAILS.includes(user.email)) {
                currentAdminUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                loadDashboardData();
            }
        });

        // Admin Login
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!ADMIN_EMAILS.includes(email)) {
                errorDiv.textContent = 'âŒ ××™×Ÿ ×œ×š ×”×¨×©××•×ª × ×™×”×•×œ! (Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±Ø©)';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                currentAdminUser = auth.currentUser;
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                
                loadDashboardData();
            } catch (error) {
                let errorMessage = 'âŒ ×©×’×™××”: ';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage += '×”××©×ª××© ×œ× ×§×™×™× ×‘××¢×¨×›×ª';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage += '×¡×™×¡××” ×©×’×•×™×”';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += '××™××™×™×œ ×œ× ×ª×§×™×Ÿ';
                } else {
                    errorMessage += error.message;
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.classList.remove('hidden');
            }
        }

        // Logout
        async function logout() {
            await auth.signOut();
            location.reload();
        }

        // Load Dashboard Data
        async function loadDashboardData() {
            if (currentAdminUser) {
                document.getElementById('adminEmailDisplay').textContent = `ğŸ‘¤ ${currentAdminUser.email}`;
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± updateStats
            await Promise.all([
                loadPayments(),
                loadUsers()
            ]);
        }

        // Update Statistics (ÙŠØ¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©)
        function updateStats() {
            try {
                // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                const totalUsers = allUsers.length;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù†ÙˆÙŠÙŠÙ† Ø§Ù„ÙØ¹Ø§Ù„ÙŠÙ†
                let activeCount = 0;
                let monthlyRevenue = 0;
                
                allUsers.forEach(user => {
                    if (user.subscriptionStatus === 'active' && user.subscriptionEndDate && user.subscriptionEndDate.toDate) {
                        const endDate = user.subscriptionEndDate.toDate();
                        if (endDate > new Date()) {
                            activeCount++;
                            monthlyRevenue += 200;
                        }
                    }
                });
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ´Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¸Ø±Ø© Ù…Ù† allPayments
                const pendingCount = allPayments.filter(p => p.status === 'pending').length;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('activeSubscriptions').textContent = activeCount;
                document.getElementById('pendingPayments').textContent = pendingCount;
                document.getElementById('monthlyRevenue').textContent = `â‚ª${monthlyRevenue.toLocaleString()}`;
                
                console.log('ğŸ“Š Stats updated:', { totalUsers, activeCount, pendingCount, monthlyRevenue });
                
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Load Payments with Real-time Updates
        async function loadPayments() {
            try {
                // â­ Ø§Ø³ØªØ®Ø¯Ø§Ù… Real-time listener - ÙŠÙØ­Ø¯Ù‘Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ±!
                db.collection('payments')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .onSnapshot(snapshot => {
                        allPayments = [];
                        snapshot.forEach(doc => {
                            allPayments.push({ id: doc.id, ...doc.data() });
                        });
                        
                        console.log('âœ… Payments updated:', allPayments.length);
                        displayPayments(allPayments);
                        
                        // â­ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                        updateStats();
                    }, error => {
                        console.error('Error loading payments:', error);
                        document.getElementById('paymentsTableBody').innerHTML = `
                            <tr>
                                <td colspan="6" class="px-4 py-8 text-center text-red-500">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</td>
                            </tr>
                        `;
                    });
            } catch (error) {
                console.error('Error setting up payments listener:', error);
                document.getElementById('paymentsTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-red-500">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</td>
                    </tr>
                `;
            }
        }

        // Display Payments
        function displayPayments(payments) {
            const tbody = document.getElementById('paymentsTableBody');
            
            if (payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="text-5xl mb-3">ğŸ“­</div>
                            <p class="text-gray-500 font-medium">××™×Ÿ ×ª×©×œ×•××™× ×œ×”×¦×’×”</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = payments.map(payment => {
                const date = payment.createdAt && payment.createdAt.toDate ? 
                    new Date(payment.createdAt.toDate()).toLocaleDateString('he-IL') : 'N/A';
                const statusBadge = payment.status === 'pending' 
                    ? '<span class="badge badge-pending">â³ ×××ª×™×Ÿ</span>'
                    : payment.status === 'confirmed'
                    ? '<span class="badge badge-confirmed">âœ“ ××•×©×¨</span>'
                    : '<span class="badge badge-active">âœ… ×¤×¢×™×œ</span>';
                
                const actions = payment.status === 'pending' || payment.status === 'confirmed'
                    ? `<div class="flex gap-2">
                        <button onclick="activateSubscription('${payment.userId}', '${payment.id}')" 
                                class="btn-action btn-extend" style="padding: 6px 14px; font-size: 12px;">
                            âœ“ ××©×¨
                        </button>
                        <button onclick="deletePayment('${payment.id}')" 
                                class="btn-action btn-delete" style="padding: 6px 14px; font-size: 12px;">
                            ğŸ—‘ï¸ ××—×§
                        </button>
                       </div>`
                    : `<div class="flex gap-2 items-center">
                        <span class="text-gray-400 text-sm font-medium">âœ… ×¤×¢×™×œ</span>
                        <button onclick="deletePayment('${payment.id}')" 
                                class="btn-action btn-delete" style="padding: 4px 10px; font-size: 11px;">
                            ğŸ—‘ï¸
                        </button>
                       </div>`;
                
                return `
                    <tr class="payment-row bg-white">
                        <td class="px-6 py-4 text-sm font-medium text-gray-700">${date}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${payment.userEmail || payment.userId || 'N/A'}</td>
                        <td class="px-6 py-4 text-xs font-mono text-gray-500">${payment.id.substring(0, 12)}...</td>
                        <td class="px-6 py-4 text-sm font-bold text-gray-800">â‚ª${payment.amount || '200'}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4">${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        // Delete Single Payment
        async function deletePayment(paymentId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×ª×©×œ×•× ×–×”?\n\nâš ï¸ ×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!')) return;
            
            try {
                await db.collection('payments').doc(paymentId).delete();
                showNotification('success', '×”×ª×©×œ×•× × ××—×§!', '×”×ª×©×œ×•× ×”×•×¡×¨ ×‘×”×¦×œ×—×” ××”××¢×¨×›×ª');
                // ×œ× ×¦×¨×™×š refreshData - Real-time listener ×™×¢×“×›×Ÿ ××•×˜×•××˜×™×ª!
            } catch (error) {
                console.error('Error deleting payment:', error);
                showNotification('error', '×©×’×™××” ×‘××—×™×§×”', error.message);
            }
        }

        // Delete Old Payments (older than 60 days)
        async function deleteOldPayments() {
            const daysAgo = prompt('××—×§ ×ª×©×œ×•××™× ×™×©× ×™× ××œ×¤× ×™ ×›××” ×™××™×?\n\n×”××œ×¥: 60 ×™××™×', '60');
            if (!daysAgo) return;
            
            const days = parseInt(daysAgo);
            if (isNaN(days) || days <= 0) {
                alert('âŒ ××¡×¤×¨ ×™××™× ×œ× ×ª×§×™×Ÿ');
                return;
            }
            
            if (!confirm(`âš ï¸ ×”×× ××ª×” ×‘×˜×•×—?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”×ª×©×œ×•××™× ××œ×¤× ×™ ${days} ×™××™×.\n\n×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`)) return;
            
            try {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                
                const snapshot = await db.collection('payments')
                    .where('createdAt', '<', firebase.firestore.Timestamp.fromDate(cutoffDate))
                    .get();
                
                if (snapshot.empty) {
                    alert('â„¹ï¸ ×œ× × ××¦××• ×ª×©×œ×•××™× ×™×©× ×™× ×œ××—×™×§×”');
                    return;
                }
                
                const batch = db.batch();
                let count = 0;
                
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                    count++;
                });
                
                await batch.commit();
                
                alert(`âœ… × ××—×§×• ×‘×”×¦×œ×—×” ${count} ×ª×©×œ×•××™× ×™×©× ×™×!`);
                refreshData();
            } catch (error) {
                console.error('Error deleting old payments:', error);
                alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×ª×©×œ×•××™×: ' + error.message);
            }
        }

        // Load Users
        async function loadUsers() {
            try {
                // â­ Ø§Ø³ØªØ®Ø¯Ø§Ù… Real-time listener - ÙŠÙØ­Ø¯Ù‘Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ±!
                db.collection('users').onSnapshot(async snapshot => {
                    // â­ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª - Ø­ÙØ¸ ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
                    const usersMap = new Map();
                    const docsToDelete = [];
                    
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const userId = data.userId || data.email || doc.id;
                        
                        if (!usersMap.has(userId)) {
                            // Ø£ÙˆÙ„ Ù…Ø±Ø© Ù†Ø´ÙˆÙ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                            usersMap.set(userId, { id: doc.id, ...data });
                        } else {
                            // Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙƒØ±Ø± - Ù†Ø­Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø«
                            const existing = usersMap.get(userId);
                            const existingDate = existing.createdAt?.toDate() || new Date(0);
                            const newDate = data.createdAt?.toDate() || new Date(0);
                            
                            if (newDate > existingDate) {
                                // Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø£Ø­Ø¯Ø« - Ø§Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                                docsToDelete.push(existing.id);
                                usersMap.set(userId, { id: doc.id, ...data });
                            } else {
                                // Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£Ø­Ø¯Ø« - Ø§Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                                docsToDelete.push(doc.id);
                            }
                        }
                    });
                    
                    // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
                    if (docsToDelete.length > 0) {
                        console.log(`ğŸ§¹ Cleaning ${docsToDelete.length} duplicate users...`);
                        const batch = db.batch();
                        docsToDelete.forEach(docId => {
                            batch.delete(db.collection('users').doc(docId));
                        });
                        await batch.commit();
                        console.log('âœ… Duplicates cleaned!');
                    }
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
                    allUsers = Array.from(usersMap.values());
                    console.log('âœ… Users updated:', allUsers.length);
                    displayUsers(allUsers);
                    
                    // â­ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                    updateStats();
                }, error => {
                    console.error('Error loading users:', error);
                    document.getElementById('usersTableBody').innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-red-500">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error setting up users listener:', error);
                document.getElementById('usersTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-red-500">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</td>
                    </tr>
                `;
            }
        }

        // Display Users
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            // â­ Ù…Ø³Ø­ ØªØ§Ù… Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">××™×Ÿ ××©×ª××©×™× ×œ×”×¦×’×”</td>
                    </tr>
                `;
                return;
            }
            
            // â­ Ø¨Ù†Ø§Ø¡ HTML Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
            const rows = users.map(user => {
                const joinDate = user.createdAt && user.createdAt.toDate ? 
                    new Date(user.createdAt.toDate()).toLocaleDateString('he-IL') : 'N/A';
                const endDate = user.subscriptionEndDate && user.subscriptionEndDate.toDate ? 
                    new Date(user.subscriptionEndDate.toDate()) : null;
                const endDateStr = endDate ? endDate.toLocaleDateString('he-IL') : 'N/A';
                
                let daysLeft = 0;
                let status = 'expired';
                let statusBadge = '<span class="badge badge-expired">âŒ ×¤×’ ×ª×•×§×£</span>';
                
                if (endDate) {
                    daysLeft = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
                    
                    if (user.subscriptionStatus === 'active' && daysLeft > 0) {
                        status = 'active';
                        statusBadge = '<span class="badge badge-active">âœ… ×¤×¢×™×œ</span>';
                    } else if (user.subscriptionStatus === 'trial' && daysLeft > 0) {
                        status = 'trial';
                        statusBadge = '<span class="badge badge-trial">ğŸ†“ × ×™×¡×™×•×Ÿ</span>';
                    }
                }
                
                // â­ Email verification status - ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Firebase Auth Ø£ÙŠØ¶Ø§Ù‹
                const emailVerified = user.emailVerified === true || user.verifiedManually === true;
                const verificationBadge = emailVerified 
                    ? '<span class="badge badge-active">âœ… ×××•××ª</span>'
                    : '<span class="badge badge-pending">âš ï¸ ×œ× ×××•××ª</span>';
                
                // â­ Actions - Ø£Ø²Ø±Ø§Ø± Ù…Ø­Ø³Ù‘Ù†Ø© Ø¨ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ
                const actions = `
                    <div class="flex flex-col gap-2">
                        <div class="flex gap-2">
                            <button onclick="extendSubscription('${user.id}')" class="btn-action btn-extend">
                                â• ×”××¨×š
                            </button>
                            <button onclick="cancelSubscription('${user.id}')" class="btn-action btn-cancel">
                                â¸ï¸ ×‘×˜×œ
                            </button>
                        </div>
                        <div class="flex gap-2">
                            ${!emailVerified ? `
                                <button onclick="resendVerificationAdmin('${user.id}', '${user.email}')" 
                                        class="btn-action btn-verify flex-1">
                                    ğŸ“§ ×××ª
                                </button>
                            ` : ''}
                            <button onclick="deleteAccount('${user.id}', '${user.email}')" 
                                    class="btn-action btn-delete ${emailVerified ? 'w-full' : 'flex-1'}">
                                ğŸ—‘ï¸ ××—×§
                            </button>
                        </div>
                    </div>
                `;
                
                return `
                    <tr class="payment-row bg-white" data-status="${status}" data-user-id="${user.id}">
                        <td class="px-6 py-4 text-sm font-medium text-gray-700">${user.email || user.id || 'N/A'}</td>
                        <td class="px-6 py-4">${verificationBadge}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${joinDate}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${endDateStr}</td>
                        <td class="px-6 py-4 text-sm font-bold ${daysLeft > 0 ? 'text-green-600' : 'text-red-600'}">${daysLeft > 0 ? daysLeft + ' ×™××™×' : '×¤×’ ×ª×•×§×£'}</td>
                        <td class="px-6 py-4">${actions}</td>
                    </tr>
                `;
            }).join('');
            
            // â­ Ø¥Ø¶Ø§ÙØ© HTML Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
            tbody.innerHTML = rows;
        }

        // Filter Users
        function filterUsers() {
            const filter = document.getElementById('userFilter').value;
            
            if (filter === 'all') {
                displayUsers(allUsers);
            } else {
                const filtered = allUsers.filter(user => {
                    const endDate = user.subscriptionEndDate ? new Date(user.subscriptionEndDate.toDate()) : null;
                    const daysLeft = endDate ? Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24)) : 0;
                    
                    if (filter === 'active') {
                        return user.subscriptionStatus === 'active' && daysLeft > 0;
                    } else if (filter === 'trial') {
                        return user.subscriptionStatus === 'trial' && daysLeft > 0;
                    } else if (filter === 'expired') {
                        return daysLeft <= 0;
                    }
                    return true;
                });
                displayUsers(filtered);
            }
        }

        // Activate Subscription
        async function activateSubscription(userId, paymentId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¤×¢×™×œ ××ª ×”×× ×•×™?')) return;
            
            try {
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + 30);
                
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (userDoc.exists) {
                    await db.collection('users').doc(userId).update({
                        subscriptionStatus: 'active',
                        subscriptionEndDate: firebase.firestore.Timestamp.fromDate(endDate),
                        lastPaymentDate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    const paymentDoc = await db.collection('payments').doc(paymentId).get();
                    const paymentData = paymentDoc.data();
                    
                    await db.collection('users').doc(userId).set({
                        userId: userId,
                        email: paymentData.userEmail || '',
                        subscriptionStatus: 'active',
                        subscriptionEndDate: firebase.firestore.Timestamp.fromDate(endDate),
                        lastPaymentDate: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await db.collection('payments').doc(paymentId).update({
                    status: 'active',
                    activatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('success', '×”×× ×•×™ ×”×•×¤×¢×œ!', `××©×ª××©: ${userId} â€¢ ×ª×•×§×£: 30 ×™××™×`);
                refreshData();
            } catch (error) {
                console.error('Error activating subscription:', error);
                showNotification('error', '×©×’×™××” ×‘×”×¤×¢×œ×ª ×”×× ×•×™', error.message);
            }
        }

        // Extend Subscription
        async function extendSubscription(userId) {
            const days = prompt('×›××” ×™××™× ×œ×”×•×¡×™×£?', '30');
            if (!days) return;
            
            const daysNum = parseInt(days);
            if (isNaN(daysNum) || daysNum <= 0) {
                alert('âŒ ××¡×¤×¨ ×™××™× ×œ× ×ª×§×™×Ÿ');
                return;
            }
            
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                const userData = userDoc.data();
                
                let newEndDate;
                if (userData.subscriptionEndDate) {
                    const currentEndDate = userData.subscriptionEndDate.toDate();
                    newEndDate = new Date(currentEndDate);
                    newEndDate.setDate(newEndDate.getDate() + daysNum);
                } else {
                    newEndDate = new Date();
                    newEndDate.setDate(newEndDate.getDate() + daysNum);
                }
                
                await db.collection('users').doc(userId).update({
                    subscriptionStatus: 'active',
                    subscriptionEndDate: firebase.firestore.Timestamp.fromDate(newEndDate)
                });
                
                showNotification('success', '×”×× ×•×™ ×”×•××¨×š!', `× ×•×¡×¤×• ${daysNum} ×™××™× ×œ×× ×•×™`);
                refreshData();
            } catch (error) {
                console.error('Error extending subscription:', error);
                showNotification('error', '×©×’×™××” ×‘×”××¨×›×ª ×”×× ×•×™', error.message);
            }
        }

        // Cancel Subscription
        async function cancelSubscription(userId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×˜×œ ××ª ×”×× ×•×™?')) return;
            
            try {
                await db.collection('users').doc(userId).update({
                    subscriptionStatus: 'expired',
                    subscriptionEndDate: firebase.firestore.Timestamp.fromDate(new Date())
                });
                
                alert('âœ… ×”×× ×•×™ ×‘×•×˜×œ ×‘×”×¦×œ×—×”!');
                refreshData();
            } catch (error) {
                console.error('Error canceling subscription:', error);
                alert('âŒ ×©×’×™××” ×‘×‘×™×˜×•×œ ×”×× ×•×™: ' + error.message);
            }
        }

        // Delete Account Permanently
        async function deleteAccount(userId, userEmail) {
            const confirmText = `âš ï¸ ××–×”×¨×” ×—××•×¨×”! ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×”×—×©×‘×•×Ÿ ×œ×¦××™×ª×•×ª!\n\n×”×—×©×‘×•×Ÿ: ${userEmail}\n\n×”××—×™×§×” ×›×•×œ×œ×ª:\nâ€¢ ×›×œ × ×ª×•× ×™ ×”××©×ª××©\nâ€¢ ×›×œ ×”×ª×©×œ×•××™×\nâ€¢ ×›×œ ×”×”×™×¡×˜×•×¨×™×”\n\nâŒ ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”!\n\n×”×× ××ª×” ×‘×˜×•×— ×œ×—×œ×•×˜×™×Ÿ?`;
            
            if (!confirm(confirmText)) return;
            
            // Second confirmation for safety
            const finalConfirm = confirm('â— ××™×©×•×¨ ××—×¨×•×Ÿ!\n\n×–×•×”×™ ×”×–×“×× ×•×ª ××—×¨×•× ×” ×œ×‘×˜×œ.\n\n×”×× ×œ×”××©×™×š ×‘××—×™×§×” ×¡×•×¤×™×ª?');
            if (!finalConfirm) return;
            
            try {
                // Delete user document
                await db.collection('users').doc(userId).delete();
                
                // Delete all related payments
                const paymentsSnapshot = await db.collection('payments')
                    .where('userId', '==', userId)
                    .get();
                
                if (!paymentsSnapshot.empty) {
                    const batch = db.batch();
                    paymentsSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }
                
                showNotification('success', '×”×—×©×‘×•×Ÿ × ××—×§!', `${userEmail} â€¢ ${paymentsSnapshot.size} ×ª×©×œ×•××™× × ××—×§×•`);
                refreshData();
            } catch (error) {
                console.error('Error deleting account:', error);
                showNotification('error', '×©×’×™××” ×‘××—×™×§×ª ×”×—×©×‘×•×Ÿ', error.message);
            }
        }

        // Resend Verification Email (Admin)
        async function resendVerificationAdmin(userId, userEmail) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×©×œ×•×— ××™×™×œ ××™××•×ª ×œ-${userEmail}?`)) return;
            
            try {
                console.log('ğŸ“§ Admin sending verification email to:', userEmail);
                
                // Note: Firebase doesn't allow sending verification emails for other users directly
                // We need to use Firebase Admin SDK or Cloud Functions for this
                // As a workaround, we'll update the user's emailVerified status manually
                // and notify them to check their email
                
                // Option 1: Manual verification (temporary solution)
                const confirmManual = confirm(`âš ï¸ ×”×¢×¨×”: Firebase ×œ× ×××¤×©×¨ ×œ×©×œ×•×— ××™×™×œ×™× ×‘×©× ××©×ª××©×™× ××—×¨×™×.\n\n×”×× ×ª×¨×¦×” ×œ×¡××Ÿ ××ª ×”××©×ª××© ×›×××•××ª ×™×“× ×™×ª?`);
                
                if (confirmManual) {
                    await db.collection('users').doc(userId).update({
                        emailVerified: true,
                        verifiedManually: true,
                        verifiedBy: 'admin',
                        verifiedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('âœ… ×”××©×ª××© ×¡×•××Ÿ ×›×××•××ª ×‘×”×¦×œ×—×”!\n\n×”××©×ª××© ×™×›×•×œ ×›×¢×ª ×œ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª.');
                    refreshData();
                } else {
                    alert('ğŸ’¡ ×¤×ª×¨×•×Ÿ:\n\n1. ×‘×§×© ××”×œ×§×•×— ×œ×”×ª×—×‘×¨ ×©×•×‘ ×‘×“×£ ×”×”×ª×—×‘×¨×•×ª\n2. ×”×•× ×™×§×‘×œ ××¤×©×¨×•×ª ×œ×©×œ×•×— ××™×™×œ ××™××•×ª ××—×“×©\n3. ××• ×ª×•×›×œ ×œ×¡××Ÿ ××•×ª×• ×›×××•××ª ×™×“× ×™×ª');
                }
                
            } catch (error) {
                console.error('Error handling verification:', error);
                alert('âŒ ×©×’×™××”: ' + error.message);
            }
        }

        // Switch Tab
        // Switch Tab
        function switchTab(tab) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ tabs
            document.getElementById('paymentsTab').className = 'tab-button';
            document.getElementById('usersTab').className = 'tab-button';
            document.getElementById('statsTab').className = 'tab-button';
            
            document.getElementById('paymentsContent').classList.add('hidden');
            document.getElementById('usersContent').classList.add('hidden');
            document.getElementById('statsContent').classList.add('hidden');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù€ tab Ø§Ù„Ù…Ø®ØªØ§Ø±
            if (tab === 'payments') {
                document.getElementById('paymentsTab').className = 'tab-button active';
                document.getElementById('paymentsContent').classList.remove('hidden');
            } else if (tab === 'users') {
                document.getElementById('usersTab').className = 'tab-button active';
                document.getElementById('usersContent').classList.remove('hidden');
            } else if (tab === 'stats') {
                document.getElementById('statsTab').className = 'tab-button active';
                document.getElementById('statsContent').classList.remove('hidden');
                updateDetailedStats(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØµÙ„Ø©
            }
        }

        // Update Detailed Stats
        function updateDetailedStats() {
            const activeUsers = allUsers.filter(u => {
                const endDate = u.subscriptionEndDate?.toDate();
                return u.subscriptionStatus === 'active' && endDate && endDate > new Date();
            });
            
            const trialUsers = allUsers.filter(u => {
                const endDate = u.subscriptionEndDate?.toDate();
                return u.subscriptionStatus === 'trial' && endDate && endDate > new Date();
            });
            
            const expiredUsers = allUsers.filter(u => {
                const endDate = u.subscriptionEndDate?.toDate();
                return !endDate || endDate <= new Date();
            });
            
            const monthlyRevenue = activeUsers.length * 200;
            const annualRevenue = monthlyRevenue * 12;
            const trialPotential = trialUsers.length * 200;
            const expiredLoss = expiredUsers.length * 200;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
            document.getElementById('monthlyRevenue').textContent = 'â‚ª' + monthlyRevenue.toLocaleString();
            document.getElementById('annualRevenue').textContent = 'â‚ª' + annualRevenue.toLocaleString();
            
            document.getElementById('activeRevenueCount').textContent = activeUsers.length;
            document.getElementById('activeRevenue').textContent = 'â‚ª' + monthlyRevenue.toLocaleString();
            
            document.getElementById('trialCount').textContent = trialUsers.length;
            document.getElementById('trialPotential').textContent = 'â‚ª' + trialPotential.toLocaleString() + ' (×‘×¢×ª×™×“)';
            
            document.getElementById('expiredCount').textContent = expiredUsers.length;
            document.getElementById('expiredLoss').textContent = 'â‚ª' + expiredLoss.toLocaleString() + ' (×—×•×“×©×™)';
        }

        // Refresh Data
        function refreshData() {
            loadDashboardData();
        }

        // ==================== Dark Mode ====================
        function toggleDarkMode() {
            const body = document.body;
            const icon = document.getElementById('darkModeIcon');
            
            body.classList.toggle('dark-mode');
            
            if (body.classList.contains('dark-mode')) {
                icon.textContent = 'â˜€ï¸';
                localStorage.setItem('darkMode', 'enabled');
                showNotification('success', '××¦×‘ ×›×”×”', '××¦×‘ ×›×”×” ×”×•×¤×¢×œ ×‘×”×¦×œ×—×”');
            } else {
                icon.textContent = 'ğŸŒ™';
                localStorage.setItem('darkMode', 'disabled');
                showNotification('info', '××¦×‘ ×‘×”×™×¨', '××¦×‘ ×‘×”×™×¨ ×”×•×¤×¢×œ ×‘×”×¦×œ×—×”');
            }
        }

        // Load Dark Mode preference
        function loadDarkMode() {
            const darkMode = localStorage.getItem('darkMode');
            const icon = document.getElementById('darkModeIcon');
            
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                if (icon) icon.textContent = 'â˜€ï¸';
            }
        }

        // ==================== Notifications System ====================
        function showNotification(type, title, message) {
            const container = document.getElementById('notificationsContainer');
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">${icons[type]}</div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-100px)';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Test Notifications (ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹)
        function testNotifications() {
            showNotification('success', '×”×¦×œ×—×”!', '×”×¤×¢×•×œ×” ×‘×•×¦×¢×” ×‘×”×¦×œ×—×”');
            setTimeout(() => {
                showNotification('error', '×©×’×™××”!', '××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×‘×™×¦×•×¢ ×”×¤×¢×•×œ×”');
            }, 1000);
            setTimeout(() => {
                showNotification('warning', '××–×”×¨×”!', '×™×© ×œ×©×™× ×œ×‘ ×œ×¤×¢×•×œ×” ×–×•');
            }, 2000);
            setTimeout(() => {
                showNotification('info', '××™×“×¢', '×–×”×• ×”×•×“×¢×ª ××™×“×¢ ×—×©×•×‘×”');
            }, 3000);
        }

        // Override alert() to use notifications (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        const originalAlert = window.alert;
        window.customAlert = function(message) {
            if (message.includes('âœ…') || message.includes('×”×¦×œ×—×”')) {
                const title = message.split('\n')[0].replace('âœ…', '').trim();
                const msg = message.split('\n').slice(1).join(' ').substring(0, 100);
                showNotification('success', title || '×”×¦×œ×—×”', msg || message);
            } else if (message.includes('âŒ') || message.includes('×©×’×™××”')) {
                const title = message.split('\n')[0].replace('âŒ', '').trim();
                const msg = message.split('\n').slice(1).join(' ').substring(0, 100);
                showNotification('error', title || '×©×’×™××”', msg || message);
            } else {
                showNotification('info', '×”×•×“×¢×”', message.substring(0, 100));
            }
        };

        // Handle Enter key in login form
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('adminPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    adminLogin();
                }
            });
            
            // Load dark mode preference
            loadDarkMode();
            
            // Test button (add this to HTML if you want: <button onclick="testNotifications()">Test</button>)
            console.log('ğŸ’¡ To test notifications, run: testNotifications()');
        });
    </script>
</body>
</html>